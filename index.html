<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Anemonefish Mutualism Analysis Results</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Anemonefish Mutualism Analysis Results</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="drivers-of-host-sea-anemone-and-anemonefish-richness" class="level1">
<h1>Drivers of Host Sea Anemone and Anemonefish Richness</h1>
<p>This section replicates the initial data loading and processing steps from the desert ant paper’s results section, adapted for the anemonefish-anemone mutualism. We load the current predicted suitability rasters for host sea anemones and anemonefish (environmental-only models), calculate community richness, and crop them to the Indo-Pacific study area.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using pacman for streamlined package management</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pacman"</span>)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(here, dplyr, terra, sf, stringr, ggplot2, readr, tools)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load project configuration</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure your working directory is the root of your sdm_anemonefish project</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(<span class="st">"scripts/config.R"</span>)) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(<span class="st">"scripts/config.R"</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">file.exists</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"scripts/config.R"</span>))) {</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">source</span>(here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"scripts/config.R"</span>))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"FATAL: Configuration file 'scripts/config.R' not found. Please set your working directory to the project root."</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Configuration loaded and bundled into 'config' list.
Base directory: /Users/chrisrauch/anemonefish_post_analysis 
Intermediate SDM Output Dir: /Users/chrisrauch/anemonefish_post_analysis/data/sdm_output_intermediate 
Intermediate Models Dir: /Users/chrisrauch/anemonefish_post_analysis/data/sdm_output_intermediate/models 
Intermediate Results Dir: /Users/chrisrauch/anemonefish_post_analysis/data/sdm_output_intermediate/results 
Target Prediction Base: /Users/chrisrauch/anemonefish_post_analysis/data/output/predictions 
Target Results Base: /Users/chrisrauch/anemonefish_post_analysis/predictions 
Logging to file: /Users/chrisrauch/anemonefish_post_analysis/data/sdm_output_intermediate/logs_and_analysis/sdm_run_20250604_231756.log (Level: INFO Append: TRUE )
Logging to console: TRUE (Level: INFO )
Parallel execution: TRUE with 7 cores.
Using predictors: PCA </code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"config"</span>)) <span class="fu">stop</span>(<span class="st">"FATAL: 'config' list not found after sourcing config.R"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function for constructing prediction filenames (already in your sdm_modeling_helpers.R)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure this helper is sourced or defined if not running the full pipeline before this</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="fu">file.path</span>(config<span class="sc">$</span>helpers_dir, <span class="st">"sdm_modeling_helpers.R"</span>)) <span class="co"># If needed</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create Essential Output Directories ---</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># This assumes config$base_dir is correctly defined in your config.R as the project root</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># and you want to create directories relative to that.</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Directory for general analysis outputs (like CSV summaries)</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>analysis_output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"outputs_for_analysis"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(analysis_output_dir)) {</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(analysis_output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created directory for analysis outputs at:"</span>, analysis_output_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Directory for figures</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>figure_output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"figure_files"</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(figure_output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created directory for figures at:"</span>, figure_output_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># You can add other commonly used output directories here if needed.</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co"># For example, if you have a specific place for model objects:</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># model_objects_dir &lt;- file.path(config$base_dir, "model_objects")</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># if (!dir.exists(model_objects_dir)) {</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co">#   dir.create(model_objects_dir, recursive = TRUE)</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("Created directory for model objects at:", model_objects_dir, "\n")</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Setup: Essential output directories checked/created. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Setup: Essential output directories checked/created. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Scenario Label Converter (Good to have this defined early) ---</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>scenario_label_converter <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"current"</span>     <span class="ot">=</span> <span class="st">"Current"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp119_2050"</span> <span class="ot">=</span> <span class="st">"SSP1-1.9 (2050)"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp119_2100"</span> <span class="ot">=</span> <span class="st">"SSP1-1.9 (2100)"</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp245_2050"</span> <span class="ot">=</span> <span class="st">"SSP2-4.5 (2050)"</span>, </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp245_2100"</span> <span class="ot">=</span> <span class="st">"SSP2-4.5 (2100)"</span>, </span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp370_2050"</span> <span class="ot">=</span> <span class="st">"SSP3-7.0 (2050)"</span>, </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp370_2100"</span> <span class="ot">=</span> <span class="st">"SSP3-7.0 (2100)"</span>, </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp585_2050"</span> <span class="ot">=</span> <span class="st">"SSP5-8.5 (2050)"</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ssp585_2100"</span> <span class="ot">=</span> <span class="st">"SSP5-8.5 (2100)"</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add any other scenarios your project uses</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Setup: Scenario label converter defined. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Setup: Scenario label converter defined. ---</code></pre>
</div>
</div>
<p>if (!is.null(host_pred_stack_cropped)) {</p>
<p>plot(host_pred_stack_cropped, main = “Individual Host Anemone Suitability (Cropped)”)</p>
<p>}</p>
<p>if (!is.null(fish_pred_stack_cropped)) {</p>
<p>plot(fish_pred_stack_cropped, main = “Individual Anemonefish (Env-Only) Suitability (Cropped)”)</p>
<p>}</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Define Parameters ---</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>current_scenario_name <span class="ot">&lt;-</span> <span class="st">"current"</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine the suffix based on config (assuming this is for env-only models)</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 0. Create figure directory if it doesn't exist ---</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># This uses your config$base_dir to ensure it's relative to your project root</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>figure_output_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"figure_files"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(figure_output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Created directory for figures at:"</span>, figure_output_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Load Host Sea Anemone Data ---</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Loading Host Sea Anemone Predictions (Current Scenario) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Host Sea Anemone Predictions (Current Scenario) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(config<span class="sc">$</span>anemone_species_list_file)) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Anemone species list CSV not found: "</span>, config<span class="sc">$</span>anemone_species_list_file)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>anemone_species_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(config<span class="sc">$</span>anemone_species_list_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>host_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>host_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemone_species_df)) {</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemone_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_prediction_filename</span>(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_name =</span> current_scenario_name,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictor_type_suffix =</span> predictor_suffix, </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">config =</span> config</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    host_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(host_raster_files, pred_file_path)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    host_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>(host_short_names, sp_name_sanitized) </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Host prediction file not found for"</span>, sp_name_sanitized, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>host_pred_stack <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>  host_pred_stack <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(host_raster_files)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(host_pred_stack) <span class="ot">&lt;-</span> host_short_names</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stack), <span class="st">"host anemone prediction rasters.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>  host_richness_sum <span class="ot">&lt;-</span> <span class="fu">sum</span>(host_pred_stack, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(host_richness_sum) <span class="ot">&lt;-</span> <span class="st">"HostAnemoneRichness"</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Calculated host anemone summed richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error: No host anemone prediction rasters found. Cannot proceed with host richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  host_richness_sum <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 9 host anemone prediction rasters.
Calculated host anemone summed richness.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Load Anemonefish (Environmental-Only Models) Data ---</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Loading Anemonefish (Env-Only) Predictions (Current Scenario) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Loading Anemonefish (Env-Only) Predictions (Current Scenario) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(config<span class="sc">$</span>anemonefish_species_list_file)) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Anemonefish species list CSV not found: "</span>, config<span class="sc">$</span>anemonefish_species_list_file)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>anemonefish_species_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(config<span class="sc">$</span>anemonefish_species_list_file, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>fish_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>fish_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemonefish_species_df)) {</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_prediction_filename</span>(</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">scenario_name =</span> current_scenario_name,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">predictor_type_suffix =</span> predictor_suffix, </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">config =</span> config</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    fish_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(fish_raster_files, pred_file_path)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    fish_short_names <span class="ot">&lt;-</span> <span class="fu">c</span>(fish_short_names, sp_name_sanitized)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Anemonefish (env-only) prediction file not found for"</span>, sp_name_sanitized, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: Anemonefish (env-only) prediction file not found for Amphiprion_barberi at /Users/chrisrauch/anemonefish_post_analysis/data/output/predictions/mean_pred_Amphiprion_barberi_pca.tif </code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fish_pred_stack <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  fish_pred_stack <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(fish_raster_files)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(fish_pred_stack) <span class="ot">&lt;-</span> fish_short_names</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stack), <span class="st">"anemonefish (env-only) prediction rasters.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  fish_richness_sum <span class="ot">&lt;-</span> <span class="fu">sum</span>(fish_pred_stack, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(fish_richness_sum) <span class="ot">&lt;-</span> <span class="st">"AnemonefishRichness_EnvOnly"</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Calculated anemonefish (env-only) summed richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error: No anemonefish (env-only) prediction rasters found. Cannot proceed with fish richness.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  fish_richness_sum <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 9 anemonefish (env-only) prediction rasters.
Calculated anemonefish (env-only) summed richness.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Crop to Indo-Pacific Extent (if rasters were successfully loaded) ---</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Cropping Rasters to Indo-Pacific Extent ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Cropping Rasters to Indo-Pacific Extent ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Using Indo-Pacific Bounding Box for cropping:"</span>, </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(config<span class="sc">$</span>indo_pacific_bbox, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_pred_stack)) {</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    host_pred_stack_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">crop</span>(host_pred_stack, ip_extent)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop host_pred_stack:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); host_pred_stack</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { host_pred_stack_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_richness_sum)) {</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    host_richness_sum_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">crop</span>(host_richness_sum, ip_extent)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop host_richness_sum:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); host_richness_sum</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { host_richness_sum_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_pred_stack)) {</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    fish_pred_stack_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">crop</span>(fish_pred_stack, ip_extent)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop fish_pred_stack:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); fish_pred_stack</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { fish_pred_stack_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_richness_sum)) {</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    fish_richness_sum_cropped <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">crop</span>(fish_richness_sum, ip_extent)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Warning: Failed to crop fish_richness_sum:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); fish_richness_sum</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { fish_richness_sum_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> }</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Cropping complete.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Skipping Indo-Pacific cropping based on config.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>  host_pred_stack_cropped <span class="ot">&lt;-</span> host_pred_stack</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>  host_richness_sum_cropped <span class="ot">&lt;-</span> host_richness_sum</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>  fish_pred_stack_cropped <span class="ot">&lt;-</span> fish_pred_stack</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>  fish_richness_sum_cropped <span class="ot">&lt;-</span> fish_richness_sum</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Using Indo-Pacific Bounding Box for cropping: 30, 180, -50, 50 
Cropping complete.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Plot Cropped Richness Maps AND SAVE THEM ---</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Plotting and Saving Cropped Richness Maps ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Plotting and Saving Cropped Richness Maps ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define plot parameters to make them look nicer for saving</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="co"># You might want to adjust col, main titles, etc.</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>plot_params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">rev</span>(<span class="fu">terrain.colors</span>(<span class="dv">255</span>)), <span class="co"># Example color palette</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">plg =</span> <span class="fu">list</span>(<span class="at">loc =</span> <span class="st">"right"</span>, <span class="at">title =</span> <span class="st">"Richness"</span>, <span class="at">cex =</span> <span class="fl">0.8</span>), <span class="co"># Legend parameters</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pax =</span> <span class="fu">list</span>(<span class="at">cex.axis =</span> <span class="fl">0.8</span>) <span class="co"># Axis parameters</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_richness_sum_cropped)) {</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define filename for host richness plot</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  host_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"host_richness_current_cropped.png"</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Open PNG device</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="at">filename =</span> host_plot_filename, <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>, <span class="at">units =</span> <span class="st">"px"</span>, <span class="at">res =</span> <span class="dv">100</span>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot host richness (use the plot_params list)</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(host_richness_sum_cropped, </span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Summed Host Anemone Richness (Current, Cropped)"</span>, </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> plot_params<span class="sc">$</span>col, </span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">plg =</span> plot_params<span class="sc">$</span>plg, </span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">pax =</span> plot_params<span class="sc">$</span>pax)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Close PNG device</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Saved host richness plot to:"</span>, host_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Also display in RMarkdown output if knitting</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(host_richness_sum_cropped, </span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Summed Host Anemone Richness (Current, Cropped)"</span>, </span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> plot_params<span class="sc">$</span>col, </span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">plg =</span> plot_params<span class="sc">$</span>plg, </span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">pax =</span> plot_params<span class="sc">$</span>pax)</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved host richness plot to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/host_richness_current_cropped.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_richness_sum_cropped)) {</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define filename for fish richness plot</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  fish_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"fish_richness_current_env_only_cropped.png"</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Open PNG device</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(<span class="at">filename =</span> fish_plot_filename, <span class="at">width =</span> <span class="dv">800</span>, <span class="at">height =</span> <span class="dv">600</span>, <span class="at">units =</span> <span class="st">"px"</span>, <span class="at">res =</span> <span class="dv">100</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot fish richness (use the plot_params list)</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fish_richness_sum_cropped, </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Summed Anemonefish Richness (Current, Env-Only, Cropped)"</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> plot_params<span class="sc">$</span>col, </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">plg =</span> plot_params<span class="sc">$</span>plg, </span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">pax =</span> plot_params<span class="sc">$</span>pax)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Close PNG device</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Saved anemonefish richness plot to:"</span>, fish_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Also display in RMarkdown output if knitting</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fish_richness_sum_cropped, </span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>       <span class="at">main =</span> <span class="st">"Summed Anemonefish Richness (Current, Env-Only, Cropped)"</span>,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> plot_params<span class="sc">$</span>col, </span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">plg =</span> plot_params<span class="sc">$</span>plg, </span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">pax =</span> plot_params<span class="sc">$</span>pax)</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved anemonefish richness plot to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/fish_richness_current_env_only_cropped.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: Plot cropped individual stacks if needed for visual check</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_pred_stack_cropped)) {</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(host_pred_stack_cropped)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_pred_stack_cropped)) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(fish_pred_stack_cropped)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-and-process-rasters-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- First section of results processing finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- First section of results processing finished. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The objects host_pred_stack_cropped, host_richness_sum_cropped, </span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co"># fish_pred_stack_cropped, and fish_richness_sum_cropped are now available.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="evaluate-models" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-models">Evaluate models</h2>
<p>This section loads the cross-validation (CV) results from the various SDM runs for host sea anemones and different types of anemonefish models (environmental-only, biotic-only, and combined environmental + biotic), focusing on AUC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr) <span class="co"># For map_df</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># For data manipulation</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr) <span class="co"># For read_csv</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Load Host Sea Anemone CV Results ("Plants" equivalent) ---</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine suffix based on config (assuming this matches what was used for 06a)</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>host_predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>host_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemone"</span>, host_predictor_suffix))</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Loading Host Sea Anemone CV results from:"</span>, host_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading Host Sea Anemone CV results from: /Users/chrisrauch/anemonefish_post_analysis/predictions/anemone_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>host_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(host_cv_results_dir,</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>                            <span class="at">pattern =</span> <span class="st">"^CV_Results_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="co"># Files start with CV_Results_</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>                            <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  host_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(host_cv_files, </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x, </span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">filename =</span> <span class="fu">basename</span>(.x)))</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>  host_model_evals <span class="ot">&lt;-</span> host_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(filename) <span class="sc">%&gt;%</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_AUC_test_CV =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># SDMtune output column is AUC_test_CV</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_AUC_test_CV =</span> <span class="fu">sd</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>      <span class="co"># mean_test_tss = mean(test_TSS, na.rm = TRUE), # SDMtune output column is test_TSS</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># sd_test_tss = sd(test_TSS, na.rm = TRUE)</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), <span class="sc">~</span><span class="fu">round</span>(., <span class="dv">3</span>))) </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">First few rows of Host Sea Anemone Model Evaluations (AUC only):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(host_model_evals))</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  host_cv_summary_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>base_dir, <span class="st">"outputs_for_analysis"</span>, <span class="st">"host_anemone_CV_summary_auc_only.csv"</span>)</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">dirname</span>(host_cv_summary_path), <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.csv</span>(host_model_evals, host_cv_summary_path, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Host Sea Anemone CV summary (AUC only) saved to:"</span>, host_cv_summary_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for host sea anemones in"</span>, host_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>  host_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>  host_model_evals <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
First few rows of Host Sea Anemone Model Evaluations (AUC only):
# A tibble: 6 × 3
  filename                                mean_AUC_test_CV sd_AUC_test_CV
  &lt;chr&gt;                                              &lt;dbl&gt;          &lt;dbl&gt;
1 CV_Results_Cryptodendrum_adhaesivum.csv            0.841          0.004
2 CV_Results_Entacmaea_quadricolor.csv               0.76           0.019
3 CV_Results_Heteractis_aurora.csv                   0.707          0.009
4 CV_Results_Macrodactyla_doreensis.csv              0.771          0.024
5 CV_Results_Radianthus_aurora.csv                   0.76           0.017
6 CV_Results_Radianthus_crispa.csv                   0.836          0.013

Host Sea Anemone CV summary (AUC only) saved to: /Users/chrisrauch/anemonefish_post_analysis/outputs_for_analysis/host_anemone_CV_summary_auc_only.csv </code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Load Anemonefish Environmental-Only CV Results ("Ants Climate-Only" equivalent) ---</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>fish_env_predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>fish_env_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemonefish"</span>, fish_env_predictor_suffix))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Loading Anemonefish (Environmental-Only) CV results from:"</span>, fish_env_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Loading Anemonefish (Environmental-Only) CV results from: /Users/chrisrauch/anemonefish_post_analysis/predictions/anemonefish_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>fish_env_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(fish_env_cv_results_dir,</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">pattern =</span> <span class="st">"^CV_Results_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_env_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  fish_env_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_env_cv_files, </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                  <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">filename =</span> <span class="fu">basename</span>(.x)))</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, <span class="fu">nrow</span>(fish_env_cv_data), <span class="st">"rows from"</span>, <span class="fu">length</span>(fish_env_cv_files), <span class="st">"anemonefish (env-only) CV files.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(fish_env_cv_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(filename, AUC_test_CV) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(filename) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>), <span class="at">n=</span><span class="dv">3</span>)) <span class="co"># Show a sample (test_TSS removed for now)</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for anemonefish (env-only) in"</span>, fish_env_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  fish_env_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 220 rows from 11 anemonefish (env-only) CV files.
# A tibble: 3 × 2
# Groups:   filename [3]
  filename                            AUC_test_CV
  &lt;chr&gt;                                     &lt;dbl&gt;
1 CV_Results_Amphiprion_akindynos.csv       0.880
2 CV_Results_Amphiprion_allardi.csv         0.923
3 CV_Results_Amphiprion_bicinctus.csv       0.862</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Load Anemonefish Biotic Model CV Results (Equivalent to "Ant Contrasts") ---</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   3a. Biotic-Only CV Results (from 06c)</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>fish_biotic_only_suffix_config <span class="ot">&lt;-</span> <span class="st">"_biotic_only"</span> </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>fish_biotic_only_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemonefish"</span>, fish_biotic_only_suffix_config))</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Loading Anemonefish (Biotic-Only) CV results from:"</span>, fish_biotic_only_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Loading Anemonefish (Biotic-Only) CV results from: /Users/chrisrauch/anemonefish_post_analysis/predictions/anemonefish_biotic_only </code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>fish_biotic_only_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(fish_biotic_only_cv_results_dir,</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">pattern =</span> <span class="st">"^CV_Results_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_biotic_only_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  anemonefish_biotic_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_biotic_only_cv_files, </span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x,</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">filename =</span> <span class="fu">basename</span>(.x)))</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, <span class="fu">nrow</span>(anemonefish_biotic_cv_data), <span class="st">"rows from"</span>, <span class="fu">length</span>(fish_biotic_only_cv_files), <span class="st">"anemonefish (biotic-only) CV files.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(anemonefish_biotic_cv_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(filename, AUC_test_CV) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(filename) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>), <span class="at">n=</span><span class="dv">3</span>)) <span class="co"># test_TSS removed for now</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for anemonefish (biotic-only) in"</span>, fish_biotic_only_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  anemonefish_biotic_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 246 rows from 11 anemonefish (biotic-only) CV files.
# A tibble: 3 × 2
# Groups:   filename [3]
  filename                            AUC_test_CV
  &lt;chr&gt;                                     &lt;dbl&gt;
1 CV_Results_Amphiprion_akindynos.csv       0.809
2 CV_Results_Amphiprion_allardi.csv         0.958
3 CV_Results_Amphiprion_bicinctus.csv       0.847</code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">#   3b. Combined Env+Biotic CV Results (from 06d)</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>fish_combined_suffix_config <span class="ot">&lt;-</span> <span class="st">"_combined_pca"</span> </span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>fish_combined_cv_results_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_results_base, <span class="fu">paste0</span>(<span class="st">"anemonefish"</span>, fish_combined_suffix_config))</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Loading Anemonefish (Combined Env+Biotic) CV results from:"</span>, fish_combined_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Loading Anemonefish (Combined Env+Biotic) CV results from: /Users/chrisrauch/anemonefish_post_analysis/predictions/anemonefish_combined_pca </code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>fish_combined_cv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(fish_combined_cv_results_dir,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">pattern =</span> <span class="st">"^CV_Results_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_combined_cv_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>  anemonefish_combined_cv_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_combined_cv_files, </span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename_full =</span> .x,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>                          <span class="at">filename =</span> <span class="fu">basename</span>(.x)))</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded"</span>, <span class="fu">nrow</span>(anemonefish_combined_cv_data), <span class="st">"rows from"</span>, <span class="fu">length</span>(fish_combined_cv_files), <span class="st">"anemonefish (combined) CV files.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(anemonefish_combined_cv_data <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(filename, AUC_test_CV) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(filename) <span class="sc">%&gt;%</span> <span class="fu">slice_head</span>(<span class="at">n=</span><span class="dv">1</span>), <span class="at">n=</span><span class="dv">3</span>)) <span class="co"># test_TSS removed for now</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No CV_Results CSV files found for anemonefish (combined) in"</span>, fish_combined_cv_results_dir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>  anemonefish_combined_cv_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 225 rows from 11 anemonefish (combined) CV files.
# A tibble: 3 × 2
# Groups:   filename [3]
  filename                            AUC_test_CV
  &lt;chr&gt;                                     &lt;dbl&gt;
1 CV_Results_Amphiprion_akindynos.csv       0.892
2 CV_Results_Amphiprion_allardi.csv         0.957
3 CV_Results_Amphiprion_bicinctus.csv       0.879</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>host_model_evals</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 3
   filename                                mean_AUC_test_CV sd_AUC_test_CV
   &lt;chr&gt;                                              &lt;dbl&gt;          &lt;dbl&gt;
 1 CV_Results_Cryptodendrum_adhaesivum.csv            0.841          0.004
 2 CV_Results_Entacmaea_quadricolor.csv               0.76           0.019
 3 CV_Results_Heteractis_aurora.csv                   0.707          0.009
 4 CV_Results_Macrodactyla_doreensis.csv              0.771          0.024
 5 CV_Results_Radianthus_aurora.csv                   0.76           0.017
 6 CV_Results_Radianthus_crispa.csv                   0.836          0.013
 7 CV_Results_Radianthus_magnifica.csv                0.777          0.022
 8 CV_Results_Radianthus_malu.csv                   Inf            NaN    
 9 CV_Results_Stichodactyla_gigantea.csv              0.611          0.032
10 CV_Results_Stichodactyla_haddoni.csv               0.723          0.017
11 CV_Results_Stichodactyla_mertensii.csv             0.791          0.018</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The data frames:</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - host_cv_data (and host_model_evals)</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - fish_env_cv_data</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - anemonefish_biotic_cv_data</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - anemonefish_combined_cv_data</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="co"># are now available for the next steps.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="collect-and-prepare-anemonefish-model-evaluation-data" class="level2">
<h2 class="anchored" data-anchor-id="collect-and-prepare-anemonefish-model-evaluation-data">Collect and Prepare Anemonefish Model Evaluation Data</h2>
<p>This section gathers the CV results from the different anemonefish model types (environmental-only, biotic-only, and combined host+environment), cleans the species names, and standardizes a ‘model_type’ column for comparison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># For separate</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># For string manipulation</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Prepare Anemonefish Environmental-Only Data ---</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_env_cv_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_env_cv_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>  fish_env_processed <span class="ot">&lt;-</span> fish_env_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># # Extract species name: Remove "CV_Results_" prefix and ".csv" suffix</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># species = str_remove(filename, "^CV_Results_"),</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>      <span class="co"># species = str_remove(species, "\\.csv$"),</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>      <span class="co"># # Add model type</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">species =</span> SpeciesName,</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> <span class="st">"env_only"</span> </span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species, model_type, AUC_test_CV, filename_full) <span class="co"># Keep relevant columns, filename_full for debugging</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processed anemonefish environmental-only CV data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: fish_env_cv_data is empty or NULL. Cannot process environmental-only models.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a>  fish_env_processed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed anemonefish environmental-only CV data.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Prepare Anemonefish Biotic-Only Data ---</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(anemonefish_biotic_cv_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_biotic_cv_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  fish_biotic_processed <span class="ot">&lt;-</span> anemonefish_biotic_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Extract species name: Remove "CV_Results_" prefix and the known suffix "_biotic_only.csv" (or _biotic_pc4 if that was kept)</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Assuming filenames are like: CV_Results_Amphiprion_clarkii_biotic_only.csv or CV_Results_Amphiprion_clarkii_biotic_pc4.csv</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Adjust the str_remove pattern if your biotic_only filenames have a different consistent suffix</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>      <span class="co"># species = str_remove(filename, "^CV_Results_"),</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>      <span class="co"># species = str_remove(species, paste0(config$model_output_subdir_map[["_biotic_only"]] %||% "_biotic_only", "\\.csv$")), # Use suffix from map or default</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># species = str_remove(species, paste0(config$model_output_subdir_map[["_biotic_pc4"]] %||% "_biotic_pc4", "\\.csv$")), # If _biotic_pc4 was used</span></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">species =</span> SpeciesName,</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> <span class="st">"biotic_only"</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species, model_type, AUC_test_CV, filename_full)</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processed anemonefish biotic-only CV data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: anemonefish_biotic_cv_data is empty or NULL. Cannot process biotic-only models.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  fish_biotic_processed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed anemonefish biotic-only CV data.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Prepare Anemonefish Combined (Host + Env) Data ---</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(anemonefish_combined_cv_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_combined_cv_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  fish_combined_processed <span class="ot">&lt;-</span> anemonefish_combined_cv_data <span class="sc">%&gt;%</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>      <span class="co"># # Extract species name: Remove "CV_Results_" and the known suffix "_combined_pca.csv"</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>      <span class="co"># species = str_remove(filename, "^CV_Results_"),</span></span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>      <span class="co"># species = str_remove(species, paste0(config$model_output_subdir_map[["_combined_pca"]] %||% "_combined_pca", "\\.csv$")), # Use suffix from map or default</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">species =</span> SpeciesName,</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">model_type =</span> <span class="st">"combined_host_env"</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species, model_type, AUC_test_CV, filename_full)</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Processed anemonefish combined (host+env) CV data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: anemonefish_combined_cv_data is empty or NULL. Cannot process combined models.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  fish_combined_processed <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed anemonefish combined (host+env) CV data.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Combine all processed anemonefish model data ---</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use bind_rows which handles NULL data frames gracefully</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>df_fish_comparison <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  fish_env_processed,</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>  fish_biotic_processed,</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  fish_combined_processed</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(df_fish_comparison) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optional: Filter out species that might have been excluded or problematic in the ant paper's example</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For now, we'll keep all successfully processed species.</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># df_fish_comparison &lt;- df_fish_comparison %&gt;%</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   filter(!species %in% c("Problem_Species1", "Problem_Species2"))</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Combined data frame 'df_fish_comparison' created with"</span>, <span class="fu">nrow</span>(df_fish_comparison), <span class="st">"rows.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Summary of model types and counts:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">table</span>(df_fish_comparison<span class="sc">$</span>model_type))</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">First few rows of combined data:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(df_fish_comparison))</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Error: 'df_fish_comparison' is empty. No anemonefish CV data was successfully processed.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Combined data frame 'df_fish_comparison' created with 691 rows.
Summary of model types and counts:

      biotic_only combined_host_env          env_only 
              246               225               220 

First few rows of combined data:
# A tibble: 6 × 4
  species              model_type AUC_test_CV filename_full                     
  &lt;chr&gt;                &lt;chr&gt;            &lt;dbl&gt; &lt;chr&gt;                             
1 Amphiprion_akindynos env_only         0.880 /Users/chrisrauch/anemonefish_pos…
2 Amphiprion_akindynos env_only         0.878 /Users/chrisrauch/anemonefish_pos…
3 Amphiprion_akindynos env_only         0.910 /Users/chrisrauch/anemonefish_pos…
4 Amphiprion_akindynos env_only         0.877 /Users/chrisrauch/anemonefish_pos…
5 Amphiprion_akindynos env_only         0.877 /Users/chrisrauch/anemonefish_pos…
6 Amphiprion_akindynos env_only         0.877 /Users/chrisrauch/anemonefish_pos…</code></pre>
</div>
</div>
</section>
<section id="auc-improvement-by-host-specialization-broadened-specialist-definition" class="level2">
<h2 class="anchored" data-anchor-id="auc-improvement-by-host-specialization-broadened-specialist-definition">AUC Improvement by Host Specialization (Broadened Specialist Definition)</h2>
<p>This section investigates whether the inclusion of host anemone distribution data (in “combined host+environment” models) provides a differential improvement in predictive performance (Test AUC) compared to “environment-only” models for anemonefish species. Species are classified based on their number of documented host anemones from `data/processed_anemonefish_host_associations.csv`: “Specialists” are defined as those associating with 3 or fewer host species, and “Generalists” as those associating with more than 3 host species. We then calculate the AUC improvement for each species and test for significant differences in this improvement between the two specialization groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Section: Compare AUC Improvement for Generalist vs. Specialist Anemonefish</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">#          (Specialist = 3 or fewer hosts; Generalist = &gt;3 hosts)</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># -------------------------------------------------------------------------------------</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Defining Anemonefish Specialization (&lt;=3 hosts = Specialist) from CSV and Calculating AUC Improvement ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Defining Anemonefish Specialization (&lt;=3 hosts = Specialist) from CSV and Calculating AUC Improvement ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure df_fish_comparison is available and has the required columns</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"df_fish_comparison"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(df_fish_comparison) <span class="sc">||</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"species"</span>, <span class="st">"model_type"</span>, <span class="st">"AUC_test_CV"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison))) {</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"df_fish_comparison is not available or is missing required columns. Please ensure previous chunks, especially 'collect-fish-model-data', have run successfully."</span>)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Define anemonefish specialization based on the association CSV ---</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>association_file_path <span class="ot">&lt;-</span> here<span class="sc">::</span><span class="fu">here</span>(<span class="st">"data"</span>, <span class="st">"processed_anemonefish_host_associations.csv"</span>)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(association_file_path)) {</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Anemonefish-host association file not found at: "</span>, association_file_path)</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a>host_associations_df <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(association_file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AnemonefishScientificName =</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, AnemonefishScientificName),</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">AssociatedAnemoneScientificName =</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, AssociatedAnemoneScientificName))</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>anemonefish_host_counts <span class="ot">&lt;-</span> host_associations_df <span class="sc">%&gt;%</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(AnemonefishScientificName) <span class="sc">%&gt;%</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_hosts =</span> <span class="fu">n_distinct</span>(AssociatedAnemoneScientificName), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>anemonefish_specialization_df <span class="ot">&lt;-</span> anemonefish_host_counts <span class="sc">%&gt;%</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">specialization_type =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(n_hosts <span class="sc">&lt;=</span> <span class="dv">3</span>, <span class="st">"Specialist"</span>, <span class="st">"Generalist"</span>),</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span>, <span class="st">"Specialist"</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">species =</span> AnemonefishScientificName)</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anemonefish Specialization (&lt;=3 hosts = Specialist):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Anemonefish Specialization (&lt;=3 hosts = Specialist):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(anemonefish_specialization_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 22 × 3
   species                  n_hosts specialization_type
   &lt;chr&gt;                      &lt;int&gt; &lt;fct&gt;              
 1 Amphiprion_akindynos           6 Generalist         
 2 Amphiprion_allardi             3 Specialist         
 3 Amphiprion_barberi             2 Specialist         
 4 Amphiprion_bicinctus           5 Generalist         
 5 Amphiprion_chrysopterus        6 Generalist         
 6 Amphiprion_clarkii             9 Generalist         
 7 Amphiprion_ephippium           2 Specialist         
 8 Amphiprion_frenatus            1 Specialist         
 9 Amphiprion_fuscocaudatus       1 Specialist         
10 Amphiprion_latezonatus         1 Specialist         
# ℹ 12 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>df_fish_comparison_specialization <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(anemonefish_specialization_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts), <span class="at">by =</span> <span class="st">"species"</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">any</span>(<span class="fu">is.na</span>(df_fish_comparison_specialization<span class="sc">$</span>specialization_type))) {</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  unclassified_species <span class="ot">&lt;-</span> <span class="fu">unique</span>(df_fish_comparison_specialization<span class="sc">$</span>species[<span class="fu">is.na</span>(df_fish_comparison_specialization<span class="sc">$</span>specialization_type)])</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Warning: The following species from df_fish_comparison were not found in the generated specialization list from the CSV and will have NA for specialization_type:</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(unclassified_species, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">These species will be excluded from specialist vs generalist comparisons.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison_specialization <span class="ot">&lt;-</span> df_fish_comparison_specialization <span class="sc">%&gt;%</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(specialization_type))</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(df_fish_comparison_specialization) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No species remaining after attempting to merge specialization type. Check species name consistency between df_fish_comparison and the association list CSV."</span>)</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>auc_summary_per_species_model <span class="ot">&lt;-</span> df_fish_comparison_specialization <span class="sc">%&gt;%</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(model_type <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"combined_host_env"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(species, specialization_type, n_hosts, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_AUC_test_CV_per_model =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>auc_improvement_df <span class="ot">&lt;-</span> auc_summary_per_species_model <span class="sc">%&gt;%</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> model_type, <span class="at">values_from =</span> mean_AUC_test_CV_per_model) <span class="sc">%&gt;%</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(env_only) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(combined_host_env)) <span class="sc">%&gt;%</span></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">AUC_improvement =</span> combined_host_env <span class="sc">-</span> env_only) <span class="sc">%&gt;%</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(AUC_improvement)) <span class="sc">%&gt;%</span></span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(specialization_type, <span class="fu">desc</span>(AUC_improvement))</span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">AUC Improvement (Combined Model - Environment-Only Model) per Species, with Host Count (Specialist &lt;=3 hosts):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
AUC Improvement (Combined Model - Environment-Only Model) per Species, with Host Count (Specialist &lt;=3 hosts):</code></pre>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">nrow</span>(auc_improvement_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">as.data.frame</span>(auc_improvement_df))</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No species had AUC values for both 'env_only' and 'combined_host_env' models after filtering. Cannot calculate AUC improvement.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                   species specialization_type n_hosts combined_host_env
1     Amphiprion_bicinctus          Generalist       5         0.9158294
2     Amphiprion_akindynos          Generalist       6         0.8958067
3   Amphiprion_perideraion          Generalist       4         0.8547000
4       Amphiprion_clarkii          Generalist       9         0.7440700
5      Amphiprion_frenatus          Specialist       1         0.6970583
6     Amphiprion_ocellaris          Specialist       3         0.7730789
7       Amphiprion_allardi          Specialist       3         0.9625667
8      Premnas_biaculeatus          Specialist       1         0.8434333
9       Amphiprion_percula          Specialist       3         0.8019474
10    Amphiprion_melanopus          Specialist       3         0.8796300
11 Amphiprion_sandaracinos          Specialist       2         0.8402350
    env_only AUC_improvement
1  0.8420071     0.073822269
2  0.8914857     0.004320952
3  0.8537100     0.000990000
4  0.7451000    -0.001030000
5  0.6604277     0.036630674
6  0.7453316     0.027747368
7  0.9462222     0.016344444
8  0.8280222     0.015411111
9  0.7881158     0.013831579
10 0.8670950     0.012535000
11 0.8373050     0.002930000</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Statistical Test for Difference in AUC Improvement between Generalist and Specialist (Specialist &lt;=3 hosts) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Statistical Test for Difference in AUC Improvement between Generalist and Specialist (Specialist &lt;=3 hosts) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(auc_improvement_df) <span class="sc">&gt;</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.na</span>(auc_improvement_df<span class="sc">$</span>specialization_type)) <span class="sc">&amp;&amp;</span> </span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">na.omit</span>(auc_improvement_df<span class="sc">$</span>specialization_type))) <span class="sc">==</span> <span class="dv">2</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(auc_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Generalist"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(auc_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Specialist"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  ttest_auc_improvement <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t.test</span>(AUC_improvement <span class="sc">~</span> specialization_type, <span class="at">data =</span> auc_improvement_df)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error in t-test for AUC improvement:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">Attempting Wilcoxon test.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tryCatch</span>({</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">wilcox.test</span>(AUC_improvement <span class="sc">~</span> specialization_type, <span class="at">data =</span> auc_improvement_df)</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e2) {</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error in Wilcoxon test as well:"</span>, e2<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Test for difference in AUC Improvement between Generalist and Specialist Anemonefish (Specialist &lt;=3 hosts):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(ttest_auc_improvement)) <span class="fu">print</span>(ttest_auc_improvement)</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data or distinct groups (Generalist/Specialist with &gt;1 observation each) to perform statistical test on AUC improvement.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Number of Generalists with AUC improvement data:"</span>, <span class="fu">sum</span>(auc_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Generalist"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Number of Specialists with AUC improvement data:"</span>, <span class="fu">sum</span>(auc_improvement_df<span class="sc">$</span>specialization_type <span class="sc">==</span> <span class="st">"Specialist"</span>, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Unique specialization types found in auc_improvement_df:"</span>, <span class="fu">paste</span>(<span class="fu">unique</span>(<span class="fu">na.omit</span>(auc_improvement_df<span class="sc">$</span>specialization_type)), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test for difference in AUC Improvement between Generalist and Specialist Anemonefish (Specialist &lt;=3 hosts):

    Welch Two Sample t-test

data:  AUC_improvement by specialization_type
t = 0.086396, df = 3.3191, p-value = 0.9361
alternative hypothesis: true difference in means between group Generalist and group Specialist is not equal to 0
95 percent confidence interval:
 -0.05450224  0.05771666
sample estimates:
mean in group Generalist mean in group Specialist 
              0.01952581               0.01791860 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Boxplot of AUC Improvement by Specialization Type (Specialist &lt;=3 hosts) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Boxplot of AUC Improvement by Specialization Type (Specialist &lt;=3 hosts) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(auc_improvement_df) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">all</span>(<span class="fu">is.na</span>(auc_improvement_df<span class="sc">$</span>specialization_type)) <span class="sc">&amp;&amp;</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">na.omit</span>(auc_improvement_df<span class="sc">$</span>specialization_type))) <span class="sc">&gt;</span> <span class="dv">0</span>) { </span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  plot_auc_improvement <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(auc_improvement_df, <span class="fu">aes</span>(<span class="at">x =</span> specialization_type, <span class="at">y =</span> AUC_improvement, <span class="at">fill =</span> specialization_type)) <span class="sc">+</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">width=</span><span class="fl">0.6</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.15</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">size=</span><span class="fl">2.5</span>) <span class="sc">+</span> </span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">4</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.6</span>)) <span class="sc">+</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"AUC Improvement by Host Specialization"</span>,</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">subtitle =</span> <span class="st">"Comparing Combined (Host+Env) vs. Environment-Only Models"</span>, <span class="co"># Adjusted subtitle to be more general</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Anemonefish Specialization Type"</span>, </span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="fu">expression</span>(Delta <span class="sc">*</span> <span class="st">" AUC (Combined - Env-Only)"</span>) <span class="co"># Adjusted Y-axis label</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"cornflowerblue"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>),</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>                      <span class="at">name =</span> <span class="st">"Specialization Type"</span>,</span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>                      <span class="at">na.translate =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> <span class="co"># Prevent NA from showing in legend if any</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">11</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>())</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print plot to RMarkdown output</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_auc_improvement)</span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Save the plot ---</span></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure figure_output_dir is defined (should be from setup chunk)</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>    improvement_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"auc_improvement_by_specialization.png"</span>)</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> improvement_plot_filename, </span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_auc_improvement, </span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Adjust width, height, dpi as needed</span></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved AUC improvement by specialization plot to:"</span>, improvement_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. AUC improvement plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- End Save the plot ---</span></span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No data to plot for AUC improvement after processing (e.g., all species might be unclassified or only one type present).</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/auc-improvement-specialization-broadened-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved AUC improvement by specialization plot to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/auc_improvement_by_specialization.png </code></pre>
</div>
</div>
</section>
<section id="compare-anemonefish-model-performance" class="level2">
<h2 class="anchored" data-anchor-id="compare-anemonefish-model-performance">Compare anemonefish model performance</h2>
<p>This section statistically compares the performance (test AUC) of the different anemonefish model types (environmental-only, biotic-only, combined host+environment) using a linear mixed model. It also visualizes these comparisons.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="co"># library(performance) # Optional, for model_performance() if needed later</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure dplyr, stringr, knitr are loaded if you use them later in the chunk for the summary table</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="co"># pacman::p_load(dplyr, stringr, knitr) # Or ensure they are loaded in setup</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(df_fish_comparison) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="st">"AUC_test_CV"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison)) {</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure model_type is a factor for the GLMM</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This assumes your df_fish_comparison$model_type has values like "env_only", "biotic_only", "combined_host_env"</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># OR if you renamed them in a previous step to "env", "host_env", "host_only", adjust levels accordingly.</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For consistency with the ant paper structure and direct comparison to env_only:</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison<span class="sc">$</span>model_type <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_fish_comparison<span class="sc">$</span>model_type, </span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"combined_host_env"</span>, <span class="st">"biotic_only"</span>))</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># Reference: env_only</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># Second Coeff: combined_host_env vs env_only</span></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># Third Coeff: biotic_only vs env_only</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Statistical Comparison using GLMM ---</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Fitting GLMM to compare AUC_test_CV across model types ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>  m1_fish_auc <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">glmmTMB</span>(AUC_test_CV <span class="sc">~</span> model_type <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>species), <span class="at">data =</span> df_fish_comparison)</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error fitting GLMM for AUC:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(m1_fish_auc)) {</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Summary of GLMM for AUC_test_CV:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">summary</span>(m1_fish_auc))</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: Check model performance diagnostics if library(performance) is loaded</span></span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cat("\nGLMM Performance Metrics (AUC model):\n")</span></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># print(performance::model_performance(m1_fish_auc))</span></span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Optional: Plot residuals</span></span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot(resid(m1_fish_auc), main = "Residuals of GLMM for AUC") </span></span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Visualization ---</span></span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating boxplot of AUC_test_CV by model type ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Basic boxplot comparing model types (This is plot_auc_comparison)</span></span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure factor levels here match what you want for display order</span></span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison_for_overall_plot <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model_type_display =</span> <span class="fu">factor</span>(model_type,</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"biotic_only"</span>, <span class="st">"combined_host_env"</span>), <span class="co"># Order for plot x-axis</span></span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a>                                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span>, <span class="st">"Biotic (Host) Only"</span>, <span class="st">"Combined (Host+Env)"</span>))) <span class="co"># Labels for plot legend</span></span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a>  plot_auc_comparison <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_fish_comparison_for_overall_plot, <span class="fu">aes</span>(<span class="at">x =</span> model_type_display, <span class="at">y =</span> AUC_test_CV, <span class="at">fill =</span> model_type_display)) <span class="sc">+</span></span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">18</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span> <span class="co"># Removed position_dodge as fill handles separation</span></span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish Model Performance Comparison"</span>,</span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Model Type"</span>,</span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Test AUC (Predictive Accuracy)"</span></span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-59"><a href="#cb77-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb77-60"><a href="#cb77-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"Biotic (Host) Only"</span> <span class="ot">=</span> <span class="st">"skyblue"</span>, <span class="st">"Combined (Host+Env)"</span> <span class="ot">=</span> <span class="st">"salmon"</span>),</span>
<span id="cb77-61"><a href="#cb77-61" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Model Type"</span></span>
<span id="cb77-62"><a href="#cb77-62" aria-hidden="true" tabindex="-1"></a>      <span class="co"># labels argument in scale_fill_manual can be omitted if factor labels are already set</span></span>
<span id="cb77-63"><a href="#cb77-63" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-64"><a href="#cb77-64" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb77-65"><a href="#cb77-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb77-66"><a href="#cb77-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb77-67"><a href="#cb77-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb77-68"><a href="#cb77-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb77-69"><a href="#cb77-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>) </span>
<span id="cb77-70"><a href="#cb77-70" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb77-71"><a href="#cb77-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-72"><a href="#cb77-72" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print plot to RMarkdown output</span></span>
<span id="cb77-73"><a href="#cb77-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_auc_comparison)</span>
<span id="cb77-74"><a href="#cb77-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-75"><a href="#cb77-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # --- ADD THIS SECTION TO SAVE plot_auc_comparison ---</span></span>
<span id="cb77-76"><a href="#cb77-76" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Ensure figure_output_dir is defined (should be from setup chunk)</span></span>
<span id="cb77-77"><a href="#cb77-77" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if (exists("figure_output_dir") &amp;&amp; dir.exists(figure_output_dir)) {</span></span>
<span id="cb77-78"><a href="#cb77-78" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   overall_comparison_plot_filename &lt;- file.path(figure_output_dir, "anemonefish_model_auc_comparison_overall.png")</span></span>
<span id="cb77-79"><a href="#cb77-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   ggsave(filename = overall_comparison_plot_filename, </span></span>
<span id="cb77-80"><a href="#cb77-80" aria-hidden="true" tabindex="-1"></a>  <span class="co">#          plot = plot_auc_comparison, </span></span>
<span id="cb77-81"><a href="#cb77-81" aria-hidden="true" tabindex="-1"></a>  <span class="co">#          width = 8, height = 6, units = "in", dpi = 300) # Adjust dimensions/dpi as needed</span></span>
<span id="cb77-82"><a href="#cb77-82" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cat("Saved overall model AUC comparison plot to:", overall_comparison_plot_filename, "\n")</span></span>
<span id="cb77-83"><a href="#cb77-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># } else {</span></span>
<span id="cb77-84"><a href="#cb77-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   cat("Warning: 'figure_output_dir' not defined or does not exist. Overall AUC comparison plot not saved to file.\n")</span></span>
<span id="cb77-85"><a href="#cb77-85" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb77-86"><a href="#cb77-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # --- </span><span class="re">END</span><span class="co"> OF ADDED SECTION ---</span></span>
<span id="cb77-87"><a href="#cb77-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-88"><a href="#cb77-88" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Detailed boxplot per species</span></span>
<span id="cb77-89"><a href="#cb77-89" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison_plot_species <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb77-90"><a href="#cb77-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">species_display =</span> <span class="fu">str_replace</span>(species, <span class="st">"_"</span>, <span class="st">" "</span>),</span>
<span id="cb77-91"><a href="#cb77-91" aria-hidden="true" tabindex="-1"></a>           <span class="at">model_type_display =</span> <span class="fu">factor</span>(model_type, <span class="co"># Ensure consistent factor for plotting</span></span>
<span id="cb77-92"><a href="#cb77-92" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"biotic_only"</span>, <span class="st">"combined_host_env"</span>),</span>
<span id="cb77-93"><a href="#cb77-93" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span>, <span class="st">"Biotic (Host) Only"</span>, <span class="st">"Combined (Host+Env)"</span>))) </span>
<span id="cb77-94"><a href="#cb77-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-95"><a href="#cb77-95" aria-hidden="true" tabindex="-1"></a>  plot_auc_per_species <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_fish_comparison_plot_species, <span class="fu">aes</span>(<span class="at">x =</span> species_display, <span class="at">y =</span> AUC_test_CV, <span class="at">fill =</span> model_type_display)) <span class="sc">+</span></span>
<span id="cb77-96"><a href="#cb77-96" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">preserve =</span> <span class="st">"single"</span>)) <span class="sc">+</span> </span>
<span id="cb77-97"><a href="#cb77-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">23</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">fill =</span> <span class="st">"red"</span>, <span class="at">color =</span> <span class="st">"black"</span>,</span>
<span id="cb77-98"><a href="#cb77-98" aria-hidden="true" tabindex="-1"></a>                 <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.75</span>, <span class="at">preserve =</span> <span class="st">"single"</span>), </span>
<span id="cb77-99"><a href="#cb77-99" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">group =</span> model_type_display)) <span class="sc">+</span> </span>
<span id="cb77-100"><a href="#cb77-100" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb77-101"><a href="#cb77-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Anemonefish Model Performance by Species and Type"</span>,</span>
<span id="cb77-102"><a href="#cb77-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Anemonefish Species"</span>,</span>
<span id="cb77-103"><a href="#cb77-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Test AUC (Predictive Accuracy)"</span></span>
<span id="cb77-104"><a href="#cb77-104" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-105"><a href="#cb77-105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(</span>
<span id="cb77-106"><a href="#cb77-106" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Environmental Only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"Biotic (Host) Only"</span> <span class="ot">=</span> <span class="st">"skyblue"</span>, <span class="st">"Combined (Host+Env)"</span> <span class="ot">=</span> <span class="st">"salmon"</span>),</span>
<span id="cb77-107"><a href="#cb77-107" aria-hidden="true" tabindex="-1"></a>      <span class="at">name =</span> <span class="st">"Model Type:"</span></span>
<span id="cb77-108"><a href="#cb77-108" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-109"><a href="#cb77-109" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb77-110"><a href="#cb77-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb77-111"><a href="#cb77-111" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb77-112"><a href="#cb77-112" aria-hidden="true" tabindex="-1"></a>      <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb77-113"><a href="#cb77-113" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb77-114"><a href="#cb77-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">60</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">8</span>), </span>
<span id="cb77-115"><a href="#cb77-115" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb77-116"><a href="#cb77-116" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb77-117"><a href="#cb77-117" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb77-118"><a href="#cb77-118" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylim</span>(<span class="dv">0</span>, <span class="dv">1</span>) </span>
<span id="cb77-119"><a href="#cb77-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-120"><a href="#cb77-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_auc_per_species)</span>
<span id="cb77-121"><a href="#cb77-121" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If you want to save plot_auc_per_species, add similar ggsave() logic here</span></span>
<span id="cb77-122"><a href="#cb77-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-123"><a href="#cb77-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- ADD THIS SECTION TO SAVE plot_auc_comparison ---</span></span>
<span id="cb77-124"><a href="#cb77-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure figure_output_dir is defined (should be from setup chunk)</span></span>
<span id="cb77-125"><a href="#cb77-125" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb77-126"><a href="#cb77-126" aria-hidden="true" tabindex="-1"></a>    overall_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"anemonefish_model_auc_comparison_overall.png"</span>)</span>
<span id="cb77-127"><a href="#cb77-127" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> overall_comparison_plot_filename, </span>
<span id="cb77-128"><a href="#cb77-128" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_auc_per_species, </span>
<span id="cb77-129"><a href="#cb77-129" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Adjust dimensions/dpi as needed</span></span>
<span id="cb77-130"><a href="#cb77-130" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved overall model AUC comparison plot to:"</span>, overall_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-131"><a href="#cb77-131" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb77-132"><a href="#cb77-132" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Overall AUC comparison plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-133"><a href="#cb77-133" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-134"><a href="#cb77-134" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- </span><span class="re">END</span><span class="co"> OF ADDED SECTION ---</span></span>
<span id="cb77-135"><a href="#cb77-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-136"><a href="#cb77-136" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print mean AUC per species per model type</span></span>
<span id="cb77-137"><a href="#cb77-137" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Mean and Standard Deviation of Test AUC per Anemonefish Species and Model Type ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-138"><a href="#cb77-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-139"><a href="#cb77-139" aria-hidden="true" tabindex="-1"></a>  anemonefish_auc_summary_table <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb77-140"><a href="#cb77-140" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(species, model_type) <span class="sc">%&gt;%</span></span>
<span id="cb77-141"><a href="#cb77-141" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">summarize</span>(</span>
<span id="cb77-142"><a href="#cb77-142" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_AUC_test =</span> <span class="fu">mean</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb77-143"><a href="#cb77-143" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd_AUC_test =</span> <span class="fu">sd</span>(AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb77-144"><a href="#cb77-144" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_CV_folds =</span> <span class="fu">n</span>(), </span>
<span id="cb77-145"><a href="#cb77-145" aria-hidden="true" tabindex="-1"></a>      <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb77-146"><a href="#cb77-146" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb77-147"><a href="#cb77-147" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">species_display =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(species, <span class="st">"_"</span>, <span class="st">" "</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb77-148"><a href="#cb77-148" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="at">Species =</span> species_display, <span class="at">Model_Type =</span> model_type, <span class="at">Mean_AUC =</span> mean_AUC_test, <span class="at">SD_AUC =</span> sd_AUC_test, <span class="at">N_Folds =</span> n_CV_folds) <span class="sc">%&gt;%</span></span>
<span id="cb77-149"><a href="#cb77-149" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Mean_AUC =</span> <span class="fu">round</span>(Mean_AUC, <span class="dv">3</span>),</span>
<span id="cb77-150"><a href="#cb77-150" aria-hidden="true" tabindex="-1"></a>           <span class="at">SD_AUC =</span> <span class="fu">round</span>(SD_AUC, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb77-151"><a href="#cb77-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(Species, Model_Type)</span>
<span id="cb77-152"><a href="#cb77-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-153"><a href="#cb77-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"knitr"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_auc_summary_table) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb77-154"><a href="#cb77-154" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(knitr<span class="sc">::</span><span class="fu">kable</span>(anemonefish_auc_summary_table, </span>
<span id="cb77-155"><a href="#cb77-155" aria-hidden="true" tabindex="-1"></a>                       <span class="at">caption =</span> <span class="st">"Mean and Standard Deviation of Test AUC for Anemonefish Models by Species and Type."</span>))</span>
<span id="cb77-156"><a href="#cb77-156" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">nrow</span>(anemonefish_auc_summary_table) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb77-157"><a href="#cb77-157" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(anemonefish_auc_summary_table)</span>
<span id="cb77-158"><a href="#cb77-158" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb77-159"><a href="#cb77-159" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No summary data to print for anemonefish AUC.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-160"><a href="#cb77-160" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-161"><a href="#cb77-161" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb77-162"><a href="#cb77-162" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Optional: Save this summary table to a CSV</span></span>
<span id="cb77-163"><a href="#cb77-163" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure 'analysis_output_dir' is defined in your setup chunk if you use this</span></span>
<span id="cb77-164"><a href="#cb77-164" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"analysis_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(analysis_output_dir)) {</span>
<span id="cb77-165"><a href="#cb77-165" aria-hidden="true" tabindex="-1"></a>      anemonefish_cv_summary_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(analysis_output_dir, <span class="st">"anemonefish_detailed_CV_summary_auc.csv"</span>)</span>
<span id="cb77-166"><a href="#cb77-166" aria-hidden="true" tabindex="-1"></a>      <span class="co"># dir.create(dirname(anemonefish_cv_summary_path), recursive = TRUE, showWarnings = FALSE) # dir should exist from setup</span></span>
<span id="cb77-167"><a href="#cb77-167" aria-hidden="true" tabindex="-1"></a>      <span class="fu">write.csv</span>(anemonefish_auc_summary_table, anemonefish_cv_summary_path, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb77-168"><a href="#cb77-168" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anemonefish detailed CV summary (Mean &amp; SD AUC) saved to:"</span>, anemonefish_cv_summary_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-169"><a href="#cb77-169" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb77-170"><a href="#cb77-170" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Warning: 'analysis_output_dir' not defined. Anemonefish detailed CV summary not saved to CSV.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-171"><a href="#cb77-171" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-172"><a href="#cb77-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-173"><a href="#cb77-173" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb77-174"><a href="#cb77-174" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Skipping model comparison as 'df_fish_comparison' is empty or AUC_test_CV is missing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb77-175"><a href="#cb77-175" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Fitting GLMM to compare AUC_test_CV across model types ---

Summary of GLMM for AUC_test_CV:
 Family: gaussian  ( identity )
Formula:          AUC_test_CV ~ model_type + (1 | species)
Data: df_fish_comparison

      AIC       BIC    logLik -2*log(L)  df.resid 
  -2536.5   -2513.8    1273.2   -2546.5       686 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 species  (Intercept) 0.005001 0.07072 
 Residual             0.001348 0.03672 
Number of obs: 691, groups:  species, 11

Dispersion estimate for gaussian family (sigma^2): 0.00135 

Conditional model:
                             Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                  0.814986   0.021471   37.96  &lt; 2e-16 ***
model_typecombined_host_env  0.019623   0.003484    5.63 1.77e-08 ***
model_typebiotic_only       -0.006826   0.003420   -2.00    0.046 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

--- Generating boxplot of AUC_test_CV by model type ---</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/compare-fish-model-performance-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/compare-fish-model-performance-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved overall model AUC comparison plot to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/anemonefish_model_auc_comparison_overall.png 

--- Mean and Standard Deviation of Test AUC per Anemonefish Species and Model Type ---


Table: Mean and Standard Deviation of Test AUC for Anemonefish Models by Species and Type.

|Species                 |Model_Type        | Mean_AUC| SD_AUC| N_Folds|
|:-----------------------|:-----------------|--------:|------:|-------:|
|Amphiprion akindynos    |env_only          |    0.891|  0.020|      14|
|Amphiprion akindynos    |combined_host_env |    0.896|  0.013|      15|
|Amphiprion akindynos    |biotic_only       |    0.765|  0.043|      20|
|Amphiprion allardi      |env_only          |    0.946|  0.012|       9|
|Amphiprion allardi      |combined_host_env |    0.963|  0.005|      12|
|Amphiprion allardi      |biotic_only       |    0.959|  0.008|      20|
|Amphiprion bicinctus    |env_only          |    0.842|  0.032|      14|
|Amphiprion bicinctus    |combined_host_env |    0.916|  0.017|      17|
|Amphiprion bicinctus    |biotic_only       |    0.912|  0.025|      20|
|Amphiprion clarkii      |env_only          |    0.745|  0.022|      20|
|Amphiprion clarkii      |combined_host_env |    0.744|  0.026|      20|
|Amphiprion clarkii      |biotic_only       |    0.740|  0.026|      20|
|Amphiprion frenatus     |env_only          |    0.660|  0.009|      47|
|Amphiprion frenatus     |combined_host_env |    0.697|  0.010|      48|
|Amphiprion frenatus     |biotic_only       |    0.724|  0.022|      50|
|Amphiprion melanopus    |env_only          |    0.867|  0.014|      20|
|Amphiprion melanopus    |combined_host_env |    0.880|  0.010|      20|
|Amphiprion melanopus    |biotic_only       |    0.854|  0.022|      20|
|Amphiprion ocellaris    |env_only          |    0.745|  0.018|      19|
|Amphiprion ocellaris    |combined_host_env |    0.773|  0.019|      19|
|Amphiprion ocellaris    |biotic_only       |    0.736|  0.042|      20|
|Amphiprion percula      |env_only          |    0.788|  0.039|      19|
|Amphiprion percula      |combined_host_env |    0.802|  0.036|      19|
|Amphiprion percula      |biotic_only       |    0.770|  0.052|      20|
|Amphiprion perideraion  |env_only          |    0.854|  0.012|      20|
|Amphiprion perideraion  |combined_host_env |    0.855|  0.013|      20|
|Amphiprion perideraion  |biotic_only       |    0.787|  0.033|      20|
|Amphiprion sandaracinos |env_only          |    0.837|  0.040|      20|
|Amphiprion sandaracinos |combined_host_env |    0.840|  0.047|      20|
|Amphiprion sandaracinos |biotic_only       |    0.798|  0.064|      20|
|Premnas biaculeatus     |env_only          |    0.828|  0.023|      18|
|Premnas biaculeatus     |combined_host_env |    0.843|  0.018|      15|
|Premnas biaculeatus     |biotic_only       |    0.779|  0.025|      16|

Anemonefish detailed CV summary (Mean &amp; SD AUC) saved to: /Users/chrisrauch/anemonefish_post_analysis/outputs_for_analysis/anemonefish_detailed_CV_summary_auc.csv </code></pre>
</div>
</div>
</section>
<section id="species-specific-anemonefish-model-performance-comparison" class="level2">
<h2 class="anchored" data-anchor-id="species-specific-anemonefish-model-performance-comparison">Species-Specific Anemonefish Model Performance Comparison</h2>
<p>This section performs a model comparison (environmental-only vs.&nbsp;biotic-only vs.&nbsp;combined) for each anemonefish species individually. For each species, an ANOVA is used to test for significant differences in mean Test AUC values across the model types, followed by Tukey’s HSD post-hoc tests if the ANOVA is significant. Boxplots illustrate these comparisons for each species.</p>
<div class="cell" data-cap="Comparison of Anemonefish Model Performance (Test AUC) for Each Species. For each species, boxplots show the distribution of Test AUC values from replicate runs for each model type (environmental-only, biotic-only, combined host+environment). Individual points represent single model runs (jittered), and large black points indicate the mean AUC for each model type. ANOVA and Tukey's HSD tests (where appropriate) are performed to assess significant differences between model types within each species.">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure df_fish_comparison is available from the previous chunk</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(df_fish_comparison) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="st">"AUC_test_CV"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison)) {</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a working version of the dataframe with a cleaned species column for this specific analysis.</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This avoids modifying the original df_fish_comparison if it's used later in its original state.</span></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># It also handles cases where species names might have .csv suffixes.</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>  df_fish_comparison_for_species_analysis <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">species_cleaned_for_loop =</span> stringr<span class="sc">::</span><span class="fu">str_remove</span>(species, <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>)) <span class="co"># Remove .csv suffix</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get unique cleaned species names for the loop</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>  all_anemonefish_species_for_loop <span class="ot">&lt;-</span> <span class="fu">unique</span>(df_fish_comparison_for_species_analysis<span class="sc">$</span>species_cleaned_for_loop)</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Performing species-specific model performance comparisons for anemonefish...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Loop through each unique anemonefish species</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (current_species_name_sanitized <span class="cf">in</span> all_anemonefish_species_for_loop) {</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a more readable species name for output</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>    current_species_display_name <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, current_species_name_sanitized)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n\n</span><span class="st">---</span><span class="sc">\n</span><span class="st">"</span>) <span class="co"># Horizontal rule for separation in output</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"### Statistical Comparison for: *"</span>, current_species_display_name, <span class="st">"*</span><span class="sc">\n</span><span class="st">"</span>)) <span class="co"># Markdown sub-header</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset data for the current species</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>    species_data_subset <span class="ot">&lt;-</span> df_fish_comparison <span class="sc">%&gt;%</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(species <span class="sc">==</span> current_species_name_sanitized) <span class="sc">%&gt;%</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">model_type =</span> <span class="fu">factor</span>(model_type, </span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"env_only"</span>, <span class="st">"biotic_only"</span>, <span class="st">"combined_host_env"</span>))) <span class="co"># Ensure factor levels</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if there's enough data to proceed</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(species_data_subset) <span class="sc">&lt;</span> <span class="dv">3</span> <span class="sc">||</span> <span class="fu">length</span>(<span class="fu">unique</span>(species_data_subset<span class="sc">$</span>model_type)) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"Not enough data or distinct model types for "</span>, current_species_display_name, <span class="st">" to perform comparison. Skipping.</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for sufficient replicates per model type</span></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a>    replicates_summary <span class="ot">&lt;-</span> species_data_subset <span class="sc">%&gt;%</span></span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(model_type) <span class="sc">%&gt;%</span></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">n_runs =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">'drop'</span>)</span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Number of runs per model type:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(knitr<span class="sc">::</span><span class="fu">kable</span>(replicates_summary, <span class="at">caption =</span> <span class="fu">paste</span>(<span class="st">"Replicates for"</span>, current_species_display_name)))</span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">any</span>(replicates_summary<span class="sc">$</span>n_runs <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(<span class="fu">unique</span>(replicates_summary<span class="sc">$</span>model_type)) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">*Warning: At least one model type for "</span>, current_species_display_name, <span class="st">" has fewer than 2 replicate runs. ANOVA results may not be robust.*</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(replicates_summary<span class="sc">$</span>model_type[replicates_summary<span class="sc">$</span>n_runs <span class="sc">&gt;</span> <span class="dv">0</span>])) <span class="sc">&lt;</span> <span class="dv">2</span>) { <span class="co"># Check model types with actual data</span></span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">*Warning: "</span>, current_species_display_name, <span class="st">" does not have at least two different model types with data. Skipping ANOVA for this species.*</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Statistical Comparison using ANOVA for the current species ---</span></span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">**ANOVA: Test AUC vs. Model Type**</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if AUC_test_CV has any variance for this species</span></span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">na.omit</span>(species_data_subset<span class="sc">$</span>AUC_test_CV))) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"AUC_test_CV values are constant (or all NA) for "</span>, current_species_display_name, <span class="st">". Skipping ANOVA.</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>        anova_model_species <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>          <span class="fu">aov</span>(AUC_test_CV <span class="sc">~</span> model_type, <span class="at">data =</span> species_data_subset)</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>        }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"Error performing ANOVA for "</span>, current_species_display_name, <span class="st">": "</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a>          <span class="cn">NULL</span></span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(anova_model_species)) {</span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Print ANOVA summary</span></span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(<span class="fu">summary</span>(anova_model_species))</span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Perform Tukey's HSD for pairwise comparisons if ANOVA is significant</span></span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a>          anova_summary_table <span class="ot">&lt;-</span> <span class="fu">summary</span>(anova_model_species)[[<span class="dv">1</span>]] <span class="co"># This is a list containing the table</span></span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a>          p_value_from_anova <span class="ot">&lt;-</span> anova_summary_table<span class="sc">$</span><span class="st">"Pr(&gt;F)"</span>[<span class="dv">1</span>] <span class="co"># Get the p-value for model_type</span></span>
<span id="cb80-72"><a href="#cb80-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-73"><a href="#cb80-73" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(p_value_from_anova) <span class="sc">&amp;&amp;</span> p_value_from_anova <span class="sc">&lt;</span> <span class="fl">0.05</span>) {</span>
<span id="cb80-74"><a href="#cb80-74" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">**Tukey's HSD Post-Hoc Test (Pairwise Comparisons)**</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-75"><a href="#cb80-75" aria-hidden="true" tabindex="-1"></a>            tukey_hsd_results <span class="ot">&lt;-</span> <span class="fu">TukeyHSD</span>(anova_model_species)</span>
<span id="cb80-76"><a href="#cb80-76" aria-hidden="true" tabindex="-1"></a>            <span class="fu">print</span>(tukey_hsd_results)</span>
<span id="cb80-77"><a href="#cb80-77" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb80-78"><a href="#cb80-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(p_value_from_anova)) {</span>
<span id="cb80-79"><a href="#cb80-79" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="fu">paste0</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">ANOVA for model_type not significant (p = "</span>, <span class="fu">round</span>(p_value_from_anova, <span class="dv">4</span>), <span class="st">"), skipping Tukey's HSD.</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb80-80"><a href="#cb80-80" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb80-81"><a href="#cb80-81" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Could not determine ANOVA significance, skipping Tukey's HSD.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-82"><a href="#cb80-82" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb80-83"><a href="#cb80-83" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb80-84"><a href="#cb80-84" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb80-85"><a href="#cb80-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-86"><a href="#cb80-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-87"><a href="#cb80-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Visualization for the current species ---</span></span>
<span id="cb80-88"><a href="#cb80-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># cat("\n**Boxplot: Test AUC by Model Type**\n") # This title is now part of the plot</span></span>
<span id="cb80-89"><a href="#cb80-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-90"><a href="#cb80-90" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine dynamic y-axis limits, ensuring they are sensible for AUC</span></span>
<span id="cb80-91"><a href="#cb80-91" aria-hidden="true" tabindex="-1"></a>    min_auc_val <span class="ot">&lt;-</span> <span class="fu">min</span>(species_data_subset<span class="sc">$</span>AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb80-92"><a href="#cb80-92" aria-hidden="true" tabindex="-1"></a>    max_auc_val <span class="ot">&lt;-</span> <span class="fu">max</span>(species_data_subset<span class="sc">$</span>AUC_test_CV, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb80-93"><a href="#cb80-93" aria-hidden="true" tabindex="-1"></a>    y_lower_limit <span class="ot">&lt;-</span> <span class="fu">max</span>(<span class="dv">0</span>, <span class="fu">min</span>(<span class="fl">0.4</span>, min_auc_val <span class="sc">-</span> <span class="fl">0.05</span>)) <span class="co"># Not below 0, and give some space</span></span>
<span id="cb80-94"><a href="#cb80-94" aria-hidden="true" tabindex="-1"></a>    y_upper_limit <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="dv">1</span>, max_auc_val <span class="sc">+</span> <span class="fl">0.05</span>)         <span class="co"># Not above 1, and give some space</span></span>
<span id="cb80-95"><a href="#cb80-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.infinite</span>(y_lower_limit) <span class="sc">||</span> <span class="fu">is.infinite</span>(y_upper_limit)) { <span class="co"># Fallback if all NAs</span></span>
<span id="cb80-96"><a href="#cb80-96" aria-hidden="true" tabindex="-1"></a>        y_lower_limit <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb80-97"><a href="#cb80-97" aria-hidden="true" tabindex="-1"></a>        y_upper_limit <span class="ot">&lt;-</span> <span class="fl">1.0</span></span>
<span id="cb80-98"><a href="#cb80-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb80-99"><a href="#cb80-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-100"><a href="#cb80-100" aria-hidden="true" tabindex="-1"></a>    plot_auc_species_specific <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(species_data_subset, <span class="fu">aes</span>(<span class="at">x =</span> model_type, <span class="at">y =</span> AUC_test_CV, <span class="at">fill =</span> model_type)) <span class="sc">+</span></span>
<span id="cb80-101"><a href="#cb80-101" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">outlier.shape =</span> <span class="cn">NA</span>) <span class="sc">+</span> <span class="co"># Hiding default outliers as geom_jitter shows all points</span></span>
<span id="cb80-102"><a href="#cb80-102" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_jitter</span>(<span class="at">width =</span> <span class="fl">0.15</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>, <span class="at">height =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span> <span class="co"># Show individual run points</span></span>
<span id="cb80-103"><a href="#cb80-103" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">"point"</span>, <span class="at">shape =</span> <span class="dv">23</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color=</span><span class="st">"black"</span>, <span class="co"># Diamond for mean</span></span>
<span id="cb80-104"><a href="#cb80-104" aria-hidden="true" tabindex="-1"></a>                   <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">width =</span> <span class="fl">0.75</span>)) <span class="sc">+</span></span>
<span id="cb80-105"><a href="#cb80-105" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(</span>
<span id="cb80-106"><a href="#cb80-106" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Model Performance (Test AUC) for"</span>, current_species_display_name),</span>
<span id="cb80-107"><a href="#cb80-107" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Model Type"</span>,</span>
<span id="cb80-108"><a href="#cb80-108" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Test AUC Score"</span></span>
<span id="cb80-109"><a href="#cb80-109" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb80-110"><a href="#cb80-110" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_manual</span>(</span>
<span id="cb80-111"><a href="#cb80-111" aria-hidden="true" tabindex="-1"></a>        <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"env_only"</span> <span class="ot">=</span> <span class="st">"grey70"</span>, <span class="st">"biotic_only"</span> <span class="ot">=</span> <span class="st">"skyblue"</span>, <span class="st">"combined_host_env"</span> <span class="ot">=</span> <span class="st">"salmon"</span>),</span>
<span id="cb80-112"><a href="#cb80-112" aria-hidden="true" tabindex="-1"></a>        <span class="at">name =</span> <span class="st">"Model Type:"</span>,</span>
<span id="cb80-113"><a href="#cb80-113" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">"PCA Only"</span>, <span class="st">"Host Only"</span>, <span class="st">"PCA + Host"</span>)</span>
<span id="cb80-114"><a href="#cb80-114" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb80-115"><a href="#cb80-115" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb80-116"><a href="#cb80-116" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(</span>
<span id="cb80-117"><a href="#cb80-117" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"top"</span>, </span>
<span id="cb80-118"><a href="#cb80-118" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">9</span>),</span>
<span id="cb80-119"><a href="#cb80-119" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb80-120"><a href="#cb80-120" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb80-121"><a href="#cb80-121" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">+</span></span>
<span id="cb80-122"><a href="#cb80-122" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coord_cartesian</span>(<span class="at">ylim =</span> <span class="fu">c</span>(y_lower_limit, y_upper_limit)) <span class="co"># Apply dynamic y-limits</span></span>
<span id="cb80-123"><a href="#cb80-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-124"><a href="#cb80-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(plot_auc_species_specific)</span>
<span id="cb80-125"><a href="#cb80-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb80-126"><a href="#cb80-126" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># End loop through species</span></span>
<span id="cb80-127"><a href="#cb80-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-128"><a href="#cb80-128" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb80-129"><a href="#cb80-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Skipping species-specific anemonefish model comparison as 'df_fish_comparison' is not available, empty, or 'AUC_test_CV' column is missing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb80-130"><a href="#cb80-130" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Performing species-specific model performance comparisons for anemonefish...


---
### Statistical Comparison for: *Amphiprion akindynos*

Number of runs per model type:


Table: Replicates for Amphiprion akindynos

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |     14|
|biotic_only       |     20|
|combined_host_env |     15|

**ANOVA: Test AUC vs. Model Type**
            Df  Sum Sq Mean Sq F value Pr(&gt;F)    
model_type   2 0.19650 0.09825   104.3 &lt;2e-16 ***
Residuals   46 0.04335 0.00094                   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

**Tukey's HSD Post-Hoc Test (Pairwise Comparisons)**
  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = AUC_test_CV ~ model_type, data = species_data_subset)

$model_type
                                      diff         lwr         upr     p adj
biotic_only-env_only          -0.126565714 -0.15247178 -0.10065965 0.0000000
combined_host_env-env_only     0.004320952 -0.02330583  0.03194774 0.9240926
combined_host_env-biotic_only  0.130886667  0.10549364  0.15627969 0.0000000</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

---
### Statistical Comparison for: *Amphiprion allardi*

Number of runs per model type:


Table: Replicates for Amphiprion allardi

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |      9|
|biotic_only       |     20|
|combined_host_env |     12|

**ANOVA: Test AUC vs. Model Type**
            Df   Sum Sq  Mean Sq F value   Pr(&gt;F)    
model_type   2 0.001532 7.66e-04    11.4 0.000132 ***
Residuals   38 0.002552 6.72e-05                     
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

**Tukey's HSD Post-Hoc Test (Pairwise Comparisons)**
  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = AUC_test_CV ~ model_type, data = species_data_subset)

$model_type
                                     diff          lwr        upr     p adj
biotic_only-env_only          0.013267778  0.005244974 0.02129058 0.0007330
combined_host_env-env_only    0.016344444  0.007530685 0.02515820 0.0001691
combined_host_env-biotic_only 0.003076667 -0.004221819 0.01037515 0.5639999</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

---
### Statistical Comparison for: *Amphiprion bicinctus*

Number of runs per model type:


Table: Replicates for Amphiprion bicinctus

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |     14|
|biotic_only       |     20|
|combined_host_env |     17|

**ANOVA: Test AUC vs. Model Type**
            Df  Sum Sq  Mean Sq F value   Pr(&gt;F)    
model_type   2 0.05219 0.026094   42.05 2.81e-11 ***
Residuals   48 0.02979 0.000621                     
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

**Tukey's HSD Post-Hoc Test (Pairwise Comparisons)**
  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = AUC_test_CV ~ model_type, data = species_data_subset)

$model_type
                                     diff         lwr        upr    p adj
biotic_only-env_only          0.069657857  0.04866412 0.09065159 0.000000
combined_host_env-env_only    0.073822269  0.05207916 0.09556538 0.000000
combined_host_env-biotic_only 0.004164412 -0.01570983 0.02403866 0.868409</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

---
### Statistical Comparison for: *Amphiprion clarkii*

Number of runs per model type:


Table: Replicates for Amphiprion clarkii

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |     20|
|biotic_only       |     20|
|combined_host_env |     20|

**ANOVA: Test AUC vs. Model Type**
            Df  Sum Sq   Mean Sq F value Pr(&gt;F)
model_type   2 0.00028 0.0001412   0.231  0.794
Residuals   57 0.03484 0.0006112               

ANOVA for model_type not significant (p = 0.7944), skipping Tukey's HSD.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

---
### Statistical Comparison for: *Amphiprion frenatus*

Number of runs per model type:


Table: Replicates for Amphiprion frenatus

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |     47|
|biotic_only       |     50|
|combined_host_env |     48|

**ANOVA: Test AUC vs. Model Type**
             Df  Sum Sq Mean Sq F value Pr(&gt;F)    
model_type    2 0.09936 0.04968   213.3 &lt;2e-16 ***
Residuals   142 0.03308 0.00023                   
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

**Tukey's HSD Post-Hoc Test (Pairwise Comparisons)**
  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = AUC_test_CV ~ model_type, data = species_data_subset)

$model_type
                                     diff         lwr         upr p adj
biotic_only-env_only           0.06389834  0.05655417  0.07124251     0
combined_host_env-env_only     0.03663067  0.02921274  0.04404861     0
combined_host_env-biotic_only -0.02726767 -0.03457229 -0.01996304     0</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

---
### Statistical Comparison for: *Amphiprion melanopus*

Number of runs per model type:


Table: Replicates for Amphiprion melanopus

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |     20|
|biotic_only       |     20|
|combined_host_env |     20|

**ANOVA: Test AUC vs. Model Type**
            Df  Sum Sq  Mean Sq F value   Pr(&gt;F)    
model_type   2 0.00664 0.003320   13.06 2.13e-05 ***
Residuals   57 0.01448 0.000254                     
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

**Tukey's HSD Post-Hoc Test (Pairwise Comparisons)**
  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = AUC_test_CV ~ model_type, data = species_data_subset)

$model_type
                                   diff           lwr          upr     p adj
biotic_only-env_only          -0.013230 -0.0253604436 -0.001099556 0.0294763
combined_host_env-env_only     0.012535  0.0004045564  0.024665444 0.0413318
combined_host_env-biotic_only  0.025765  0.0136345564  0.037895444 0.0000115</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

---
### Statistical Comparison for: *Amphiprion ocellaris*

Number of runs per model type:


Table: Replicates for Amphiprion ocellaris

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |     19|
|biotic_only       |     20|
|combined_host_env |     19|

**ANOVA: Test AUC vs. Model Type**
            Df  Sum Sq  Mean Sq F value   Pr(&gt;F)    
model_type   2 0.01453 0.007263   8.701 0.000521 ***
Residuals   55 0.04591 0.000835                     
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

**Tukey's HSD Post-Hoc Test (Pairwise Comparisons)**
  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = AUC_test_CV ~ model_type, data = species_data_subset)

$model_type
                                      diff          lwr        upr     p adj
biotic_only-env_only          -0.009586579 -0.031881021 0.01270786 0.5577299
combined_host_env-env_only     0.027747368  0.005168909 0.05032583 0.0123967
combined_host_env-biotic_only  0.037333947  0.015039505 0.05962839 0.0004949</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-7.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

---
### Statistical Comparison for: *Amphiprion percula*

Number of runs per model type:


Table: Replicates for Amphiprion percula

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |     19|
|biotic_only       |     20|
|combined_host_env |     19|

**ANOVA: Test AUC vs. Model Type**
            Df  Sum Sq  Mean Sq F value Pr(&gt;F)  
model_type   2 0.01019 0.005096   2.785 0.0704 .
Residuals   55 0.10064 0.001830                 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

ANOVA for model_type not significant (p = 0.0704), skipping Tukey's HSD.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-8.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

---
### Statistical Comparison for: *Amphiprion perideraion*

Number of runs per model type:


Table: Replicates for Amphiprion perideraion

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |     20|
|biotic_only       |     20|
|combined_host_env |     20|

**ANOVA: Test AUC vs. Model Type**
            Df  Sum Sq  Mean Sq F value   Pr(&gt;F)    
model_type   2 0.05940 0.029700   63.94 2.73e-15 ***
Residuals   57 0.02647 0.000464                     
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

**Tukey's HSD Post-Hoc Test (Pairwise Comparisons)**
  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = AUC_test_CV ~ model_type, data = species_data_subset)

$model_type
                                   diff        lwr        upr     p adj
biotic_only-env_only          -0.066245 -0.0826452 -0.0498448 0.0000000
combined_host_env-env_only     0.000990 -0.0154102  0.0173902 0.9884364
combined_host_env-biotic_only  0.067235  0.0508348  0.0836352 0.0000000</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-9.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

---
### Statistical Comparison for: *Amphiprion sandaracinos*

Number of runs per model type:


Table: Replicates for Amphiprion sandaracinos

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |     20|
|biotic_only       |     20|
|combined_host_env |     20|

**ANOVA: Test AUC vs. Model Type**
            Df  Sum Sq  Mean Sq F value Pr(&gt;F)  
model_type   2 0.02273 0.011365   4.317  0.018 *
Residuals   57 0.15006 0.002633                 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

**Tukey's HSD Post-Hoc Test (Pairwise Comparisons)**
  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = AUC_test_CV ~ model_type, data = species_data_subset)

$model_type
                                   diff          lwr           upr     p adj
biotic_only-env_only          -0.039745 -0.078790163 -0.0006998368 0.0451638
combined_host_env-env_only     0.002930 -0.036115163  0.0419751632 0.9821890
combined_host_env-biotic_only  0.042675  0.003629837  0.0817201632 0.0290671</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-10.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>

---
### Statistical Comparison for: *Premnas biaculeatus*

Number of runs per model type:


Table: Replicates for Premnas biaculeatus

|model_type        | n_runs|
|:-----------------|------:|
|env_only          |     18|
|biotic_only       |     16|
|combined_host_env |     15|

**ANOVA: Test AUC vs. Model Type**
            Df  Sum Sq  Mean Sq F value   Pr(&gt;F)    
model_type   2 0.03610 0.018050   35.44 4.85e-10 ***
Residuals   46 0.02343 0.000509                     
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

**Tukey's HSD Post-Hoc Test (Pairwise Comparisons)**
  Tukey multiple comparisons of means
    95% family-wise confidence level

Fit: aov(formula = AUC_test_CV ~ model_type, data = species_data_subset)

$model_type
                                     diff          lwr         upr     p adj
biotic_only-env_only          -0.04929722 -0.068077682 -0.03051676 0.0000003
combined_host_env-env_only     0.01541111 -0.003697895  0.03452012 0.1355503
combined_host_env-biotic_only  0.06470833  0.045063958  0.08435271 0.0000000</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/species-specific-fish-model-performance-11.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="current-environmental-predictors-pca" class="level2">
<h2 class="anchored" data-anchor-id="current-environmental-predictors-pca">Current Environmental Predictors (PCA)</h2>
<p>This section loads the Principal Component Analysis (PCA) rasters for the current environmental conditions. These PCA rasters were generated by script <code>05_preprocess_env_pca_only.R</code> (if PCA was used) and represent the primary environmental gradients used in the SDMs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Loading Current Environmental PCA Rasters ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The rds file stores a list of paths, one for each scenario's PCA .tif file</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)) {</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"PCA raster paths RDS file not found: "</span>, config<span class="sc">$</span>pca_raster_paths_rds_path, </span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>         <span class="st">"</span><span class="sc">\n</span><span class="st">Please ensure script 05 (PCA preprocessing) ran successfully."</span>)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>  all_pca_raster_paths <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  current_pca_path <span class="ot">&lt;-</span> all_pca_raster_paths[[<span class="st">"current"</span>]]</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(current_pca_path) <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(current_pca_path)) {</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Path for 'current' PCA raster not found in RDS or file does not exist: "</span>, current_pca_path <span class="sc">%||%</span> <span class="st">"NULL"</span>)</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>  env_pca_current <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>    terra<span class="sc">::</span><span class="fu">rast</span>(current_pca_path)</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error loading current PCA raster from:"</span>, current_pca_path, <span class="st">"</span><span class="sc">\n</span><span class="st">Error:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>    <span class="cn">NULL</span></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(env_pca_current)) {</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(env_pca_current) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Current Environmental PC"</span>, <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(env_pca_current)) <span class="co"># Ensure standard names</span></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Loaded current environmental PCA rasters. Layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(env_pca_current), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crop if configured (should match how other current rasters were handled)</span></span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>      ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>      env_pca_current_cropped <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(env_pca_current, ip_extent)</span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(env_pca_current_cropped)</span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>      env_pca_current_cropped <span class="ot">&lt;-</span> env_pca_current <span class="co"># Use uncropped if not configured</span></span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(env_pca_current_cropped)</span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error: Could not load current environmental PCA rasters.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>    env_pca_current_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- PCA predictors not used. Skipping loading of current PCA rasters. ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    You might need to load your VIF-selected current environmental rasters here if needed for specific analyses.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a>  env_pca_current_cropped <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Ensure this object exists as NULL if PCA not used</span></span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Current Environmental PCA Rasters ---
Loaded current environmental PCA rasters. Layers: Current Environmental PC1, Current Environmental PC2, Current Environmental PC3, Current Environmental PC4 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-current-env-pca-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="future-species-richness-projections" class="level2">
<h2 class="anchored" data-anchor-id="future-species-richness-projections">Future Species Richness Projections</h2>
<p>This section loads the predicted future suitability rasters for host sea anemones and anemonefish (from environmental-only models) for each future scenario and time step, and calculates the summed richness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the future scenarios and time steps from your config</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Your config$env_scenarios already includes "current", so we filter that out</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>future_scenarios_to_load <span class="ot">&lt;-</span> config<span class="sc">$</span>env_scenarios[config<span class="sc">$</span>env_scenarios <span class="sc">!=</span> <span class="st">"current"</span>]</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(future_scenarios_to_load) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No future scenarios defined in config$env_scenarios to load predictions for.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Lists to store the summed richness rasters for each future scenario</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>host_richness_future_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>fish_richness_future_list <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># For env-only fish models</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create subdirectory for these specific future richness maps ---</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="co"># This assumes figure_output_dir is defined in your setup chunk</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>future_richness_maps_subdir <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>  future_richness_maps_subdir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"future_richness_projections"</span>)</span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(future_richness_maps_subdir)) {</span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(future_richness_maps_subdir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Created subdirectory for future richness maps at:"</span>, future_richness_maps_subdir, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Future richness maps will not be saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each future scenario</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Processing Future Scenario:"</span>, scenario_name, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 1. Load Host Sea Anemone Future Predictions ---</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Loading Host Sea Anemone predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a>  host_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assuming anemone_species_df and predictor_suffix are defined from a previous chunk</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemone_species_df)) { </span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a>    sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemone_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a>    pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_prediction_filename</span>(</span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">predictor_type_suffix =</span> predictor_suffix, </span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">config =</span> config</span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a>      host_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(host_future_raster_files, pred_file_path)</span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Host prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(host_future_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb94-50"><a href="#cb94-50" aria-hidden="true" tabindex="-1"></a>    host_pred_stack_future <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(host_future_raster_files)</span>
<span id="cb94-51"><a href="#cb94-51" aria-hidden="true" tabindex="-1"></a>    host_richness_sum_future <span class="ot">&lt;-</span> <span class="fu">sum</span>(host_pred_stack_future, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb94-52"><a href="#cb94-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Name the layer within the SpatRaster for clarity if needed, though list name is primary</span></span>
<span id="cb94-53"><a href="#cb94-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># names(host_richness_sum_future) &lt;- paste0("HostAnemoneRichness") # Name of the single layer</span></span>
<span id="cb94-54"><a href="#cb94-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb94-55"><a href="#cb94-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb94-56"><a href="#cb94-56" aria-hidden="true" tabindex="-1"></a>      ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb94-57"><a href="#cb94-57" aria-hidden="true" tabindex="-1"></a>      host_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(host_richness_sum_future, ip_extent)</span>
<span id="cb94-58"><a href="#cb94-58" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb94-59"><a href="#cb94-59" aria-hidden="true" tabindex="-1"></a>      host_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> host_richness_sum_future</span>
<span id="cb94-60"><a href="#cb94-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-61"><a href="#cb94-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Processed host anemone richness for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-62"><a href="#cb94-62" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-63"><a href="#cb94-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Warning: No host prediction files found for scenario"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-64"><a href="#cb94-64" aria-hidden="true" tabindex="-1"></a>    host_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Ensure it's NULL if no data</span></span>
<span id="cb94-65"><a href="#cb94-65" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-66"><a href="#cb94-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-67"><a href="#cb94-67" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 2. Load Anemonefish (Environmental-Only) Future Predictions ---</span></span>
<span id="cb94-68"><a href="#cb94-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Loading Anemonefish (Env-Only) predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-69"><a href="#cb94-69" aria-hidden="true" tabindex="-1"></a>  fish_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb94-70"><a href="#cb94-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assuming anemonefish_species_df and predictor_suffix are defined</span></span>
<span id="cb94-71"><a href="#cb94-71" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemonefish_species_df)) { </span>
<span id="cb94-72"><a href="#cb94-72" aria-hidden="true" tabindex="-1"></a>    sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb94-73"><a href="#cb94-73" aria-hidden="true" tabindex="-1"></a>    pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_prediction_filename</span>(</span>
<span id="cb94-74"><a href="#cb94-74" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb94-75"><a href="#cb94-75" aria-hidden="true" tabindex="-1"></a>      <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb94-76"><a href="#cb94-76" aria-hidden="true" tabindex="-1"></a>      <span class="at">predictor_type_suffix =</span> predictor_suffix, </span>
<span id="cb94-77"><a href="#cb94-77" aria-hidden="true" tabindex="-1"></a>      <span class="at">config =</span> config</span>
<span id="cb94-78"><a href="#cb94-78" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb94-79"><a href="#cb94-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb94-80"><a href="#cb94-80" aria-hidden="true" tabindex="-1"></a>      fish_future_raster_files <span class="ot">&lt;-</span> <span class="fu">c</span>(fish_future_raster_files, pred_file_path)</span>
<span id="cb94-81"><a href="#cb94-81" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb94-82"><a href="#cb94-82" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Anemonefish (env-only) prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"at"</span>, pred_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-83"><a href="#cb94-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-84"><a href="#cb94-84" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-85"><a href="#cb94-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-86"><a href="#cb94-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(fish_future_raster_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb94-87"><a href="#cb94-87" aria-hidden="true" tabindex="-1"></a>    fish_pred_stack_future <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(fish_future_raster_files)</span>
<span id="cb94-88"><a href="#cb94-88" aria-hidden="true" tabindex="-1"></a>    fish_richness_sum_future <span class="ot">&lt;-</span> <span class="fu">sum</span>(fish_pred_stack_future, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb94-89"><a href="#cb94-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># names(fish_richness_sum_future) &lt;- paste0("AnemonefishRichness_EnvOnly")</span></span>
<span id="cb94-90"><a href="#cb94-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-91"><a href="#cb94-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb94-92"><a href="#cb94-92" aria-hidden="true" tabindex="-1"></a>      ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb94-93"><a href="#cb94-93" aria-hidden="true" tabindex="-1"></a>      fish_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(fish_richness_sum_future, ip_extent)</span>
<span id="cb94-94"><a href="#cb94-94" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb94-95"><a href="#cb94-95" aria-hidden="true" tabindex="-1"></a>      fish_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> fish_richness_sum_future</span>
<span id="cb94-96"><a href="#cb94-96" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb94-97"><a href="#cb94-97" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Processed anemonefish (env-only) richness for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-98"><a href="#cb94-98" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plotting inside the loop for immediate feedback (optional, can be noisy)</span></span>
<span id="cb94-99"><a href="#cb94-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># if(!is.null(fish_richness_future_list[[scenario_name]])) {</span></span>
<span id="cb94-100"><a href="#cb94-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   plot(fish_richness_future_list[[scenario_name]], </span></span>
<span id="cb94-101"><a href="#cb94-101" aria-hidden="true" tabindex="-1"></a>    <span class="co">#        main = paste("Anemonefish (Env-Only) Richness -", scenario_label_converter[scenario_name]))</span></span>
<span id="cb94-102"><a href="#cb94-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># }</span></span>
<span id="cb94-103"><a href="#cb94-103" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb94-104"><a href="#cb94-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Warning: No anemonefish (env-only) prediction files found for scenario"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb94-105"><a href="#cb94-105" aria-hidden="true" tabindex="-1"></a>    fish_richness_future_list[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Ensure it's NULL</span></span>
<span id="cb94-106"><a href="#cb94-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb94-107"><a href="#cb94-107" aria-hidden="true" tabindex="-1"></a>} <span class="co"># End loop through future scenarios</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Future Scenario: ssp119_2050 ---
  Loading Host Sea Anemone predictions for ssp119_2050 
  Processed host anemone richness for ssp119_2050 
  Loading Anemonefish (Env-Only) predictions for ssp119_2050 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_barberi in ssp119_2050 at /Users/chrisrauch/anemonefish_post_analysis/data/output/predictions/Future/ssp119/mean_pred_Amphiprion_barberi_ssp119_dec50_pca.tif 
  Processed anemonefish (env-only) richness for ssp119_2050 

--- Processing Future Scenario: ssp119_2100 ---
  Loading Host Sea Anemone predictions for ssp119_2100 
  Processed host anemone richness for ssp119_2100 
  Loading Anemonefish (Env-Only) predictions for ssp119_2100 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_barberi in ssp119_2100 at /Users/chrisrauch/anemonefish_post_analysis/data/output/predictions/Future/ssp119/mean_pred_Amphiprion_barberi_ssp119_dec100_pca.tif 
  Processed anemonefish (env-only) richness for ssp119_2100 

--- Processing Future Scenario: ssp585_2050 ---
  Loading Host Sea Anemone predictions for ssp585_2050 
  Processed host anemone richness for ssp585_2050 
  Loading Anemonefish (Env-Only) predictions for ssp585_2050 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_barberi in ssp585_2050 at /Users/chrisrauch/anemonefish_post_analysis/data/output/predictions/Future/ssp585/mean_pred_Amphiprion_barberi_ssp585_dec50_pca.tif 
  Processed anemonefish (env-only) richness for ssp585_2050 

--- Processing Future Scenario: ssp585_2100 ---
  Loading Host Sea Anemone predictions for ssp585_2100 
  Processed host anemone richness for ssp585_2100 
  Loading Anemonefish (Env-Only) predictions for ssp585_2100 
  Warning: Anemonefish (env-only) prediction file not found for Amphiprion_barberi in ssp585_2100 at /Users/chrisrauch/anemonefish_post_analysis/data/output/predictions/Future/ssp585/mean_pred_Amphiprion_barberi_ssp585_dec100_pca.tif 
  Processed anemonefish (env-only) richness for ssp585_2100 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Future species prediction loading and processing finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Future species prediction loading and processing finished. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Final Plots Comparison and Saving ---</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Generating and Saving Final Richness Comparison Plots ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Generating and Saving Final Richness Comparison Plots ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define plot parameters (can be reused or defined in setup)</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>plot_params_richness <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">hcl.colors</span>(<span class="dv">255</span>, <span class="st">"viridis"</span>),</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">plg =</span> <span class="fu">list</span>(<span class="at">loc =</span> <span class="st">"right"</span>, <span class="at">title =</span> <span class="st">"Richness"</span>, <span class="at">cex =</span> <span class="fl">0.9</span>, <span class="at">title.cex=</span><span class="fl">0.9</span>),</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">pax =</span> <span class="fu">list</span>(<span class="at">cex.axis =</span> <span class="fl">0.9</span>, <span class="at">cex.lab=</span><span class="fl">0.9</span>)</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>png_width_map <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>png_height_map <span class="ot">&lt;-</span> <span class="dv">750</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>png_res_map <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper function to plot and save</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>plot_and_save_richness_map <span class="ot">&lt;-</span> <span class="cf">function</span>(raster_obj, main_title, filename_base, subdir) {</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(raster_obj)) {</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot to RMarkdown output</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(raster_obj, <span class="at">main =</span> main_title, <span class="at">col =</span> plot_params_richness<span class="sc">$</span>col, <span class="at">plg =</span> plot_params_richness<span class="sc">$</span>plg, <span class="at">pax =</span> plot_params_richness<span class="sc">$</span>pax)</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Code to save the plot (initially commented out)</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(subdir) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(subdir)) {</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>      plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(subdir, <span class="fu">paste0</span>(filename_base, <span class="st">".png"</span>))</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">png</span>(<span class="at">filename =</span> plot_filename, <span class="at">width =</span> png_width_map, <span class="at">height =</span> png_height_map, <span class="at">units =</span> <span class="st">"px"</span>, <span class="at">res =</span> png_res_map)</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(raster_obj, <span class="at">main =</span> main_title, <span class="at">col =</span> plot_params_richness<span class="sc">$</span>col, <span class="at">plg =</span> plot_params_richness<span class="sc">$</span>plg, <span class="at">pax =</span> plot_params_richness<span class="sc">$</span>pax)</span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">dev.off</span>()</span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  (To save, uncomment code) Plot would be saved to:"</span>, plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  (To save, uncomment code) Warning: Output subdirectory '"</span>, subdir, <span class="st">"' for plot '"</span>, filename_base, <span class="st">"' not available. Plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Skipping plot for '"</span>, main_title, <span class="st">"' as raster object is NULL.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot current richness maps first (assuming host_richness_sum_cropped and fish_richness_sum_cropped are from a previous chunk)</span></span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"host_richness_sum_cropped"</span>)){</span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a>    host_richness_sum_cropped, </span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Host Richness - Current"</span>, </span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"host_richness_current"</span>,</span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>    future_richness_maps_subdir</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  (To save, uncomment code) Plot would be saved to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/future_richness_projections/host_richness_current.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">exists</span>(<span class="st">"fish_richness_sum_cropped"</span>)){</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    fish_richness_sum_cropped, </span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Anemonefish (Env-Only) Richness - Current"</span>, </span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fish_richness_env_only_current"</span>,</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>    future_richness_maps_subdir</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  (To save, uncomment code) Plot would be saved to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/future_richness_projections/fish_richness_env_only_current.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Iterate through the scenarios you want for the final plot grid</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>scenarios_for_grid_plot <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ssp119_2050"</span>, <span class="st">"ssp119_2100"</span>, <span class="st">"ssp585_2050"</span>, <span class="st">"ssp585_2100"</span>)</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scen_name <span class="cf">in</span> scenarios_for_grid_plot) {</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Host plots</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scen_name <span class="sc">%in%</span> <span class="fu">names</span>(host_richness_future_list)) {</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>      host_richness_future_list[[scen_name]], </span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(<span class="st">"Host Richness -"</span>, scenario_label_converter[scen_name]), </span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"host_richness_"</span>, scen_name),</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>      future_richness_maps_subdir</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fish plots</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (scen_name <span class="sc">%in%</span> <span class="fu">names</span>(fish_richness_future_list)) {</span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_and_save_richness_map</span>(</span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>      fish_richness_future_list[[scen_name]], </span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste</span>(<span class="st">"Anemonefish (Env-Only) Richness -"</span>, scenario_label_converter[scen_name]), </span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">paste0</span>(<span class="st">"fish_richness_env_only_"</span>, scen_name),</span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>      future_richness_maps_subdir</span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  (To save, uncomment code) Plot would be saved to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/future_richness_projections/host_richness_ssp119_2050.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  (To save, uncomment code) Plot would be saved to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/future_richness_projections/fish_richness_env_only_ssp119_2050.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-5.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  (To save, uncomment code) Plot would be saved to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/future_richness_projections/host_richness_ssp119_2100.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-6.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  (To save, uncomment code) Plot would be saved to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/future_richness_projections/fish_richness_env_only_ssp119_2100.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-7.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  (To save, uncomment code) Plot would be saved to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/future_richness_projections/host_richness_ssp585_2050.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-8.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  (To save, uncomment code) Plot would be saved to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/future_richness_projections/fish_richness_env_only_ssp585_2050.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-9.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  (To save, uncomment code) Plot would be saved to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/future_richness_projections/host_richness_ssp585_2100.png </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-species-predictions-10.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  (To save, uncomment code) Plot would be saved to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/future_richness_projections/fish_richness_env_only_ssp585_2100.png </code></pre>
</div>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Finished generating final richness comparison plots. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Finished generating final richness comparison plots. ---</code></pre>
</div>
</div>
</section>
<section id="future-environmental-predictors-pca" class="level2">
<h2 class="anchored" data-anchor-id="future-environmental-predictors-pca">Future Environmental Predictors (PCA)</h2>
<p>This section loads the PCA rasters for the future environmental conditions, corresponding to each future scenario and time step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Loading Future Environmental PCA Rasters ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"all_pca_raster_paths"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(all_pca_raster_paths)) {</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'all_pca_raster_paths' not found from previous chunk. Attempting to reload.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)) {</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"PCA raster paths RDS file not found: "</span>, config<span class="sc">$</span>pca_raster_paths_rds_path)</span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>    all_pca_raster_paths <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(config<span class="sc">$</span>pca_raster_paths_rds_path)</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>  env_pca_future_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) { <span class="co"># future_scenarios_to_load from previous chunk</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Loading PCA for future scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>    future_pca_path <span class="ot">&lt;-</span> all_pca_raster_paths[[scenario_name]]</span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(future_pca_path) <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(future_pca_path)) {</span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Path for PCA raster not found for scenario:"</span>, scenario_name, <span class="st">"Path:"</span>, future_pca_path <span class="sc">%||%</span> <span class="st">"NULL"</span>, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a>    env_pca_future_scenario <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">rast</span>(future_pca_path)</span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Error loading PCA raster for"</span>, scenario_name, <span class="st">"from:"</span>, future_pca_path, <span class="st">"</span><span class="sc">\n</span><span class="st">Error:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(env_pca_future_scenario)) {</span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(env_pca_future_scenario) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Future Environmental PC"</span>, <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(env_pca_future_scenario), <span class="st">" - "</span>, scenario_label_converter[scenario_name]) <span class="co"># Ensure standard names</span></span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a>        ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a>        env_pca_future_list[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(env_pca_future_scenario, ip_extent)</span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb115-36"><a href="#cb115-36" aria-hidden="true" tabindex="-1"></a>        env_pca_future_list[[scenario_name]] <span class="ot">&lt;-</span> env_pca_future_scenario</span>
<span id="cb115-37"><a href="#cb115-37" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb115-38"><a href="#cb115-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"    Loaded and processed PCA for"</span>, scenario_name, <span class="st">". Layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(env_pca_future_list[[scenario_name]]), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb115-39"><a href="#cb115-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(env_pca_future_list[[scenario_name]])</span>
<span id="cb115-40"><a href="#cb115-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb115-41"><a href="#cb115-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb115-42"><a href="#cb115-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-43"><a href="#cb115-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># # Example: Plot one of the future PCA stacks</span></span>
<span id="cb115-44"><a href="#cb115-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if (length(env_pca_future_list) &gt; 0 &amp;&amp; "ssp119_2050" %in% names(env_pca_future_list)) {</span></span>
<span id="cb115-45"><a href="#cb115-45" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   plot(env_pca_future_list[["ssp119_2050"]], main = "Future Env PCA - SSP1-1.9 (2050) - Cropped")</span></span>
<span id="cb115-46"><a href="#cb115-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb115-47"><a href="#cb115-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb115-48"><a href="#cb115-48" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb115-49"><a href="#cb115-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- PCA predictors not used. Skipping loading of future PCA rasters. ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb115-50"><a href="#cb115-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    You might need to load your VIF-selected future environmental rasters here if needed for specific analyses.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb115-51"><a href="#cb115-51" aria-hidden="true" tabindex="-1"></a>  env_pca_future_list <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Ensure this object exists as NULL</span></span>
<span id="cb115-52"><a href="#cb115-52" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Future Environmental PCA Rasters ---
  Loading PCA for future scenario: ssp119_2050 
    Loaded and processed PCA for ssp119_2050 . Layers: Future Environmental PC1 - SSP1-1.9 (2050), Future Environmental PC2 - SSP1-1.9 (2050), Future Environmental PC3 - SSP1-1.9 (2050), Future Environmental PC4 - SSP1-1.9 (2050) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-env-pca-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Loading PCA for future scenario: ssp119_2100 
    Loaded and processed PCA for ssp119_2100 . Layers: Future Environmental PC1 - SSP1-1.9 (2100), Future Environmental PC2 - SSP1-1.9 (2100), Future Environmental PC3 - SSP1-1.9 (2100), Future Environmental PC4 - SSP1-1.9 (2100) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-env-pca-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Loading PCA for future scenario: ssp585_2050 
    Loaded and processed PCA for ssp585_2050 . Layers: Future Environmental PC1 - SSP5-8.5 (2050), Future Environmental PC2 - SSP5-8.5 (2050), Future Environmental PC3 - SSP5-8.5 (2050), Future Environmental PC4 - SSP5-8.5 (2050) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-env-pca-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Loading PCA for future scenario: ssp585_2100 
    Loaded and processed PCA for ssp585_2100 . Layers: Future Environmental PC1 - SSP5-8.5 (2100), Future Environmental PC2 - SSP5-8.5 (2100), Future Environmental PC3 - SSP5-8.5 (2100), Future Environmental PC4 - SSP5-8.5 (2100) </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/load-future-env-pca-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The following objects are now available for subsequent analyses:</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - env_pca_current_cropped: SpatRaster of current PCA env predictors</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - host_richness_future_list: List of SpatRasters for host future richness, named by scenario</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - fish_richness_future_list: List of SpatRasters for anemonefish (env-only) future richness, named by scenario</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - env_pca_future_list: List of SpatRasters for future PCA env predictors, named by scenario</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="environmental-shifts-pca-components" class="level2">
<h2 class="anchored" data-anchor-id="environmental-shifts-pca-components">Environmental Shifts (PCA Components)</h2>
<p>This section examines the projected changes in the principal environmental gradients (PCA components) between the current conditions and future climate scenarios. This helps understand how the fundamental environmental space is predicted to change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"PCA predictors not used in this configuration. Skipping PCA environmental shift analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(env_pca_current_cropped) <span class="sc">||</span> <span class="fu">is.null</span>(env_pca_future_list) <span class="sc">||</span> <span class="fu">length</span>(env_pca_future_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Current or future PCA environmental rasters are not available. Cannot calculate shifts.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"--- Calculating and Plotting Shifts in PCA Environmental Gradients ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure current PCA stack is SpatRaster for subtraction</span></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>    current_pca_terra <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="fu">inherits</span>(env_pca_current_cropped, <span class="st">"SpatRaster"</span>)) env_pca_current_cropped <span class="cf">else</span> terra<span class="sc">::</span><span class="fu">rast</span>(env_pca_current_cropped)</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (scenario_name <span class="cf">in</span> <span class="fu">names</span>(env_pca_future_list)) {</span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (scenario_name <span class="sc">==</span> <span class="st">"current"</span>) {</span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Processing shifts for scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a>      future_pca_stack <span class="ot">&lt;-</span> env_pca_future_list[[scenario_name]]</span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(future_pca_stack)) {</span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Skipping scenario"</span>, scenario_name, <span class="st">"- future PCA stack is NULL.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">next</span></span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb121-25"><a href="#cb121-25" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ensure layers match for subtraction (e.g., up to n_pca_components)</span></span>
<span id="cb121-26"><a href="#cb121-26" aria-hidden="true" tabindex="-1"></a>      <span class="co"># It's crucial that both current and future PCA stacks were generated with the same number of components</span></span>
<span id="cb121-27"><a href="#cb121-27" aria-hidden="true" tabindex="-1"></a>      <span class="co"># and represent the same underlying variables in the same order before PCA.</span></span>
<span id="cb121-28"><a href="#cb121-28" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb121-29"><a href="#cb121-29" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If layer names don't match exactly but number of layers does for the first N components:</span></span>
<span id="cb121-30"><a href="#cb121-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(current_pca_terra) <span class="sc">&gt;=</span> config<span class="sc">$</span>n_pca_components <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(future_pca_stack) <span class="sc">&gt;=</span> config<span class="sc">$</span>n_pca_components) {</span>
<span id="cb121-31"><a href="#cb121-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb121-32"><a href="#cb121-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Select the first N components (defined in config)</span></span>
<span id="cb121-33"><a href="#cb121-33" aria-hidden="true" tabindex="-1"></a>        current_pca_subset <span class="ot">&lt;-</span> current_pca_terra[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]]</span>
<span id="cb121-34"><a href="#cb121-34" aria-hidden="true" tabindex="-1"></a>        future_pca_subset <span class="ot">&lt;-</span> future_pca_stack[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]]</span>
<span id="cb121-35"><a href="#cb121-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(current_pca_subset) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components) <span class="co"># Standardize names for safety</span></span>
<span id="cb121-36"><a href="#cb121-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(future_pca_subset) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components)</span>
<span id="cb121-37"><a href="#cb121-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-38"><a href="#cb121-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate the difference (shift)</span></span>
<span id="cb121-39"><a href="#cb121-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># terra::`-.SpatRaster` works element-wise if names match or by layer order if names don't.</span></span>
<span id="cb121-40"><a href="#cb121-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Better to ensure consistent naming (done above)</span></span>
<span id="cb121-41"><a href="#cb121-41" aria-hidden="true" tabindex="-1"></a>        env_shift_scenario <span class="ot">&lt;-</span> future_pca_subset <span class="sc">-</span> current_pca_subset </span>
<span id="cb121-42"><a href="#cb121-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(env_shift_scenario) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Environmental PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components, <span class="st">" Shifts (Future - Current): "</span>, scenario_label_converter[scenario_name])</span>
<span id="cb121-43"><a href="#cb121-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb121-44"><a href="#cb121-44" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Calculated PCA shifts for scenario:"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-45"><a href="#cb121-45" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plot</span>(env_shift_scenario, <span class="at">nc =</span> <span class="dv">2</span>)</span>
<span id="cb121-46"><a href="#cb121-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb121-47"><a href="#cb121-47" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb121-48"><a href="#cb121-48" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Layer mismatch or insufficient layers for PCA shift calculation in scenario"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-49"><a href="#cb121-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Current PCA layers:"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(current_pca_terra), <span class="st">" Future PCA layers:"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(future_pca_stack), <span class="st">" Needed:"</span>, config<span class="sc">$</span>n_pca_components, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb121-50"><a href="#cb121-50" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb121-51"><a href="#cb121-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb121-52"><a href="#cb121-52" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb121-53"><a href="#cb121-53" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calculating and Plotting Shifts in PCA Environmental Gradients ---
  Processing shifts for scenario: ssp119_2050 
    Calculated PCA shifts for scenario: ssp119_2050 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plot-environmental-pca-shifts-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Processing shifts for scenario: ssp119_2100 
    Calculated PCA shifts for scenario: ssp119_2100 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plot-environmental-pca-shifts-2.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Processing shifts for scenario: ssp585_2050 
    Calculated PCA shifts for scenario: ssp585_2050 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plot-environmental-pca-shifts-3.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Processing shifts for scenario: ssp585_2100 
    Calculated PCA shifts for scenario: ssp585_2100 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plot-environmental-pca-shifts-4.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="load-future-individual-species-prediction-rasters" class="level2">
<h2 class="anchored" data-anchor-id="load-future-individual-species-prediction-rasters">Load Future Individual Species Prediction Rasters</h2>
<p>This section loads the individual species prediction rasters for host sea anemones and anemonefish (environmental-only models) for each future scenario. These are needed for calculating Schoener’s D overlap and individual suitability shifts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># future_scenarios_to_load was defined in the "Future Species Richness Projections" chunk</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"future_scenarios_to_load"</span>)) {</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>  future_scenarios_to_load <span class="ot">&lt;-</span> config<span class="sc">$</span>env_scenarios[config<span class="sc">$</span>env_scenarios <span class="sc">!=</span> <span class="st">"current"</span>]</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a><span class="co"># predictor_suffix was defined in the "Drivers of Richness" chunk</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"predictor_suffix"</span>)) {</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>  predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a>host_pred_stacks_future_individual <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a>fish_pred_stacks_future_individual <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># For env-only fish models</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-15"><a href="#cb126-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb126-16"><a href="#cb126-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Loading individual future predictions for Scenario:"</span>, scenario_name, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb126-17"><a href="#cb126-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb126-18"><a href="#cb126-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Host Anemones ---</span></span>
<span id="cb126-19"><a href="#cb126-19" aria-hidden="true" tabindex="-1"></a>  current_host_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb126-20"><a href="#cb126-20" aria-hidden="true" tabindex="-1"></a>  current_host_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb126-21"><a href="#cb126-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"anemone_species_df"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemone_species_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb126-22"><a href="#cb126-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemone_species_df)) {</span>
<span id="cb126-23"><a href="#cb126-23" aria-hidden="true" tabindex="-1"></a>      sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemone_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb126-24"><a href="#cb126-24" aria-hidden="true" tabindex="-1"></a>      pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_prediction_filename</span>(</span>
<span id="cb126-25"><a href="#cb126-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb126-26"><a href="#cb126-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb126-27"><a href="#cb126-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">predictor_type_suffix =</span> predictor_suffix,</span>
<span id="cb126-28"><a href="#cb126-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">config =</span> config</span>
<span id="cb126-29"><a href="#cb126-29" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb126-30"><a href="#cb126-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb126-31"><a href="#cb126-31" aria-hidden="true" tabindex="-1"></a>        current_host_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>(current_host_future_files, pred_file_path)</span>
<span id="cb126-32"><a href="#cb126-32" aria-hidden="true" tabindex="-1"></a>        current_host_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>(current_host_future_names, sp_name_sanitized)</span>
<span id="cb126-33"><a href="#cb126-33" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb126-34"><a href="#cb126-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Host future prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb126-35"><a href="#cb126-35" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb126-36"><a href="#cb126-36" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-37"><a href="#cb126-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(current_host_future_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb126-38"><a href="#cb126-38" aria-hidden="true" tabindex="-1"></a>      temp_stack <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(current_host_future_files)</span>
<span id="cb126-39"><a href="#cb126-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(temp_stack) <span class="ot">&lt;-</span> current_host_future_names</span>
<span id="cb126-40"><a href="#cb126-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb126-41"><a href="#cb126-41" aria-hidden="true" tabindex="-1"></a>        ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb126-42"><a href="#cb126-42" aria-hidden="true" tabindex="-1"></a>        host_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(temp_stack, ip_extent)</span>
<span id="cb126-43"><a href="#cb126-43" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb126-44"><a href="#cb126-44" aria-hidden="true" tabindex="-1"></a>        host_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> temp_stack</span>
<span id="cb126-45"><a href="#cb126-45" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb126-46"><a href="#cb126-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Loaded and cropped"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stacks_future_individual[[scenario_name]]), <span class="st">"host future predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb126-47"><a href="#cb126-47" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb126-48"><a href="#cb126-48" aria-hidden="true" tabindex="-1"></a>       host_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb126-49"><a href="#cb126-49" aria-hidden="true" tabindex="-1"></a>       <span class="fu">cat</span>(<span class="st">"  No host future prediction files found for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb126-50"><a href="#cb126-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-51"><a href="#cb126-51" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb126-52"><a href="#cb126-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-53"><a href="#cb126-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Anemonefish (Environmental-Only) ---</span></span>
<span id="cb126-54"><a href="#cb126-54" aria-hidden="true" tabindex="-1"></a>  current_fish_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb126-55"><a href="#cb126-55" aria-hidden="true" tabindex="-1"></a>  current_fish_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb126-56"><a href="#cb126-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"anemonefish_species_df"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(anemonefish_species_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb126-57"><a href="#cb126-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(anemonefish_species_df)) {</span>
<span id="cb126-58"><a href="#cb126-58" aria-hidden="true" tabindex="-1"></a>      sp_name_sanitized <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_df<span class="sc">$</span>scientificName[i])</span>
<span id="cb126-59"><a href="#cb126-59" aria-hidden="true" tabindex="-1"></a>      pred_file_path <span class="ot">&lt;-</span> <span class="fu">construct_prediction_filename</span>(</span>
<span id="cb126-60"><a href="#cb126-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">species_name_sanitized =</span> sp_name_sanitized,</span>
<span id="cb126-61"><a href="#cb126-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">scenario_name =</span> scenario_name,</span>
<span id="cb126-62"><a href="#cb126-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">predictor_type_suffix =</span> predictor_suffix, </span>
<span id="cb126-63"><a href="#cb126-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">config =</span> config</span>
<span id="cb126-64"><a href="#cb126-64" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb126-65"><a href="#cb126-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">file.exists</span>(pred_file_path)) {</span>
<span id="cb126-66"><a href="#cb126-66" aria-hidden="true" tabindex="-1"></a>        current_fish_future_files <span class="ot">&lt;-</span> <span class="fu">c</span>(current_fish_future_files, pred_file_path)</span>
<span id="cb126-67"><a href="#cb126-67" aria-hidden="true" tabindex="-1"></a>        current_fish_future_names <span class="ot">&lt;-</span> <span class="fu">c</span>(current_fish_future_names, sp_name_sanitized)</span>
<span id="cb126-68"><a href="#cb126-68" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb126-69"><a href="#cb126-69" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Anemonefish (env-only) future prediction file not found for"</span>, sp_name_sanitized, <span class="st">"in"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb126-70"><a href="#cb126-70" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb126-71"><a href="#cb126-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-72"><a href="#cb126-72" aria-hidden="true" tabindex="-1"></a>     <span class="cf">if</span> (<span class="fu">length</span>(current_fish_future_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb126-73"><a href="#cb126-73" aria-hidden="true" tabindex="-1"></a>      temp_stack_fish <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">rast</span>(current_fish_future_files)</span>
<span id="cb126-74"><a href="#cb126-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(temp_stack_fish) <span class="ot">&lt;-</span> current_fish_future_names</span>
<span id="cb126-75"><a href="#cb126-75" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (config<span class="sc">$</span>apply_indo_pacific_crop) {</span>
<span id="cb126-76"><a href="#cb126-76" aria-hidden="true" tabindex="-1"></a>        ip_extent <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">ext</span>(config<span class="sc">$</span>indo_pacific_bbox)</span>
<span id="cb126-77"><a href="#cb126-77" aria-hidden="true" tabindex="-1"></a>        fish_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">crop</span>(temp_stack_fish, ip_extent)</span>
<span id="cb126-78"><a href="#cb126-78" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb126-79"><a href="#cb126-79" aria-hidden="true" tabindex="-1"></a>        fish_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> temp_stack_fish</span>
<span id="cb126-80"><a href="#cb126-80" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb126-81"><a href="#cb126-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Loaded and cropped"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stacks_future_individual[[scenario_name]]), <span class="st">"anemonefish (env-only) future predictions for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb126-82"><a href="#cb126-82" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb126-83"><a href="#cb126-83" aria-hidden="true" tabindex="-1"></a>       fish_pred_stacks_future_individual[[scenario_name]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb126-84"><a href="#cb126-84" aria-hidden="true" tabindex="-1"></a>       <span class="fu">cat</span>(<span class="st">"  No anemonefish (env-only) future prediction files found for"</span>, scenario_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb126-85"><a href="#cb126-85" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb126-86"><a href="#cb126-86" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb126-87"><a href="#cb126-87" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Loading individual future predictions for Scenario: ssp119_2050 ---
  Loaded and cropped 9 host future predictions for ssp119_2050 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_barberi in ssp119_2050 
  Loaded and cropped 9 anemonefish (env-only) future predictions for ssp119_2050 

--- Loading individual future predictions for Scenario: ssp119_2100 ---
  Loaded and cropped 9 host future predictions for ssp119_2100 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_barberi in ssp119_2100 
  Loaded and cropped 9 anemonefish (env-only) future predictions for ssp119_2100 

--- Loading individual future predictions for Scenario: ssp585_2050 ---
  Loaded and cropped 9 host future predictions for ssp585_2050 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_barberi in ssp585_2050 
  Loaded and cropped 9 anemonefish (env-only) future predictions for ssp585_2050 

--- Loading individual future predictions for Scenario: ssp585_2100 ---
  Loaded and cropped 9 host future predictions for ssp585_2100 
  Warning: Anemonefish (env-only) future prediction file not found for Amphiprion_barberi in ssp585_2100 
  Loaded and cropped 9 anemonefish (env-only) future predictions for ssp585_2100 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Result: host_pred_stacks_future_individual and fish_pred_stacks_future_individual</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="co"># are lists of SpatRasters, named by scenario, containing individual species layers.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="individual-species-suitability-shifts" class="level2">
<h2 class="anchored" data-anchor-id="individual-species-suitability-shifts">Individual Species Suitability Shifts</h2>
<p>This section calculates the mean change in environmental suitability for each individual host sea anemone and anemonefish species between the current period and each future climate scenario. These shift values will be used to explore correlations with niche breadth.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prerequisites from previous chunks:</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="co"># - host_pred_stack_cropped: Current individual host predictions (cropped)</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a><span class="co"># - fish_pred_stack_cropped: Current individual fish (env-only) predictions (cropped)</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a><span class="co"># - host_pred_stacks_future_individual: List of future individual host predictions (cropped), named by scenario</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a><span class="co"># - fish_pred_stacks_future_individual: List of future individual fish (env-only) predictions (cropped), named by scenario</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a><span class="co"># - future_scenarios_to_load: Vector of future scenario names (e.g., "ssp119_2050", "ssp585_2100")</span></span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_pred_stack_cropped"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_pred_stack_cropped"</span>) <span class="sc">||</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_pred_stacks_future_individual"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_pred_stacks_future_individual"</span>) <span class="sc">||</span></span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"future_scenarios_to_load"</span>)) {</span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Prerequisite data for calculating suitability shifts is missing. Ensure previous chunks (loading current and future individual predictions) have run successfully."</span>)</span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>suitability_shifts_list <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># Initialize list to store results for all species and scenarios</span></span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Calculating Mean Suitability Shifts for Individual Species ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calculating Mean Suitability Shifts for Individual Species ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (scenario_name_fut <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">  Processing Scenario:"</span>, scenario_name_fut, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Host Anemones Suitability Shifts ---</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    Calculating shifts for Host Anemones...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>  current_hosts_for_diff <span class="ot">&lt;-</span> host_pred_stack_cropped</span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a>  future_hosts_for_diff_raw <span class="ot">&lt;-</span> host_pred_stacks_future_individual[[scenario_name_fut]]</span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(current_hosts_for_diff) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(future_hosts_for_diff_raw) <span class="sc">&amp;&amp;</span> </span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">nlyr</span>(current_hosts_for_diff) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(future_hosts_for_diff_raw) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb131-11"><a href="#cb131-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-12"><a href="#cb131-12" aria-hidden="true" tabindex="-1"></a>    common_host_species <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(current_hosts_for_diff), <span class="fu">names</span>(future_hosts_for_diff_raw))</span>
<span id="cb131-13"><a href="#cb131-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-14"><a href="#cb131-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(common_host_species) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb131-15"><a href="#cb131-15" aria-hidden="true" tabindex="-1"></a>      current_hosts_subset <span class="ot">&lt;-</span> current_hosts_for_diff[[common_host_species]]</span>
<span id="cb131-16"><a href="#cb131-16" aria-hidden="true" tabindex="-1"></a>      future_hosts_subset_raw <span class="ot">&lt;-</span> future_hosts_for_diff_raw[[common_host_species]]</span>
<span id="cb131-17"><a href="#cb131-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-18"><a href="#cb131-18" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Ensure geometry matches for subtraction by resampling future to current if needed</span></span>
<span id="cb131-19"><a href="#cb131-19" aria-hidden="true" tabindex="-1"></a>      future_hosts_subset_aligned <span class="ot">&lt;-</span> future_hosts_subset_raw</span>
<span id="cb131-20"><a href="#cb131-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(current_hosts_subset, future_hosts_subset_raw, <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>, <span class="at">ext=</span><span class="cn">TRUE</span>)){</span>
<span id="cb131-21"><a href="#cb131-21" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"      Resampling future host predictions for scenario '"</span>, scenario_name_fut, <span class="st">"' to match current geometry for shift calculation.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-22"><a href="#cb131-22" aria-hidden="true" tabindex="-1"></a>          future_hosts_subset_aligned <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb131-23"><a href="#cb131-23" aria-hidden="true" tabindex="-1"></a>            terra<span class="sc">::</span><span class="fu">resample</span>(future_hosts_subset_raw, current_hosts_subset, <span class="at">method=</span><span class="st">"bilinear"</span>),</span>
<span id="cb131-24"><a href="#cb131-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb131-25"><a href="#cb131-25" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"      ERROR resampling future host stack for"</span>, scenario_name_fut, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb131-26"><a href="#cb131-26" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb131-27"><a href="#cb131-27" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb131-28"><a href="#cb131-28" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb131-29"><a href="#cb131-29" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-30"><a href="#cb131-30" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(future_hosts_subset_aligned)) {</span>
<span id="cb131-31"><a href="#cb131-31" aria-hidden="true" tabindex="-1"></a>        diff_hosts_scenario_indiv <span class="ot">&lt;-</span> future_hosts_subset_aligned <span class="sc">-</span> current_hosts_subset</span>
<span id="cb131-32"><a href="#cb131-32" aria-hidden="true" tabindex="-1"></a>        mean_shifts_hosts_indiv <span class="ot">&lt;-</span> <span class="fu">global</span>(diff_hosts_scenario_indiv, <span class="st">"mean"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb131-33"><a href="#cb131-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(mean_shifts_hosts_indiv) <span class="ot">&lt;-</span> <span class="fu">names</span>(diff_hosts_scenario_indiv) <span class="co"># Should be common_host_species</span></span>
<span id="cb131-34"><a href="#cb131-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb131-35"><a href="#cb131-35" aria-hidden="true" tabindex="-1"></a>        suitability_shifts_list[[<span class="fu">paste0</span>(<span class="st">"hosts_"</span>, scenario_name_fut)]] <span class="ot">&lt;-</span> mean_shifts_hosts_indiv</span>
<span id="cb131-36"><a href="#cb131-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"      Mean suitability shifts for hosts in"</span>, scenario_name_fut, <span class="st">"calculated.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-37"><a href="#cb131-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(head(mean_shifts_hosts_indiv)) </span></span>
<span id="cb131-38"><a href="#cb131-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb131-39"><a href="#cb131-39" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb131-40"><a href="#cb131-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"      No common host species found between current and future stacks for scenario"</span>, scenario_name_fut, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-41"><a href="#cb131-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb131-42"><a href="#cb131-42" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb131-43"><a href="#cb131-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"    Skipping host anemones for scenario"</span>, scenario_name_fut, <span class="st">"- current or future individual prediction stack missing or empty.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-44"><a href="#cb131-44" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-45"><a href="#cb131-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-46"><a href="#cb131-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Anemonefish (Environmental-Only Models) Suitability Shifts ---</span></span>
<span id="cb131-47"><a href="#cb131-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"    Calculating shifts for Anemonefish (Env-Only)...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-48"><a href="#cb131-48" aria-hidden="true" tabindex="-1"></a>  current_fish_for_diff <span class="ot">&lt;-</span> fish_pred_stack_cropped </span>
<span id="cb131-49"><a href="#cb131-49" aria-hidden="true" tabindex="-1"></a>  future_fish_for_diff_raw <span class="ot">&lt;-</span> fish_pred_stacks_future_individual[[scenario_name_fut]] </span>
<span id="cb131-50"><a href="#cb131-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-51"><a href="#cb131-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(current_fish_for_diff) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(future_fish_for_diff_raw) <span class="sc">&amp;&amp;</span></span>
<span id="cb131-52"><a href="#cb131-52" aria-hidden="true" tabindex="-1"></a>      terra<span class="sc">::</span><span class="fu">nlyr</span>(current_fish_for_diff) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(future_fish_for_diff_raw) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb131-53"><a href="#cb131-53" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-54"><a href="#cb131-54" aria-hidden="true" tabindex="-1"></a>    common_fish_species <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">names</span>(current_fish_for_diff), <span class="fu">names</span>(future_fish_for_diff_raw))</span>
<span id="cb131-55"><a href="#cb131-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb131-56"><a href="#cb131-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(common_fish_species) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb131-57"><a href="#cb131-57" aria-hidden="true" tabindex="-1"></a>      current_fish_subset <span class="ot">&lt;-</span> current_fish_for_diff[[common_fish_species]]</span>
<span id="cb131-58"><a href="#cb131-58" aria-hidden="true" tabindex="-1"></a>      future_fish_subset_raw <span class="ot">&lt;-</span> future_fish_for_diff_raw[[common_fish_species]]</span>
<span id="cb131-59"><a href="#cb131-59" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-60"><a href="#cb131-60" aria-hidden="true" tabindex="-1"></a>      future_fish_subset_aligned <span class="ot">&lt;-</span> future_fish_subset_raw</span>
<span id="cb131-61"><a href="#cb131-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(current_fish_subset, future_fish_subset_raw, <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>, <span class="at">ext=</span><span class="cn">TRUE</span>)){</span>
<span id="cb131-62"><a href="#cb131-62" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"      Resampling future fish (env-only) predictions for scenario '"</span>, scenario_name_fut, <span class="st">"' to match current geometry.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-63"><a href="#cb131-63" aria-hidden="true" tabindex="-1"></a>         future_fish_subset_aligned <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb131-64"><a href="#cb131-64" aria-hidden="true" tabindex="-1"></a>            terra<span class="sc">::</span><span class="fu">resample</span>(future_fish_subset_raw, current_fish_subset, <span class="at">method=</span><span class="st">"bilinear"</span>),</span>
<span id="cb131-65"><a href="#cb131-65" aria-hidden="true" tabindex="-1"></a>            <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb131-66"><a href="#cb131-66" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"      ERROR resampling future fish stack for"</span>, scenario_name_fut, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb131-67"><a href="#cb131-67" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb131-68"><a href="#cb131-68" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb131-69"><a href="#cb131-69" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb131-70"><a href="#cb131-70" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb131-71"><a href="#cb131-71" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(future_fish_subset_aligned)) {</span>
<span id="cb131-72"><a href="#cb131-72" aria-hidden="true" tabindex="-1"></a>        diff_fish_scenario_indiv <span class="ot">&lt;-</span> future_fish_subset_aligned <span class="sc">-</span> current_fish_subset</span>
<span id="cb131-73"><a href="#cb131-73" aria-hidden="true" tabindex="-1"></a>        mean_shifts_fish_indiv <span class="ot">&lt;-</span> <span class="fu">global</span>(diff_fish_scenario_indiv, <span class="st">"mean"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb131-74"><a href="#cb131-74" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rownames</span>(mean_shifts_fish_indiv) <span class="ot">&lt;-</span> <span class="fu">names</span>(diff_fish_scenario_indiv)</span>
<span id="cb131-75"><a href="#cb131-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb131-76"><a href="#cb131-76" aria-hidden="true" tabindex="-1"></a>        suitability_shifts_list[[<span class="fu">paste0</span>(<span class="st">"fish_env_only_"</span>, scenario_name_fut)]] <span class="ot">&lt;-</span> mean_shifts_fish_indiv</span>
<span id="cb131-77"><a href="#cb131-77" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"      Mean suitability shifts for anemonefish (env-only) in"</span>, scenario_name_fut, <span class="st">"calculated.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-78"><a href="#cb131-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(head(mean_shifts_fish_indiv)) </span></span>
<span id="cb131-79"><a href="#cb131-79" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb131-80"><a href="#cb131-80" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb131-81"><a href="#cb131-81" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"      No common anemonefish species found between current and future stacks for scenario"</span>, scenario_name_fut, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-82"><a href="#cb131-82" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb131-83"><a href="#cb131-83" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb131-84"><a href="#cb131-84" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"    Skipping anemonefish (env-only) for scenario"</span>, scenario_name_fut, <span class="st">"- current or future individual prediction stack missing or empty.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb131-85"><a href="#cb131-85" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb131-86"><a href="#cb131-86" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb131-87"><a href="#cb131-87" aria-hidden="true" tabindex="-1"></a>} <span class="co"># End loop through future scenarios</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
  Processing Scenario: ssp119_2050 
    Calculating shifts for Host Anemones...

|---------|---------|---------|---------|
=========================================
                                          
      Mean suitability shifts for hosts in ssp119_2050 calculated.
    Calculating shifts for Anemonefish (Env-Only)...

|---------|---------|---------|---------|
=========================================
                                          
      Mean suitability shifts for anemonefish (env-only) in ssp119_2050 calculated.

  Processing Scenario: ssp119_2100 
    Calculating shifts for Host Anemones...

|---------|---------|---------|---------|
=========================================
                                          
      Mean suitability shifts for hosts in ssp119_2100 calculated.
    Calculating shifts for Anemonefish (Env-Only)...

|---------|---------|---------|---------|
=========================================
                                          
      Mean suitability shifts for anemonefish (env-only) in ssp119_2100 calculated.

  Processing Scenario: ssp585_2050 
    Calculating shifts for Host Anemones...

|---------|---------|---------|---------|
=========================================
                                          
      Mean suitability shifts for hosts in ssp585_2050 calculated.
    Calculating shifts for Anemonefish (Env-Only)...

|---------|---------|---------|---------|
=========================================
                                          
      Mean suitability shifts for anemonefish (env-only) in ssp585_2050 calculated.

  Processing Scenario: ssp585_2100 
    Calculating shifts for Host Anemones...

|---------|---------|---------|---------|
=========================================
                                          
      Mean suitability shifts for hosts in ssp585_2100 calculated.
    Calculating shifts for Anemonefish (Env-Only)...

|---------|---------|---------|---------|
=========================================
                                          
      Mean suitability shifts for anemonefish (env-only) in ssp585_2100 calculated.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Individual species suitability shift calculations finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Individual species suitability shift calculations finished. ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>suitability_shifts_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$hosts_ssp119_2050
                                  mean
Entacmaea_quadricolor    -4.536062e-03
Radianthus_crispa        -4.662851e-03
Radianthus_magnifica      1.172640e-03
Stichodactyla_gigantea   -9.529433e-05
Cryptodendrum_adhaesivum -8.915561e-04
Macrodactyla_doreensis   -1.270136e-04
Stichodactyla_mertensii  -3.073683e-03
Stichodactyla_haddoni    -1.524180e-03
Heteractis_aurora        -1.410738e-04

$fish_env_only_ssp119_2050
                                 mean
Amphiprion_clarkii      -0.0016777802
Amphiprion_frenatus     -0.0015232340
Amphiprion_ocellaris     0.0028460673
Amphiprion_perideraion  -0.0021970801
Amphiprion_sandaracinos  0.0002772930
Amphiprion_bicinctus     0.0002352739
Amphiprion_melanopus    -0.0033482281
Amphiprion_percula      -0.0061419656
Premnas_biaculeatus      0.0004029825

$hosts_ssp119_2100
                                  mean
Entacmaea_quadricolor    -5.777601e-03
Radianthus_crispa        -5.393897e-03
Radianthus_magnifica      2.408147e-03
Stichodactyla_gigantea   -3.060088e-05
Cryptodendrum_adhaesivum -8.644091e-04
Macrodactyla_doreensis    3.262492e-04
Stichodactyla_mertensii  -3.442731e-03
Stichodactyla_haddoni    -6.425685e-04
Heteractis_aurora        -6.388889e-04

$fish_env_only_ssp119_2100
                                 mean
Amphiprion_clarkii      -0.0010189554
Amphiprion_frenatus     -0.0016409124
Amphiprion_ocellaris     0.0034756333
Amphiprion_perideraion  -0.0010267538
Amphiprion_sandaracinos  0.0012590236
Amphiprion_bicinctus     0.0002839565
Amphiprion_melanopus    -0.0027597337
Amphiprion_percula      -0.0102454760
Premnas_biaculeatus      0.0014646876

$hosts_ssp585_2050
                                  mean
Entacmaea_quadricolor    -4.168010e-03
Radianthus_crispa        -4.332400e-03
Radianthus_magnifica      1.685420e-03
Stichodactyla_gigantea   -4.299020e-04
Cryptodendrum_adhaesivum -2.721739e-04
Macrodactyla_doreensis    2.342935e-04
Stichodactyla_mertensii  -3.458064e-03
Stichodactyla_haddoni    -2.721121e-03
Heteractis_aurora         9.896881e-05

$fish_env_only_ssp585_2050
                                mean
Amphiprion_clarkii      -0.001508720
Amphiprion_frenatus     -0.001463652
Amphiprion_ocellaris     0.003555805
Amphiprion_perideraion  -0.001297647
Amphiprion_sandaracinos  0.003035596
Amphiprion_bicinctus     0.000439413
Amphiprion_melanopus    -0.003083692
Amphiprion_percula      -0.003375181
Premnas_biaculeatus      0.003149470

$hosts_ssp585_2100
                                 mean
Entacmaea_quadricolor    -0.004510062
Radianthus_crispa        -0.002180768
Radianthus_magnifica      0.007370588
Stichodactyla_gigantea   -0.002440418
Cryptodendrum_adhaesivum  0.005271087
Macrodactyla_doreensis    0.003954837
Stichodactyla_mertensii  -0.006779451
Stichodactyla_haddoni    -0.005802261
Heteractis_aurora         0.002226292

$fish_env_only_ssp585_2100
                                 mean
Amphiprion_clarkii      -0.0009159086
Amphiprion_frenatus     -0.0016335876
Amphiprion_ocellaris     0.0080385175
Amphiprion_perideraion   0.0070513576
Amphiprion_sandaracinos  0.0287485786
Amphiprion_bicinctus     0.0031309800
Amphiprion_melanopus     0.0013309397
Amphiprion_percula       0.0155467408
Premnas_biaculeatus      0.0301523107</code></pre>
</div>
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The `suitability_shifts_list` object is now populated.</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Example access: suitability_shifts_list[["hosts_ssp119_2050"]]</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a><span class="co"># It will contain data frames with rownames = species_name_sanitized and a column "mean" for the shift.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="future-host-anemonefish-overlap-changes-by-specialization" class="level2">
<h2 class="anchored" data-anchor-id="future-host-anemonefish-overlap-changes-by-specialization">Future Host-Anemonefish Overlap Changes by Specialization</h2>
<p>This section analyzes the projected changes in niche overlap (Schoener’s D) between anemonefish and their host anemones under future climate scenarios, considering the specialization strategy of the anemonefish. For <strong>Specialist</strong> anemonefish (≤3 documented hosts), we calculate the change in overlap with their specific documented host(s). If a specialist uses multiple hosts (2 or 3), the average overlap change is considered. For <strong>Generalist</strong> anemonefish (&gt;3 documented hosts), we calculate the change in overlap with a composite raster representing the presence of <em>any</em> of their documented host anemones. This approach aims to quantify how the availability of suitable host partners might change differently for specialist versus generalist anemonefish.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co"> FIX THIS</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan) <span class="co"># For varpart</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure dplyr and terra are loaded from setup chunk if not re-loaded here</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(host_richness_sum_cropped) <span class="sc">||</span> <span class="fu">is.null</span>(fish_richness_sum_cropped) <span class="sc">||</span> </span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">is.null</span>(env_pca_current_cropped))) {</span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: Necessary raster data (host richness, fish richness, or current PCA env) is missing. Skipping variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Preparing Data for Variance Partitioning ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>  layers_for_sampling <span class="ot">&lt;-</span> <span class="fu">c</span>(host_richness_sum_cropped, fish_richness_sum_cropped)</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(env_pca_current_cropped)) {</span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(layers_for_sampling[[<span class="dv">1</span>]], env_pca_current_cropped[[<span class="dv">1</span>]], <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>)) {</span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>       <span class="fu">cat</span>(<span class="st">"  Resampling current PCA environmental layers to match richness map geometry for sampling...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-17"><a href="#cb138-17" aria-hidden="true" tabindex="-1"></a>       env_pca_current_resampled <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb138-18"><a href="#cb138-18" aria-hidden="true" tabindex="-1"></a>         terra<span class="sc">::</span><span class="fu">resample</span>(env_pca_current_cropped, layers_for_sampling[[<span class="dv">1</span>]], <span class="at">method=</span><span class="st">"bilinear"</span>)</span>
<span id="cb138-19"><a href="#cb138-19" aria-hidden="true" tabindex="-1"></a>       }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb138-20"><a href="#cb138-20" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"  Warning: Failed to resample PCA env layers:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb138-21"><a href="#cb138-21" aria-hidden="true" tabindex="-1"></a>       })</span>
<span id="cb138-22"><a href="#cb138-22" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(env_pca_current_resampled)) {</span>
<span id="cb138-23"><a href="#cb138-23" aria-hidden="true" tabindex="-1"></a>         env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_resampled</span>
<span id="cb138-24"><a href="#cb138-24" aria-hidden="true" tabindex="-1"></a>       } <span class="cf">else</span> {</span>
<span id="cb138-25"><a href="#cb138-25" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"  Using un-resampled PCA env. May lead to issues if extents differ significantly.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-26"><a href="#cb138-26" aria-hidden="true" tabindex="-1"></a>         env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_cropped</span>
<span id="cb138-27"><a href="#cb138-27" aria-hidden="true" tabindex="-1"></a>       }</span>
<span id="cb138-28"><a href="#cb138-28" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb138-29"><a href="#cb138-29" aria-hidden="true" tabindex="-1"></a>      env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_cropped</span>
<span id="cb138-30"><a href="#cb138-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb138-31"><a href="#cb138-31" aria-hidden="true" tabindex="-1"></a>    layers_for_sampling <span class="ot">&lt;-</span> <span class="fu">c</span>(layers_for_sampling, env_pca_current_for_sampling[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]]) </span>
<span id="cb138-32"><a href="#cb138-32" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb138-33"><a href="#cb138-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Variance partitioning without PCA environmental layers is not fully implemented here. Please adapt if using VIF-selected vars.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-34"><a href="#cb138-34" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb138-35"><a href="#cb138-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-36"><a href="#cb138-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling) <span class="sc">&lt;</span> <span class="dv">3</span>) {</span>
<span id="cb138-37"><a href="#cb138-37" aria-hidden="true" tabindex="-1"></a>     <span class="fu">cat</span>(<span class="st">"Error: Need at least host richness, fish richness, and one environmental layer for variance partitioning. Found:"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling), <span class="st">"layers.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-38"><a href="#cb138-38" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb138-39"><a href="#cb138-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(layers_for_sampling)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"HostRichness"</span></span>
<span id="cb138-40"><a href="#cb138-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(layers_for_sampling)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"FishRichness_EnvOnly"</span></span>
<span id="cb138-41"><a href="#cb138-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb138-42"><a href="#cb138-42" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(layers_for_sampling)[<span class="dv">3</span><span class="sc">:</span>(<span class="dv">2</span><span class="sc">+</span>config<span class="sc">$</span>n_pca_components)] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components)</span>
<span id="cb138-43"><a href="#cb138-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb138-44"><a href="#cb138-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-45"><a href="#cb138-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Stack for sampling has layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(layers_for_sampling), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-46"><a href="#cb138-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb138-47"><a href="#cb138-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">123</span>) </span>
<span id="cb138-48"><a href="#cb138-48" aria-hidden="true" tabindex="-1"></a>    mask_all_valid <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(layers_for_sampling)) <span class="sc">==</span> <span class="fu">nlyr</span>(layers_for_sampling)</span>
<span id="cb138-49"><a href="#cb138-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">global</span>(mask_all_valid, <span class="st">"sum"</span>, <span class="at">na.rm=</span>T)<span class="sc">$</span>sum <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb138-50"><a href="#cb138-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No cells where all predictor layers for variance partitioning have valid data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-51"><a href="#cb138-51" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb138-52"><a href="#cb138-52" aria-hidden="true" tabindex="-1"></a>      bg_points_sampled_varpart <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">spatSample</span>(mask_all_valid, <span class="dv">5000</span>, <span class="at">method =</span> <span class="st">"random"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">warn=</span><span class="cn">FALSE</span>)</span>
<span id="cb138-53"><a href="#cb138-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Sampled"</span>, <span class="fu">nrow</span>(bg_points_sampled_varpart), <span class="st">"points for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-54"><a href="#cb138-54" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-55"><a href="#cb138-55" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(layers_for_sampling, bg_points_sampled_varpart[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)], <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb138-56"><a href="#cb138-56" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df_sampled_values)</span>
<span id="cb138-57"><a href="#cb138-57" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(df_sampled_values) </span>
<span id="cb138-58"><a href="#cb138-58" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-59"><a href="#cb138-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Using"</span>, <span class="fu">nrow</span>(df_sampled_values), <span class="st">"complete cases for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-60"><a href="#cb138-60" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb138-61"><a href="#cb138-61" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">nrow</span>(df_sampled_values) <span class="sc">&gt;</span> <span class="dv">10</span> <span class="sc">&amp;&amp;</span> <span class="st">"HostRichness"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values) <span class="sc">&amp;&amp;</span> <span class="st">"FishRichness_EnvOnly"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values) <span class="sc">&amp;&amp;</span> </span>
<span id="cb138-62"><a href="#cb138-62" aria-hidden="true" tabindex="-1"></a>          ( (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(df_sampled_values) <span class="sc">&gt;</span> <span class="dv">2</span>) <span class="sc">||</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components) <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values))) )</span>
<span id="cb138-63"><a href="#cb138-63" aria-hidden="true" tabindex="-1"></a>         ) {</span>
<span id="cb138-64"><a href="#cb138-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb138-65"><a href="#cb138-65" aria-hidden="true" tabindex="-1"></a>        fish_richness_response <span class="ot">&lt;-</span> df_sampled_values<span class="sc">$</span>FishRichness_EnvOnly</span>
<span id="cb138-66"><a href="#cb138-66" aria-hidden="true" tabindex="-1"></a>        host_richness_predictor <span class="ot">&lt;-</span> df_sampled_values<span class="sc">$</span>HostRichness</span>
<span id="cb138-67"><a href="#cb138-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb138-68"><a href="#cb138-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb138-69"><a href="#cb138-69" aria-hidden="true" tabindex="-1"></a>          env_predictors_df <span class="ot">&lt;-</span> df_sampled_values[, <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb138-70"><a href="#cb138-70" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb138-71"><a href="#cb138-71" aria-hidden="true" tabindex="-1"></a>          env_col_names <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(df_sampled_values), <span class="fu">c</span>(<span class="st">"HostRichness"</span>, <span class="st">"FishRichness_EnvOnly"</span>))</span>
<span id="cb138-72"><a href="#cb138-72" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">length</span>(env_col_names) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb138-73"><a href="#cb138-73" aria-hidden="true" tabindex="-1"></a>            env_predictors_df <span class="ot">&lt;-</span> df_sampled_values[, env_col_names, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb138-74"><a href="#cb138-74" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb138-75"><a href="#cb138-75" aria-hidden="true" tabindex="-1"></a>            env_predictors_df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb138-76"><a href="#cb138-76" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Warning: No environmental predictor columns identified for VIF-based variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-77"><a href="#cb138-77" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb138-78"><a href="#cb138-78" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb138-79"><a href="#cb138-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-80"><a href="#cb138-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(env_predictors_df) <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(env_predictors_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb138-81"><a href="#cb138-81" aria-hidden="true" tabindex="-1"></a>          varpart_result <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">varpart</span>(fish_richness_response, host_richness_predictor, env_predictors_df)</span>
<span id="cb138-82"><a href="#cb138-82" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb138-83"><a href="#cb138-83" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Variance Partitioning Results ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-84"><a href="#cb138-84" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(varpart_result)</span>
<span id="cb138-85"><a href="#cb138-85" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb138-86"><a href="#cb138-86" aria-hidden="true" tabindex="-1"></a>          <span class="co"># --- Plot and Save Variance Partitioning Diagram ---</span></span>
<span id="cb138-87"><a href="#cb138-87" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Display in RMarkdown output first</span></span>
<span id="cb138-88"><a href="#cb138-88" aria-hidden="true" tabindex="-1"></a>          <span class="fu">plot</span>(varpart_result, </span>
<span id="cb138-89"><a href="#cb138-89" aria-hidden="true" tabindex="-1"></a>               <span class="at">main =</span> <span class="st">"Variance Partitioning: Anemonefish Richness (Env-Only Models)"</span>,</span>
<span id="cb138-90"><a href="#cb138-90" aria-hidden="true" tabindex="-1"></a>               <span class="at">Xnames =</span> <span class="fu">c</span>(<span class="st">"Host Richness"</span>, <span class="st">"Environment (PCA)"</span>), <span class="co"># More descriptive names for the circles</span></span>
<span id="cb138-91"><a href="#cb138-91" aria-hidden="true" tabindex="-1"></a>               <span class="at">bg =</span> <span class="fu">c</span>(<span class="st">"skyblue"</span>, <span class="st">"lightgreen"</span>), <span class="co"># Optional: colors for circles</span></span>
<span id="cb138-92"><a href="#cb138-92" aria-hidden="true" tabindex="-1"></a>               <span class="at">cex =</span> <span class="fl">0.9</span>, <span class="co"># Adjust text size inside circles if needed</span></span>
<span id="cb138-93"><a href="#cb138-93" aria-hidden="true" tabindex="-1"></a>               <span class="at">id.size =</span> <span class="fl">0.9</span> <span class="co"># Adjust ID size (a,b,c,d) if needed</span></span>
<span id="cb138-94"><a href="#cb138-94" aria-hidden="true" tabindex="-1"></a>               ) </span>
<span id="cb138-95"><a href="#cb138-95" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb138-96"><a href="#cb138-96" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Save the plot if figure_output_dir exists</span></span>
<span id="cb138-97"><a href="#cb138-97" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb138-98"><a href="#cb138-98" aria-hidden="true" tabindex="-1"></a>            varpart_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"varpart_richness.png"</span>)</span>
<span id="cb138-99"><a href="#cb138-99" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Define plot dimensions for saved file - varpart plots often need specific aspect ratios</span></span>
<span id="cb138-100"><a href="#cb138-100" aria-hidden="true" tabindex="-1"></a>            png_width_varpart <span class="ot">&lt;-</span> <span class="dv">800</span> </span>
<span id="cb138-101"><a href="#cb138-101" aria-hidden="true" tabindex="-1"></a>            png_height_varpart <span class="ot">&lt;-</span> <span class="dv">600</span> </span>
<span id="cb138-102"><a href="#cb138-102" aria-hidden="true" tabindex="-1"></a>            png_res_varpart <span class="ot">&lt;-</span> <span class="dv">100</span></span>
<span id="cb138-103"><a href="#cb138-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-104"><a href="#cb138-104" aria-hidden="true" tabindex="-1"></a>            <span class="fu">png</span>(<span class="at">filename =</span> varpart_plot_filename, <span class="at">width =</span> png_width_varpart, <span class="at">height =</span> png_height_varpart, <span class="at">units =</span> <span class="st">"px"</span>, <span class="at">res =</span> png_res_varpart)</span>
<span id="cb138-105"><a href="#cb138-105" aria-hidden="true" tabindex="-1"></a>            <span class="fu">plot</span>(varpart_result, </span>
<span id="cb138-106"><a href="#cb138-106" aria-hidden="true" tabindex="-1"></a>                 <span class="at">main =</span> <span class="st">"Variance Partitioning: Fish Richness</span><span class="sc">\n</span><span class="st">(Host Richness vs. Environment)"</span>, <span class="co"># Example of a more concise title for saving</span></span>
<span id="cb138-107"><a href="#cb138-107" aria-hidden="true" tabindex="-1"></a>                 <span class="at">Xnames =</span> <span class="fu">c</span>(<span class="st">"Host Richness"</span>, <span class="st">"Environment"</span>), </span>
<span id="cb138-108"><a href="#cb138-108" aria-hidden="true" tabindex="-1"></a>                 <span class="at">bg =</span> <span class="fu">c</span>(<span class="st">"skyblue"</span>, <span class="st">"lightgreen"</span>),</span>
<span id="cb138-109"><a href="#cb138-109" aria-hidden="true" tabindex="-1"></a>                 <span class="at">cex =</span> <span class="fl">0.9</span>,</span>
<span id="cb138-110"><a href="#cb138-110" aria-hidden="true" tabindex="-1"></a>                 <span class="at">id.size =</span> <span class="fl">0.9</span></span>
<span id="cb138-111"><a href="#cb138-111" aria-hidden="true" tabindex="-1"></a>                 )</span>
<span id="cb138-112"><a href="#cb138-112" aria-hidden="true" tabindex="-1"></a>            <span class="fu">dev.off</span>()</span>
<span id="cb138-113"><a href="#cb138-113" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Saved variance partitioning plot to:"</span>, varpart_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-114"><a href="#cb138-114" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb138-115"><a href="#cb138-115" aria-hidden="true" tabindex="-1"></a>          <span class="co"># --- End Plot and Save ---</span></span>
<span id="cb138-116"><a href="#cb138-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-117"><a href="#cb138-117" aria-hidden="true" tabindex="-1"></a>          cor_test_result <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(df_sampled_values<span class="sc">$</span>HostRichness, df_sampled_values<span class="sc">$</span>FishRichness_EnvOnly)</span>
<span id="cb138-118"><a href="#cb138-118" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Pearson Correlation between Host Richness and Fish (Env-Only) Richness:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-119"><a href="#cb138-119" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(cor_test_result)</span>
<span id="cb138-120"><a href="#cb138-120" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb138-121"><a href="#cb138-121" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb138-122"><a href="#cb138-122" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Warning: Environmental predictor data frame is empty. Skipping variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-123"><a href="#cb138-123" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb138-124"><a href="#cb138-124" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb138-125"><a href="#cb138-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Warning: Not enough data or required columns missing for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb138-126"><a href="#cb138-126" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb138-127"><a href="#cb138-127" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb138-128"><a href="#cb138-128" aria-hidden="true" tabindex="-1"></a>  } </span>
<span id="cb138-129"><a href="#cb138-129" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Preparing Data for Variance Partitioning ---
Stack for sampling has layers: HostRichness, FishRichness_EnvOnly, PC1, PC2, PC3, PC4 

|---------|---------|---------|---------|
=========================================
                                          

|---------|---------|---------|---------|
=========================================
                                          
Sampled 5000 points for variance partitioning.
Using 3502 complete cases for variance partitioning.

--- Variance Partitioning Results ---

Partition of variance in RDA 

Call: vegan::varpart(Y = fish_richness_response, X =
host_richness_predictor, env_predictors_df)

Explanatory tables:
X1:  host_richness_predictor
X2:  env_predictors_df 

No. of explanatory tables: 2 
Total variation (SS): 5773.5 
            Variance: 1.6491 
No. of observations: 3502 

Partition table:
                     Df R.squared Adj.R.squared Testable
[a+c] = X1            1   0.84491       0.84486     TRUE
[b+c] = X2            4   0.76212       0.76185     TRUE
[a+b+c] = X1+X2       5   0.91648       0.91636     TRUE
Individual fractions                                    
[a] = X1|X2           1                 0.15451     TRUE
[b] = X2|X1           4                 0.07150     TRUE
[c]                   0                 0.69035    FALSE
[d] = Residuals                         0.08364    FALSE
---
Use function 'rda' to test significance of fractions of interest</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/future-host-fish-overlap-specialization-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved variance partitioning plot to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/varpart_richness.png 

Pearson Correlation between Host Richness and Fish (Env-Only) Richness:

    Pearson's product-moment correlation

data:  df_sampled_values$HostRichness and df_sampled_values$FishRichness_EnvOnly
t = 138.08, df = 3500, p-value &lt; 2.2e-16
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.9138897 0.9241732
sample estimates:
     cor 
0.919188 </code></pre>
</div>
</div>
</section>
<section id="relationship-between-host-and-anemonefish-richness-current" class="level2">
<h2 class="anchored" data-anchor-id="relationship-between-host-and-anemonefish-richness-current">Relationship between Host and Anemonefish Richness (Current)</h2>
<p>This section explores the relationship between the current predicted richness of host sea anemones and their mutualistic anemonefish (based on environmental-only models). We use variance partitioning to determine the independent and shared contributions of host richness and environmental factors (PCA components) to anemonefish richness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vegan) <span class="co"># For varpart</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(host_richness_sum_cropped) <span class="sc">||</span> <span class="fu">is.null</span>(fish_richness_sum_cropped) <span class="sc">||</span> </span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>    (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">is.null</span>(env_pca_current_cropped))) {</span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: Necessary raster data (host richness, fish richness, or current PCA env) is missing. Skipping variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Preparing Data for Variance Partitioning ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure all layers have the same extent and resolution for stacking.</span></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The previous cropping step should have handled this for richness sums.</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If PCA was used, env_pca_current_cropped should also match.</span></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>  layers_for_sampling <span class="ot">&lt;-</span> <span class="fu">c</span>(host_richness_sum_cropped, fish_richness_sum_cropped)</span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(env_pca_current_cropped)) {</span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the env_pca_current_cropped is compatible. Resample if necessary.</span></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(layers_for_sampling[[<span class="dv">1</span>]], env_pca_current_cropped[[<span class="dv">1</span>]], <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>)) {</span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a>       <span class="fu">cat</span>(<span class="st">"  Resampling current PCA environmental layers to match richness map geometry for sampling...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>       env_pca_current_resampled <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a>         terra<span class="sc">::</span><span class="fu">resample</span>(env_pca_current_cropped, layers_for_sampling[[<span class="dv">1</span>]], <span class="at">method=</span><span class="st">"bilinear"</span>)</span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a>       }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"  Warning: Failed to resample PCA env layers:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a>       })</span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(env_pca_current_resampled)) {</span>
<span id="cb141-25"><a href="#cb141-25" aria-hidden="true" tabindex="-1"></a>         env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_resampled</span>
<span id="cb141-26"><a href="#cb141-26" aria-hidden="true" tabindex="-1"></a>       } <span class="cf">else</span> {</span>
<span id="cb141-27"><a href="#cb141-27" aria-hidden="true" tabindex="-1"></a>         <span class="fu">cat</span>(<span class="st">"  Using un-resampled PCA env. May lead to issues if extents differ significantly.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-28"><a href="#cb141-28" aria-hidden="true" tabindex="-1"></a>         env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_cropped</span>
<span id="cb141-29"><a href="#cb141-29" aria-hidden="true" tabindex="-1"></a>       }</span>
<span id="cb141-30"><a href="#cb141-30" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb141-31"><a href="#cb141-31" aria-hidden="true" tabindex="-1"></a>      env_pca_current_for_sampling <span class="ot">&lt;-</span> env_pca_current_cropped</span>
<span id="cb141-32"><a href="#cb141-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-33"><a href="#cb141-33" aria-hidden="true" tabindex="-1"></a>    layers_for_sampling <span class="ot">&lt;-</span> <span class="fu">c</span>(layers_for_sampling, env_pca_current_for_sampling[[<span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components]]) <span class="co"># Use first N components</span></span>
<span id="cb141-34"><a href="#cb141-34" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb141-35"><a href="#cb141-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: If not using PCA, you'd need to load your VIF-selected CURRENT environmental rasters here,</span></span>
<span id="cb141-36"><a href="#cb141-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ensure they are cropped and resampled like the richness maps, and add them to layers_for_sampling.</span></span>
<span id="cb141-37"><a href="#cb141-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: Variance partitioning without PCA environmental layers is not fully implemented here. Please adapt if using VIF-selected vars.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-38"><a href="#cb141-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb141-39"><a href="#cb141-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-40"><a href="#cb141-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if we have enough layers to proceed</span></span>
<span id="cb141-41"><a href="#cb141-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling) <span class="sc">&lt;</span> <span class="dv">3</span>) {</span>
<span id="cb141-42"><a href="#cb141-42" aria-hidden="true" tabindex="-1"></a>     <span class="fu">cat</span>(<span class="st">"Error: Need at least host richness, fish richness, and one environmental layer for variance partitioning. Found:"</span>, terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling), <span class="st">"layers.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-43"><a href="#cb141-43" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb141-44"><a href="#cb141-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-45"><a href="#cb141-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename layers for clarity in the output dataframe</span></span>
<span id="cb141-46"><a href="#cb141-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(layers_for_sampling)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"HostRichness"</span></span>
<span id="cb141-47"><a href="#cb141-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(layers_for_sampling)[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="st">"FishRichness_EnvOnly"</span></span>
<span id="cb141-48"><a href="#cb141-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> terra<span class="sc">::</span><span class="fu">nlyr</span>(layers_for_sampling) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb141-49"><a href="#cb141-49" aria-hidden="true" tabindex="-1"></a>      <span class="fu">names</span>(layers_for_sampling)[<span class="dv">3</span><span class="sc">:</span>(<span class="dv">2</span><span class="sc">+</span>config<span class="sc">$</span>n_pca_components)] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components)</span>
<span id="cb141-50"><a href="#cb141-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb141-51"><a href="#cb141-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-52"><a href="#cb141-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Stack for sampling has layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(layers_for_sampling), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-53"><a href="#cb141-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb141-54"><a href="#cb141-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sample random points</span></span>
<span id="cb141-55"><a href="#cb141-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using dismo::randomPoints for consistency with ant paper if preferred, or terra::spatSample</span></span>
<span id="cb141-56"><a href="#cb141-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># for reproducibility</span></span>
<span id="cb141-57"><a href="#cb141-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># bg_points_sampled_varpart &lt;- dismo::randomPoints(raster::raster(layers_for_sampling[[1]]), 5000) # dismo needs raster object</span></span>
<span id="cb141-58"><a href="#cb141-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note: dismo::randomPoints might struggle with large SpatRasters or specific extents.</span></span>
<span id="cb141-59"><a href="#cb141-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using terra::spatSample might be more robust here with SpatRasters.</span></span>
<span id="cb141-60"><a href="#cb141-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We need to sample from areas where ALL layers have data.</span></span>
<span id="cb141-61"><a href="#cb141-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># One way is to sample from the first layer, then extract from the stack.</span></span>
<span id="cb141-62"><a href="#cb141-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Or, create a mask where all layers are non-NA.</span></span>
<span id="cb141-63"><a href="#cb141-63" aria-hidden="true" tabindex="-1"></a>    mask_all_valid <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(layers_for_sampling)) <span class="sc">==</span> <span class="fu">nlyr</span>(layers_for_sampling)</span>
<span id="cb141-64"><a href="#cb141-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">global</span>(mask_all_valid, <span class="st">"sum"</span>, <span class="at">na.rm=</span>T)<span class="sc">$</span>sum <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb141-65"><a href="#cb141-65" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Error: No cells where all predictor layers for variance partitioning have valid data.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-66"><a href="#cb141-66" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb141-67"><a href="#cb141-67" aria-hidden="true" tabindex="-1"></a>      bg_points_sampled_varpart <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">spatSample</span>(mask_all_valid, <span class="dv">5000</span>, <span class="at">method =</span> <span class="st">"random"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">warn=</span><span class="cn">FALSE</span>)</span>
<span id="cb141-68"><a href="#cb141-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Sampled"</span>, <span class="fu">nrow</span>(bg_points_sampled_varpart), <span class="st">"points for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-69"><a href="#cb141-69" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb141-70"><a href="#cb141-70" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(layers_for_sampling, bg_points_sampled_varpart[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)], <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb141-71"><a href="#cb141-71" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df_sampled_values)</span>
<span id="cb141-72"><a href="#cb141-72" aria-hidden="true" tabindex="-1"></a>      df_sampled_values <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(df_sampled_values) <span class="co"># Remove any rows with NAs that might have slipped through</span></span>
<span id="cb141-73"><a href="#cb141-73" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb141-74"><a href="#cb141-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Using"</span>, <span class="fu">nrow</span>(df_sampled_values), <span class="st">"complete cases for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-75"><a href="#cb141-75" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb141-76"><a href="#cb141-76" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">nrow</span>(df_sampled_values) <span class="sc">&gt;</span> <span class="dv">10</span> <span class="sc">&amp;&amp;</span> <span class="st">"HostRichness"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values) <span class="sc">&amp;&amp;</span> <span class="st">"FishRichness_EnvOnly"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values) <span class="sc">&amp;&amp;</span> </span>
<span id="cb141-77"><a href="#cb141-77" aria-hidden="true" tabindex="-1"></a>          ( (<span class="sc">!</span>config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(df_sampled_values) <span class="sc">&gt;</span> <span class="dv">2</span>) <span class="sc">||</span> (config<span class="sc">$</span>use_pca_predictors <span class="sc">&amp;&amp;</span> <span class="fu">all</span>(<span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components) <span class="sc">%in%</span> <span class="fu">names</span>(df_sampled_values))) )</span>
<span id="cb141-78"><a href="#cb141-78" aria-hidden="true" tabindex="-1"></a>         ) {</span>
<span id="cb141-79"><a href="#cb141-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb141-80"><a href="#cb141-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prepare data for varpart</span></span>
<span id="cb141-81"><a href="#cb141-81" aria-hidden="true" tabindex="-1"></a>        fish_richness_response <span class="ot">&lt;-</span> df_sampled_values<span class="sc">$</span>FishRichness_EnvOnly</span>
<span id="cb141-82"><a href="#cb141-82" aria-hidden="true" tabindex="-1"></a>        host_richness_predictor <span class="ot">&lt;-</span> df_sampled_values<span class="sc">$</span>HostRichness</span>
<span id="cb141-83"><a href="#cb141-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb141-84"><a href="#cb141-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (config<span class="sc">$</span>use_pca_predictors) {</span>
<span id="cb141-85"><a href="#cb141-85" aria-hidden="true" tabindex="-1"></a>          env_predictors_df <span class="ot">&lt;-</span> df_sampled_values[, <span class="fu">paste0</span>(<span class="st">"PC"</span>, <span class="dv">1</span><span class="sc">:</span>config<span class="sc">$</span>n_pca_components), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb141-86"><a href="#cb141-86" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb141-87"><a href="#cb141-87" aria-hidden="true" tabindex="-1"></a>          <span class="co"># If using VIF, select the environmental columns (excluding HostRichness and FishRichness_EnvOnly)</span></span>
<span id="cb141-88"><a href="#cb141-88" aria-hidden="true" tabindex="-1"></a>          env_col_names <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(df_sampled_values), <span class="fu">c</span>(<span class="st">"HostRichness"</span>, <span class="st">"FishRichness_EnvOnly"</span>))</span>
<span id="cb141-89"><a href="#cb141-89" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span>(<span class="fu">length</span>(env_col_names) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb141-90"><a href="#cb141-90" aria-hidden="true" tabindex="-1"></a>            env_predictors_df <span class="ot">&lt;-</span> df_sampled_values[, env_col_names, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb141-91"><a href="#cb141-91" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> {</span>
<span id="cb141-92"><a href="#cb141-92" aria-hidden="true" tabindex="-1"></a>            env_predictors_df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb141-93"><a href="#cb141-93" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"Warning: No environmental predictor columns identified for VIF-based variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-94"><a href="#cb141-94" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb141-95"><a href="#cb141-95" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb141-96"><a href="#cb141-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-97"><a href="#cb141-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(env_predictors_df) <span class="sc">&amp;&amp;</span> <span class="fu">ncol</span>(env_predictors_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb141-98"><a href="#cb141-98" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Perform variance partitioning</span></span>
<span id="cb141-99"><a href="#cb141-99" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Response: FishRichness_EnvOnly</span></span>
<span id="cb141-100"><a href="#cb141-100" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Predictor Group 1: HostRichness</span></span>
<span id="cb141-101"><a href="#cb141-101" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Predictor Group 2: Environmental variables (PCA components or VIF-selected)</span></span>
<span id="cb141-102"><a href="#cb141-102" aria-hidden="true" tabindex="-1"></a>          varpart_result <span class="ot">&lt;-</span> vegan<span class="sc">::</span><span class="fu">varpart</span>(fish_richness_response, host_richness_predictor, env_predictors_df)</span>
<span id="cb141-103"><a href="#cb141-103" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb141-104"><a href="#cb141-104" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Variance Partitioning Results ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-105"><a href="#cb141-105" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(varpart_result)</span>
<span id="cb141-106"><a href="#cb141-106" aria-hidden="true" tabindex="-1"></a>          <span class="fu">plot</span>(varpart_result, <span class="at">main =</span> <span class="st">"Variance Partitioning: Anemonefish Richness (Env-Only Models)"</span>)</span>
<span id="cb141-107"><a href="#cb141-107" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb141-108"><a href="#cb141-108" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Pearson correlation between host and fish richness</span></span>
<span id="cb141-109"><a href="#cb141-109" aria-hidden="true" tabindex="-1"></a>          cor_test_result <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(df_sampled_values<span class="sc">$</span>HostRichness, df_sampled_values<span class="sc">$</span>FishRichness_EnvOnly)</span>
<span id="cb141-110"><a href="#cb141-110" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Pearson Correlation between Host Richness and Fish (Env-Only) Richness:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-111"><a href="#cb141-111" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(cor_test_result)</span>
<span id="cb141-112"><a href="#cb141-112" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb141-113"><a href="#cb141-113" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb141-114"><a href="#cb141-114" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Warning: Environmental predictor data frame is empty. Skipping variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-115"><a href="#cb141-115" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb141-116"><a href="#cb141-116" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb141-117"><a href="#cb141-117" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Warning: Not enough data or required columns missing for variance partitioning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb141-118"><a href="#cb141-118" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb141-119"><a href="#cb141-119" aria-hidden="true" tabindex="-1"></a>    } <span class="co"># end else for mask_all_valid check</span></span>
<span id="cb141-120"><a href="#cb141-120" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># end else for nlyr check</span></span>
<span id="cb141-121"><a href="#cb141-121" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Preparing Data for Variance Partitioning ---
Stack for sampling has layers: HostRichness, FishRichness_EnvOnly, PC1, PC2, PC3, PC4 

|---------|---------|---------|---------|
=========================================
                                          

|---------|---------|---------|---------|
=========================================
                                          
Sampled 5000 points for variance partitioning.
Using 3502 complete cases for variance partitioning.

--- Variance Partitioning Results ---

Partition of variance in RDA 

Call: vegan::varpart(Y = fish_richness_response, X =
host_richness_predictor, env_predictors_df)

Explanatory tables:
X1:  host_richness_predictor
X2:  env_predictors_df 

No. of explanatory tables: 2 
Total variation (SS): 5773.5 
            Variance: 1.6491 
No. of observations: 3502 

Partition table:
                     Df R.squared Adj.R.squared Testable
[a+c] = X1            1   0.84491       0.84486     TRUE
[b+c] = X2            4   0.76212       0.76185     TRUE
[a+b+c] = X1+X2       5   0.91648       0.91636     TRUE
Individual fractions                                    
[a] = X1|X2           1                 0.15451     TRUE
[b] = X2|X1           4                 0.07150     TRUE
[c]                   0                 0.69035    FALSE
[d] = Residuals                         0.08364    FALSE
---
Use function 'rda' to test significance of fractions of interest</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/richness-sampling-and-varpart-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Pearson Correlation between Host Richness and Fish (Env-Only) Richness:

    Pearson's product-moment correlation

data:  df_sampled_values$HostRichness and df_sampled_values$FishRichness_EnvOnly
t = 138.08, df = 3500, p-value &lt; 2.2e-16
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 0.9138897 0.9241732
sample estimates:
     cor 
0.919188 </code></pre>
</div>
</div>
</section>
<section id="richness-change-analyses" class="level2">
<h2 class="anchored" data-anchor-id="richness-change-analyses">Richness Change Analyses</h2>
<p>This section analyzes the projected changes in host sea anemone and anemonefish (environmental-only models) richness under future climate scenarios.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmmTMB)</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans) <span class="co"># For pairwise comparisons</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)   <span class="co"># For pivot_longer</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(car)     <span class="co"># For Anova()</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure current richness maps are loaded and cropped from the first chunk</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(host_richness_sum_cropped) <span class="sc">||</span> <span class="fu">is.null</span>(fish_richness_sum_cropped)) {</span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: Cropped current richness maps not available. Skipping richness change analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Host Anemone Richness Change ---</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Analyzing Host Sea Anemone Richness Changes ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(host_richness_future_list) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a>    all_host_rasters_for_analysis <span class="ot">&lt;-</span> <span class="fu">c</span>(host_richness_sum_cropped) </span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(all_host_rasters_for_analysis)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"current"</span> </span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(scen_name <span class="cf">in</span> <span class="fu">names</span>(host_richness_future_list)) {</span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(host_richness_future_list[[scen_name]])) {</span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(host_richness_sum_cropped, host_richness_future_list[[scen_name]], <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>)){</span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"  Resampling host richness for scenario:"</span>, scen_name, <span class="st">"to match current.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a>            host_richness_future_list[[scen_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">resample</span>(host_richness_future_list[[scen_name]], host_richness_sum_cropped, <span class="at">method=</span><span class="st">"bilinear"</span>)</span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(host_richness_future_list[[scen_name]]) <span class="ot">&lt;-</span> scen_name</span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>        all_host_rasters_for_analysis <span class="ot">&lt;-</span> <span class="fu">c</span>(all_host_rasters_for_analysis, host_richness_future_list[[scen_name]])</span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(all_host_rasters_for_analysis) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb144-28"><a href="#cb144-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Not enough host richness rasters (current + at least one future) to analyze changes.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-29"><a href="#cb144-29" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb144-30"><a href="#cb144-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Host richness stack for change analysis has layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(all_host_rasters_for_analysis), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-31"><a href="#cb144-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb144-32"><a href="#cb144-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set.seed</span>(<span class="dv">456</span>)</span>
<span id="cb144-33"><a href="#cb144-33" aria-hidden="true" tabindex="-1"></a>        mask_all_valid_host <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(all_host_rasters_for_analysis)) <span class="sc">==</span> <span class="fu">nlyr</span>(all_host_rasters_for_analysis)</span>
<span id="cb144-34"><a href="#cb144-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">global</span>(mask_all_valid_host, <span class="st">"sum"</span>, <span class="at">na.rm=</span>T)<span class="sc">$</span>sum <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb144-35"><a href="#cb144-35" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"  Error: No cells where all host richness layers have valid data for change analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-36"><a href="#cb144-36" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb144-37"><a href="#cb144-37" aria-hidden="true" tabindex="-1"></a>          pts_host_change <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">spatSample</span>(mask_all_valid_host, <span class="dv">5000</span>, <span class="at">method =</span> <span class="st">"random"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">warn=</span><span class="cn">FALSE</span>)</span>
<span id="cb144-38"><a href="#cb144-38" aria-hidden="true" tabindex="-1"></a>          df_host_change <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(all_host_rasters_for_analysis, pts_host_change[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)], <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb144-39"><a href="#cb144-39" aria-hidden="true" tabindex="-1"></a>          df_host_change <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df_host_change)</span>
<span id="cb144-40"><a href="#cb144-40" aria-hidden="true" tabindex="-1"></a>          df_host_change<span class="sc">$</span>pixel_id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_host_change) </span>
<span id="cb144-41"><a href="#cb144-41" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb144-42"><a href="#cb144-42" aria-hidden="true" tabindex="-1"></a>          df_host_change_long <span class="ot">&lt;-</span> df_host_change <span class="sc">%&gt;%</span></span>
<span id="cb144-43"><a href="#cb144-43" aria-hidden="true" tabindex="-1"></a>            <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>pixel_id, <span class="at">names_to =</span> <span class="st">"scenario"</span>, <span class="at">values_to =</span> <span class="st">"richness"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb144-44"><a href="#cb144-44" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(richness)) <span class="sc">%&gt;%</span></span>
<span id="cb144-45"><a href="#cb144-45" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">scenario =</span> <span class="fu">factor</span>(scenario, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"current"</span>, future_scenarios_to_load))) </span>
<span id="cb144-46"><a href="#cb144-46" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb144-47"><a href="#cb144-47" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">nrow</span>(df_host_change_long) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb144-48"><a href="#cb144-48" aria-hidden="true" tabindex="-1"></a>            lmm_host_richness <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb144-49"><a href="#cb144-49" aria-hidden="true" tabindex="-1"></a>              <span class="fu">glmmTMB</span>(richness <span class="sc">~</span> scenario <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>pixel_id), <span class="at">data =</span> df_host_change_long, <span class="at">family =</span> <span class="fu">gaussian</span>()) </span>
<span id="cb144-50"><a href="#cb144-50" aria-hidden="true" tabindex="-1"></a>            }, <span class="at">error =</span> <span class="cf">function</span>(e) {<span class="fu">cat</span>(<span class="st">"Error fitting GLMM for host richness:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span>})</span>
<span id="cb144-51"><a href="#cb144-51" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb144-52"><a href="#cb144-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(lmm_host_richness)) {</span>
<span id="cb144-53"><a href="#cb144-53" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Summary of GLMM for Host Anemone Richness Change:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-54"><a href="#cb144-54" aria-hidden="true" tabindex="-1"></a>              <span class="fu">print</span>(<span class="fu">summary</span>(lmm_host_richness))</span>
<span id="cb144-55"><a href="#cb144-55" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anova for Host Anemone Richness Change:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-56"><a href="#cb144-56" aria-hidden="true" tabindex="-1"></a>              <span class="fu">print</span>(car<span class="sc">::</span><span class="fu">Anova</span>(lmm_host_richness))</span>
<span id="cb144-57"><a href="#cb144-57" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Estimated Marginal Means for Host Anemone Richness Change:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-58"><a href="#cb144-58" aria-hidden="true" tabindex="-1"></a>              <span class="fu">print</span>(<span class="fu">emmeans</span>(lmm_host_richness, pairwise <span class="sc">~</span> scenario))</span>
<span id="cb144-59"><a href="#cb144-59" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb144-60"><a href="#cb144-60" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> { <span class="fu">cat</span>(<span class="st">"  No data left after pivoting for host richness LMM.</span><span class="sc">\n</span><span class="st">"</span>) }</span>
<span id="cb144-61"><a href="#cb144-61" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb144-62"><a href="#cb144-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-63"><a href="#cb144-63" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { <span class="fu">cat</span>(<span class="st">"  No future host richness maps available for change analysis.</span><span class="sc">\n</span><span class="st">"</span>) }</span>
<span id="cb144-64"><a href="#cb144-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-65"><a href="#cb144-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Anemonefish (Env-Only) Richness Change ---</span></span>
<span id="cb144-66"><a href="#cb144-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Analyzing Anemonefish (Env-Only) Richness Changes ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-67"><a href="#cb144-67" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(fish_richness_future_list) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb144-68"><a href="#cb144-68" aria-hidden="true" tabindex="-1"></a>    all_fish_rasters_for_analysis <span class="ot">&lt;-</span> <span class="fu">c</span>(fish_richness_sum_cropped) </span>
<span id="cb144-69"><a href="#cb144-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">names</span>(all_fish_rasters_for_analysis)[<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="st">"current"</span></span>
<span id="cb144-70"><a href="#cb144-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-71"><a href="#cb144-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(scen_name <span class="cf">in</span> <span class="fu">names</span>(fish_richness_future_list)) {</span>
<span id="cb144-72"><a href="#cb144-72" aria-hidden="true" tabindex="-1"></a>       <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fish_richness_future_list[[scen_name]])) {</span>
<span id="cb144-73"><a href="#cb144-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="sc">!</span>terra<span class="sc">::</span><span class="fu">compareGeom</span>(fish_richness_sum_cropped, fish_richness_future_list[[scen_name]], <span class="at">stopOnError=</span><span class="cn">FALSE</span>, <span class="at">res=</span><span class="cn">TRUE</span>, <span class="at">crs=</span><span class="cn">TRUE</span>)){</span>
<span id="cb144-74"><a href="#cb144-74" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"  Resampling fish richness for scenario:"</span>, scen_name, <span class="st">"to match current.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-75"><a href="#cb144-75" aria-hidden="true" tabindex="-1"></a>            fish_richness_future_list[[scen_name]] <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">resample</span>(fish_richness_future_list[[scen_name]], fish_richness_sum_cropped, <span class="at">method=</span><span class="st">"bilinear"</span>)</span>
<span id="cb144-76"><a href="#cb144-76" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb144-77"><a href="#cb144-77" aria-hidden="true" tabindex="-1"></a>        <span class="fu">names</span>(fish_richness_future_list[[scen_name]]) <span class="ot">&lt;-</span> scen_name</span>
<span id="cb144-78"><a href="#cb144-78" aria-hidden="true" tabindex="-1"></a>        all_fish_rasters_for_analysis <span class="ot">&lt;-</span> <span class="fu">c</span>(all_fish_rasters_for_analysis, fish_richness_future_list[[scen_name]])</span>
<span id="cb144-79"><a href="#cb144-79" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb144-80"><a href="#cb144-80" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-81"><a href="#cb144-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(terra<span class="sc">::</span><span class="fu">nlyr</span>(all_fish_rasters_for_analysis) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb144-82"><a href="#cb144-82" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Warning: Not enough fish richness rasters (current + at least one future) to analyze changes.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-83"><a href="#cb144-83" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb144-84"><a href="#cb144-84" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Anemonefish richness stack for change analysis has layers:"</span>, <span class="fu">paste</span>(<span class="fu">names</span>(all_fish_rasters_for_analysis), <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-85"><a href="#cb144-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-86"><a href="#cb144-86" aria-hidden="true" tabindex="-1"></a>        <span class="fu">set.seed</span>(<span class="dv">789</span>)</span>
<span id="cb144-87"><a href="#cb144-87" aria-hidden="true" tabindex="-1"></a>        mask_all_valid_fish <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="sc">!</span><span class="fu">is.na</span>(all_fish_rasters_for_analysis)) <span class="sc">==</span> <span class="fu">nlyr</span>(all_fish_rasters_for_analysis)</span>
<span id="cb144-88"><a href="#cb144-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">global</span>(mask_all_valid_fish, <span class="st">"sum"</span>, <span class="at">na.rm=</span>T)<span class="sc">$</span>sum <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb144-89"><a href="#cb144-89" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"  Error: No cells where all fish richness layers have valid data for change analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-90"><a href="#cb144-90" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb144-91"><a href="#cb144-91" aria-hidden="true" tabindex="-1"></a>          pts_fish_change <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">spatSample</span>(mask_all_valid_fish, <span class="dv">5000</span>, <span class="at">method =</span> <span class="st">"random"</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">xy=</span><span class="cn">TRUE</span>, <span class="at">warn=</span><span class="cn">FALSE</span>)</span>
<span id="cb144-92"><a href="#cb144-92" aria-hidden="true" tabindex="-1"></a>          df_fish_change <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">extract</span>(all_fish_rasters_for_analysis, pts_fish_change[, <span class="fu">c</span>(<span class="st">"x"</span>, <span class="st">"y"</span>)], <span class="at">ID =</span> <span class="cn">FALSE</span>)</span>
<span id="cb144-93"><a href="#cb144-93" aria-hidden="true" tabindex="-1"></a>          df_fish_change <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(df_fish_change)</span>
<span id="cb144-94"><a href="#cb144-94" aria-hidden="true" tabindex="-1"></a>          df_fish_change<span class="sc">$</span>pixel_id <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_fish_change)</span>
<span id="cb144-95"><a href="#cb144-95" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb144-96"><a href="#cb144-96" aria-hidden="true" tabindex="-1"></a>          df_fish_change_long <span class="ot">&lt;-</span> df_fish_change <span class="sc">%&gt;%</span></span>
<span id="cb144-97"><a href="#cb144-97" aria-hidden="true" tabindex="-1"></a>            <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>pixel_id, <span class="at">names_to =</span> <span class="st">"scenario"</span>, <span class="at">values_to =</span> <span class="st">"richness"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb144-98"><a href="#cb144-98" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(richness)) <span class="sc">%&gt;%</span></span>
<span id="cb144-99"><a href="#cb144-99" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">scenario =</span> <span class="fu">factor</span>(scenario, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"current"</span>, future_scenarios_to_load)))</span>
<span id="cb144-100"><a href="#cb144-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-101"><a href="#cb144-101" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> (<span class="fu">nrow</span>(df_fish_change_long) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb144-102"><a href="#cb144-102" aria-hidden="true" tabindex="-1"></a>            lmm_fish_richness <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb144-103"><a href="#cb144-103" aria-hidden="true" tabindex="-1"></a>              <span class="fu">glmmTMB</span>(richness <span class="sc">~</span> scenario <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>pixel_id), <span class="at">data =</span> df_fish_change_long, <span class="at">family =</span> <span class="fu">gaussian</span>())</span>
<span id="cb144-104"><a href="#cb144-104" aria-hidden="true" tabindex="-1"></a>            }, <span class="at">error =</span> <span class="cf">function</span>(e) {<span class="fu">cat</span>(<span class="st">"Error fitting GLMM for fish richness:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span>})</span>
<span id="cb144-105"><a href="#cb144-105" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb144-106"><a href="#cb144-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(lmm_fish_richness)) {</span>
<span id="cb144-107"><a href="#cb144-107" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Summary of GLMM for Anemonefish (Env-Only) Richness Change:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-108"><a href="#cb144-108" aria-hidden="true" tabindex="-1"></a>              <span class="fu">print</span>(<span class="fu">summary</span>(lmm_fish_richness))</span>
<span id="cb144-109"><a href="#cb144-109" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anova for Anemonefish (Env-Only) Richness Change:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-110"><a href="#cb144-110" aria-hidden="true" tabindex="-1"></a>              <span class="fu">print</span>(car<span class="sc">::</span><span class="fu">Anova</span>(lmm_fish_richness))</span>
<span id="cb144-111"><a href="#cb144-111" aria-hidden="true" tabindex="-1"></a>              <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Estimated Marginal Means for Anemonefish (Env-Only) Richness Change:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-112"><a href="#cb144-112" aria-hidden="true" tabindex="-1"></a>              <span class="fu">print</span>(<span class="fu">emmeans</span>(lmm_fish_richness, pairwise <span class="sc">~</span> scenario))</span>
<span id="cb144-113"><a href="#cb144-113" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb144-114"><a href="#cb144-114" aria-hidden="true" tabindex="-1"></a>          } <span class="cf">else</span> { <span class="fu">cat</span>(<span class="st">"  No data left after pivoting for fish richness LMM.</span><span class="sc">\n</span><span class="st">"</span>) }</span>
<span id="cb144-115"><a href="#cb144-115" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb144-116"><a href="#cb144-116" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-117"><a href="#cb144-117" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> { <span class="fu">cat</span>(<span class="st">"  No future anemonefish (env-only) richness maps available for change analysis.</span><span class="sc">\n</span><span class="st">"</span>) }</span>
<span id="cb144-118"><a href="#cb144-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-119"><a href="#cb144-119" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Combined Plot (Optional, if both groups have data) ---</span></span>
<span id="cb144-120"><a href="#cb144-120" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"df_host_change_long"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"df_fish_change_long"</span>) <span class="sc">&amp;&amp;</span> </span>
<span id="cb144-121"><a href="#cb144-121" aria-hidden="true" tabindex="-1"></a>      <span class="fu">nrow</span>(df_host_change_long) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(df_fish_change_long) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb144-122"><a href="#cb144-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-123"><a href="#cb144-123" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure 'guild' column name is consistent before binding</span></span>
<span id="cb144-124"><a href="#cb144-124" aria-hidden="true" tabindex="-1"></a>    df_host_change_long_for_bind <span class="ot">&lt;-</span> df_host_change_long <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">guild =</span> <span class="st">"Host Anemone"</span>)</span>
<span id="cb144-125"><a href="#cb144-125" aria-hidden="true" tabindex="-1"></a>    df_fish_change_long_for_bind <span class="ot">&lt;-</span> df_fish_change_long <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">guild =</span> <span class="st">"Anemonefish (Env-Only)"</span>) <span class="co"># Adjusted name for clarity</span></span>
<span id="cb144-126"><a href="#cb144-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-127"><a href="#cb144-127" aria-hidden="true" tabindex="-1"></a>    df_all_richness_change <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(df_host_change_long_for_bind, df_fish_change_long_for_bind)</span>
<span id="cb144-128"><a href="#cb144-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-129"><a href="#cb144-129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure scenario_label_converter is available</span></span>
<span id="cb144-130"><a href="#cb144-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"scenario_label_converter"</span>)) {</span>
<span id="cb144-131"><a href="#cb144-131" aria-hidden="true" tabindex="-1"></a>        scenario_label_converter <span class="ot">&lt;-</span> <span class="fu">setNames</span>(<span class="at">nm =</span> <span class="fu">c</span>(<span class="st">"current"</span>, future_scenarios_to_load)) <span class="co"># Fallback</span></span>
<span id="cb144-132"><a href="#cb144-132" aria-hidden="true" tabindex="-1"></a>        scenario_label_converter[<span class="fu">is.na</span>(scenario_label_converter)] <span class="ot">&lt;-</span> <span class="fu">names</span>(scenario_label_converter[<span class="fu">is.na</span>(scenario_label_converter)])</span>
<span id="cb144-133"><a href="#cb144-133" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-134"><a href="#cb144-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-135"><a href="#cb144-135" aria-hidden="true" tabindex="-1"></a>    plot_richness_boxplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_all_richness_change, <span class="fu">aes</span>(<span class="at">x =</span> guild, <span class="at">y =</span> richness, <span class="at">fill =</span> scenario)) <span class="sc">+</span></span>
<span id="cb144-136"><a href="#cb144-136" aria-hidden="true" tabindex="-1"></a>      <span class="fu">geom_boxplot</span>(<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span> <span class="co"># Added alpha for aesthetics</span></span>
<span id="cb144-137"><a href="#cb144-137" aria-hidden="true" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Projected Richness Changes by Guild and Scenario"</span>,</span>
<span id="cb144-138"><a href="#cb144-138" aria-hidden="true" tabindex="-1"></a>           <span class="at">x =</span> <span class="st">"Guild"</span>, <span class="at">y =</span> <span class="st">"Predicted Richness (Sampled Points)"</span>) <span class="sc">+</span> <span class="co"># Clarified y-axis</span></span>
<span id="cb144-139"><a href="#cb144-139" aria-hidden="true" tabindex="-1"></a>      <span class="fu">scale_fill_discrete</span>(<span class="at">name =</span> <span class="st">"Scenario"</span>, <span class="at">labels =</span> scenario_label_converter) <span class="sc">+</span> <span class="co"># Use converter for legend</span></span>
<span id="cb144-140"><a href="#cb144-140" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span> <span class="co"># Slightly smaller base size</span></span>
<span id="cb144-141"><a href="#cb144-141" aria-hidden="true" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">30</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size=</span><span class="dv">10</span>), <span class="co"># Adjusted angle</span></span>
<span id="cb144-142"><a href="#cb144-142" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.position =</span> <span class="st">"right"</span>, <span class="co"># Moved legend</span></span>
<span id="cb144-143"><a href="#cb144-143" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>))</span>
<span id="cb144-144"><a href="#cb144-144" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb144-145"><a href="#cb144-145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print plot to RMarkdown output</span></span>
<span id="cb144-146"><a href="#cb144-146" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(plot_richness_boxplot)</span>
<span id="cb144-147"><a href="#cb144-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-148"><a href="#cb144-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- ADD THIS SECTION TO SAVE plot_richness_boxplot ---</span></span>
<span id="cb144-149"><a href="#cb144-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb144-150"><a href="#cb144-150" aria-hidden="true" tabindex="-1"></a>      combined_richness_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"projected_richness_changes_guild_scenario.png"</span>)</span>
<span id="cb144-151"><a href="#cb144-151" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ggsave</span>(<span class="at">filename =</span> combined_richness_plot_filename, </span>
<span id="cb144-152"><a href="#cb144-152" aria-hidden="true" tabindex="-1"></a>             <span class="at">plot =</span> plot_richness_boxplot, </span>
<span id="cb144-153"><a href="#cb144-153" aria-hidden="true" tabindex="-1"></a>             <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">7</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Adjust dimensions/dpi as needed</span></span>
<span id="cb144-154"><a href="#cb144-154" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Saved combined richness change plot to:"</span>, combined_richness_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-155"><a href="#cb144-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb144-156"><a href="#cb144-156" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Combined richness plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-157"><a href="#cb144-157" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-158"><a href="#cb144-158" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- </span><span class="re">END</span><span class="co"> OF ADDED SECTION ---</span></span>
<span id="cb144-159"><a href="#cb144-159" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb144-160"><a href="#cb144-160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combined GLMM for interaction</span></span>
<span id="cb144-161"><a href="#cb144-161" aria-hidden="true" tabindex="-1"></a>    lmm_combined_richness <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb144-162"><a href="#cb144-162" aria-hidden="true" tabindex="-1"></a>      <span class="fu">glmmTMB</span>(richness <span class="sc">~</span> scenario <span class="sc">*</span> guild <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>pixel_id), <span class="at">data =</span> df_all_richness_change, <span class="at">family =</span> <span class="fu">gaussian</span>())</span>
<span id="cb144-163"><a href="#cb144-163" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {<span class="fu">cat</span>(<span class="st">"Error fitting combined GLMM for richness:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span>})</span>
<span id="cb144-164"><a href="#cb144-164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(lmm_combined_richness)) {</span>
<span id="cb144-165"><a href="#cb144-165" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Summary of Combined GLMM for Richness (Scenario * Guild Interaction):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-166"><a href="#cb144-166" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(<span class="fu">summary</span>(lmm_combined_richness))</span>
<span id="cb144-167"><a href="#cb144-167" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anova for Combined GLMM Richness:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb144-168"><a href="#cb144-168" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(car<span class="sc">::</span><span class="fu">Anova</span>(lmm_combined_richness))</span>
<span id="cb144-169"><a href="#cb144-169" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb144-170"><a href="#cb144-170" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb144-171"><a href="#cb144-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-172"><a href="#cb144-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-173"><a href="#cb144-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb144-174"><a href="#cb144-174" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Maps of Richness Loss/Gain for a specific future scenario (e.g., worst-case SSP5-8.5 2100) ---</span></span>
<span id="cb144-175"><a href="#cb144-175" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose one future scenario for difference maps</span></span>
<span id="cb144-176"><a href="#cb144-176" aria-hidden="true" tabindex="-1"></a>  <span class="co"># diff_scenario_host &lt;- "ssp585_2100" # Example</span></span>
<span id="cb144-177"><a href="#cb144-177" aria-hidden="true" tabindex="-1"></a>  <span class="co"># diff_scenario_fish &lt;- "ssp585_2100" # Example</span></span>
<span id="cb144-178"><a href="#cb144-178" aria-hidden="true" tabindex="-1"></a>  <span class="co"># for (scenario_name in future_scenarios_to_load) {</span></span>
<span id="cb144-179"><a href="#cb144-179" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   if (scenario_name == current) {</span></span>
<span id="cb144-180"><a href="#cb144-180" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     next</span></span>
<span id="cb144-181"><a href="#cb144-181" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   }</span></span>
<span id="cb144-182"><a href="#cb144-182" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   </span></span>
<span id="cb144-183"><a href="#cb144-183" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   diff_scenario_host &lt;- scenario_name</span></span>
<span id="cb144-184"><a href="#cb144-184" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   diff_scenario_fish &lt;- scenario_name</span></span>
<span id="cb144-185"><a href="#cb144-185" aria-hidden="true" tabindex="-1"></a>  <span class="co"># </span></span>
<span id="cb144-186"><a href="#cb144-186" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   if (diff_scenario_host %in% names(host_richness_future_list) &amp;&amp; !is.null(host_richness_future_list[[diff_scenario_host]])) {</span></span>
<span id="cb144-187"><a href="#cb144-187" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     host_richness_loss &lt;- host_richness_future_list[[diff_scenario_host]] - host_richness_sum_cropped</span></span>
<span id="cb144-188"><a href="#cb144-188" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     names(host_richness_loss) &lt;- paste0("HostRichnessChange_", diff_scenario_host)</span></span>
<span id="cb144-189"><a href="#cb144-189" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     plot(host_richness_loss, main = paste("Host Anemone Richness Change:", scenario_label_converter[diff_scenario_host], "vs Current"))</span></span>
<span id="cb144-190"><a href="#cb144-190" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     </span></span>
<span id="cb144-191"><a href="#cb144-191" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     # ggplot version</span></span>
<span id="cb144-192"><a href="#cb144-192" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     df_host_loss = as.data.frame(host_richness_loss, xy=TRUE)</span></span>
<span id="cb144-193"><a href="#cb144-193" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     plot_host_loss_map &lt;- ggplot(df_host_loss) +</span></span>
<span id="cb144-194"><a href="#cb144-194" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       geom_raster(aes(y=y, x=x, fill=.data[[names(host_richness_loss)]])) + # Use .data pronoun</span></span>
<span id="cb144-195"><a href="#cb144-195" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       scale_fill_gradient2(low = "red", mid = "white", high = "darkgreen", midpoint = 0, name="Richness Change") +</span></span>
<span id="cb144-196"><a href="#cb144-196" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       labs(title = paste("Host Anemone Richness Change:", scenario_label_converter[diff_scenario_host], "vs Current"), x="Longitude", y="Latitude") +</span></span>
<span id="cb144-197"><a href="#cb144-197" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       theme_bw() + theme(panel.background = element_rect(fill = "aliceblue"))</span></span>
<span id="cb144-198"><a href="#cb144-198" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     print(plot_host_loss_map)</span></span>
<span id="cb144-199"><a href="#cb144-199" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   }</span></span>
<span id="cb144-200"><a href="#cb144-200" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   </span></span>
<span id="cb144-201"><a href="#cb144-201" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   if (diff_scenario_fish %in% names(fish_richness_future_list) &amp;&amp; !is.null(fish_richness_future_list[[diff_scenario_fish]])) {</span></span>
<span id="cb144-202"><a href="#cb144-202" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     fish_richness_loss &lt;- fish_richness_future_list[[diff_scenario_fish]] - fish_richness_sum_cropped</span></span>
<span id="cb144-203"><a href="#cb144-203" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     names(fish_richness_loss) &lt;- paste0("FishRichnessChange_", diff_scenario_fish)</span></span>
<span id="cb144-204"><a href="#cb144-204" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     plot(fish_richness_loss, main = paste("Anemonefish Richness Change:", scenario_label_converter[diff_scenario_fish], "vs Current"))</span></span>
<span id="cb144-205"><a href="#cb144-205" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     </span></span>
<span id="cb144-206"><a href="#cb144-206" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     df_fish_loss = as.data.frame(fish_richness_loss, xy=TRUE)</span></span>
<span id="cb144-207"><a href="#cb144-207" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     plot_fish_loss_map &lt;- ggplot(df_fish_loss) +</span></span>
<span id="cb144-208"><a href="#cb144-208" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       geom_raster(aes(y=y, x=x, fill=.data[[names(fish_richness_loss)]])) +</span></span>
<span id="cb144-209"><a href="#cb144-209" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       scale_fill_gradient2(low = "red", mid = "white", high = "darkgreen", midpoint = 0, name="Richness Change") +</span></span>
<span id="cb144-210"><a href="#cb144-210" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       labs(title = paste("Anemonefish Richness Change:", scenario_label_converter[diff_scenario_fish], "vs Current"), x="Longitude", y="Latitude") +</span></span>
<span id="cb144-211"><a href="#cb144-211" aria-hidden="true" tabindex="-1"></a>  <span class="co">#       theme_bw() + theme(panel.background = element_rect(fill = "aliceblue"))</span></span>
<span id="cb144-212"><a href="#cb144-212" aria-hidden="true" tabindex="-1"></a>  <span class="co">#     print(plot_fish_loss_map)</span></span>
<span id="cb144-213"><a href="#cb144-213" aria-hidden="true" tabindex="-1"></a>  <span class="co">#   }</span></span>
<span id="cb144-214"><a href="#cb144-214" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb144-215"><a href="#cb144-215" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Analyzing Host Sea Anemone Richness Changes ---
  Host richness stack for change analysis has layers: current, ssp119_2050, ssp119_2100, ssp585_2050, ssp585_2100 

Summary of GLMM for Host Anemone Richness Change:
 Family: gaussian  ( identity )
Formula:          richness ~ scenario + (1 | pixel_id)
Data: df_host_change_long

      AIC       BIC    logLik -2*log(L)  df.resid 
  -4160.7   -4106.3    2087.4   -4174.7     17713 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 pixel_id (Intercept) 1.65368  1.2860  
 Residual             0.01265  0.1125  
Number of obs: 17720, groups:  pixel_id, 3544

Dispersion estimate for gaussian family (sigma^2): 0.0126 

Conditional model:
                      Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          1.0825027  0.0216837   49.92  &lt; 2e-16 ***
scenariossp119_2050 -0.0117300  0.0026715   -4.39 1.13e-05 ***
scenariossp119_2100 -0.0132077  0.0026715   -4.94 7.66e-07 ***
scenariossp585_2050 -0.0105266  0.0026715   -3.94 8.14e-05 ***
scenariossp585_2100 -0.0005135  0.0026715   -0.19    0.848    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Anova for Host Anemone Richness Change:
Analysis of Deviance Table (Type II Wald chisquare tests)

Response: richness
          Chisq Df Pr(&gt;Chisq)    
scenario 46.021  4  2.438e-09 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Estimated Marginal Means for Host Anemone Richness Change:
$emmeans
 scenario    emmean     SE    df lower.CL upper.CL
 current       1.08 0.0217 17713     1.04     1.13
 ssp119_2050   1.07 0.0217 17713     1.03     1.11
 ssp119_2100   1.07 0.0217 17713     1.03     1.11
 ssp585_2050   1.07 0.0217 17713     1.03     1.11
 ssp585_2100   1.08 0.0217 17713     1.04     1.12

Confidence level used: 0.95 

$contrasts
 contrast                   estimate      SE    df t.ratio p.value
 current - ssp119_2050      0.011730 0.00267 17713   4.391  0.0001
 current - ssp119_2100      0.013208 0.00267 17713   4.944  &lt;.0001
 current - ssp585_2050      0.010527 0.00267 17713   3.940  0.0008
 current - ssp585_2100      0.000513 0.00267 17713   0.192  0.9997
 ssp119_2050 - ssp119_2100  0.001478 0.00267 17713   0.553  0.9816
 ssp119_2050 - ssp585_2050 -0.001203 0.00267 17713  -0.450  0.9915
 ssp119_2050 - ssp585_2100 -0.011217 0.00267 17713  -4.199  0.0003
 ssp119_2100 - ssp585_2050 -0.002681 0.00267 17713  -1.004  0.8538
 ssp119_2100 - ssp585_2100 -0.012694 0.00267 17713  -4.752  &lt;.0001
 ssp585_2050 - ssp585_2100 -0.010013 0.00267 17713  -3.748  0.0017

P value adjustment: tukey method for comparing a family of 5 estimates 


--- Analyzing Anemonefish (Env-Only) Richness Changes ---
  Anemonefish richness stack for change analysis has layers: current, ssp119_2050, ssp119_2100, ssp585_2050, ssp585_2100 

Summary of GLMM for Anemonefish (Env-Only) Richness Change:
 Family: gaussian  ( identity )
Formula:          richness ~ scenario + (1 | pixel_id)
Data: df_fish_change_long

      AIC       BIC    logLik -2*log(L)  df.resid 
  -9889.8   -9835.3    4951.9   -9903.8     17603 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 pixel_id (Intercept) 1.609697 1.269   
 Residual             0.008464 0.092   
Number of obs: 17610, groups:  pixel_id, 3522

Dispersion estimate for gaussian family (sigma^2): 0.00846 

Conditional model:
                     Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)          1.426334   0.021435   66.54  &lt; 2e-16 ***
scenariossp119_2050 -0.011050   0.002192   -5.04 4.65e-07 ***
scenariossp119_2100 -0.009619   0.002192   -4.39 1.15e-05 ***
scenariossp585_2050 -0.001150   0.002192   -0.52      0.6    
scenariossp585_2100  0.088790   0.002192   40.50  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Anova for Anemonefish (Env-Only) Richness Change:
Analysis of Deviance Table (Type II Wald chisquare tests)

Response: richness
          Chisq Df Pr(&gt;Chisq)    
scenario 2997.2  4  &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Estimated Marginal Means for Anemonefish (Env-Only) Richness Change:
$emmeans
 scenario    emmean     SE    df lower.CL upper.CL
 current       1.43 0.0214 17603     1.38     1.47
 ssp119_2050   1.42 0.0214 17603     1.37     1.46
 ssp119_2100   1.42 0.0214 17603     1.37     1.46
 ssp585_2050   1.43 0.0214 17603     1.38     1.47
 ssp585_2100   1.52 0.0214 17603     1.47     1.56

Confidence level used: 0.95 

$contrasts
 contrast                  estimate      SE    df t.ratio p.value
 current - ssp119_2050      0.01105 0.00219 17603   5.040  &lt;.0001
 current - ssp119_2100      0.00962 0.00219 17603   4.388  0.0001
 current - ssp585_2050      0.00115 0.00219 17603   0.525  0.9849
 current - ssp585_2100     -0.08879 0.00219 17603 -40.501  &lt;.0001
 ssp119_2050 - ssp119_2100 -0.00143 0.00219 17603  -0.653  0.9662
 ssp119_2050 - ssp585_2050 -0.00990 0.00219 17603  -4.516  0.0001
 ssp119_2050 - ssp585_2100 -0.09984 0.00219 17603 -45.541  &lt;.0001
 ssp119_2100 - ssp585_2050 -0.00847 0.00219 17603  -3.863  0.0011
 ssp119_2100 - ssp585_2100 -0.09841 0.00219 17603 -44.888  &lt;.0001
 ssp585_2050 - ssp585_2100 -0.08994 0.00219 17603 -41.026  &lt;.0001

P value adjustment: tukey method for comparing a family of 5 estimates </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/richness-change-analysis-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved combined richness change plot to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/projected_richness_changes_guild_scenario.png 

Summary of Combined GLMM for Richness (Scenario * Guild Interaction):
 Family: gaussian  ( identity )
Formula:          richness ~ scenario * guild + (1 | pixel_id)
Data: df_all_richness_change

      AIC       BIC    logLik -2*log(L)  df.resid 
  98529.9   98631.6  -49253.0   98505.9     35318 

Random effects:

Conditional model:
 Groups   Name        Variance Std.Dev.
 pixel_id (Intercept) 1.0416   1.0206  
 Residual             0.6896   0.8304  
Number of obs: 35330, groups:  pixel_id, 4562

Dispersion estimate for gaussian family (sigma^2): 0.69 

Conditional model:
                                        Estimate Std. Error z value Pr(&gt;|z|)
(Intercept)                            1.4179269  0.0208131   68.13  &lt; 2e-16
scenariossp119_2050                   -0.0110496  0.0197882   -0.56  0.57658
scenariossp119_2100                   -0.0096193  0.0197882   -0.49  0.62689
scenariossp585_2050                   -0.0011506  0.0197882   -0.06  0.95363
scenariossp585_2100                    0.0887891  0.0197882    4.49 7.22e-06
guildHost Anemone                     -0.3370537  0.0204301  -16.50  &lt; 2e-16
scenariossp119_2050:guildHost Anemone -0.0006781  0.0279412   -0.02  0.98064
scenariossp119_2100:guildHost Anemone -0.0035866  0.0279412   -0.13  0.89786
scenariossp585_2050:guildHost Anemone -0.0093740  0.0279412   -0.34  0.73726
scenariossp585_2100:guildHost Anemone -0.0893005  0.0279412   -3.20  0.00139
                                         
(Intercept)                           ***
scenariossp119_2050                      
scenariossp119_2100                      
scenariossp585_2050                      
scenariossp585_2100                   ***
guildHost Anemone                     ***
scenariossp119_2050:guildHost Anemone    
scenariossp119_2100:guildHost Anemone    
scenariossp585_2050:guildHost Anemone    
scenariossp585_2100:guildHost Anemone ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Anova for Combined GLMM Richness:
Analysis of Deviance Table (Type II Wald chisquare tests)

Response: richness
                  Chisq Df Pr(&gt;Chisq)    
scenario         22.372  4   0.000169 ***
guild          1216.961  1  &lt; 2.2e-16 ***
scenario:guild   15.259  4   0.004193 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
</section>
<section id="anemonefish-phylogeny" class="level2">
<h2 class="anchored" data-anchor-id="anemonefish-phylogeny">Anemonefish Phylogeny</h2>
<p>This section loads a phylogenetic tree that includes the anemonefish species under study. It then prunes the tree to only these species and standardizes tip labels for consistency in subsequent analyses.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ape)</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(phytools) </span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(picante)  </span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># Added for data frame manipulation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Define Anemonefish Species in Your Study ---</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the scientific names directly from your provided list</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a><span class="co"># We will convert them to Genus_species format for tree matching.</span></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>anemonefish_species_in_study_raw <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion clarkii"</span>, <span class="st">"Amphiprion frenatus"</span>, <span class="st">"Amphiprion ocellaris"</span>, </span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Amphiprion perideraion"</span>, <span class="st">"Amphiprion polymnus"</span>, <span class="st">"Amphiprion sandaracinos"</span></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add ALL your other anemonefish species from your full list here if they are not covered by df_fish_comparison yet</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a><span class="co"># If df_fish_comparison is already loaded and processed, use it as the primary source</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"df_fish_comparison"</span>) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="st">"species"</span> <span class="sc">%in%</span> <span class="fu">names</span>(df_fish_comparison) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(df_fish_comparison) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb148-12"><a href="#cb148-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assuming df_fish_comparison$species is already in "Genus_species" format from the previous chunk</span></span>
<span id="cb148-13"><a href="#cb148-13" aria-hidden="true" tabindex="-1"></a>  anemonefish_species_in_study_tree_format <span class="ot">&lt;-</span> <span class="fu">unique</span>(df_fish_comparison<span class="sc">$</span>species)</span>
<span id="cb148-14"><a href="#cb148-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Using anemonefish species list from 'df_fish_comparison'.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb148-15"><a href="#cb148-15" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb148-16"><a href="#cb148-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: 'df_fish_comparison' not fully available. Using manually defined list and converting to Genus_species format for tree matching.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb148-17"><a href="#cb148-17" aria-hidden="true" tabindex="-1"></a>  anemonefish_species_in_study_tree_format <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, anemonefish_species_in_study_raw)</span>
<span id="cb148-18"><a href="#cb148-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Using anemonefish species list from 'df_fish_comparison'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Anemonefish species for tree matching (Genus_species format):"</span>, <span class="fu">paste</span>(anemonefish_species_in_study_tree_format, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anemonefish species for tree matching (Genus_species format): Amphiprion_akindynos, Amphiprion_allardi, Amphiprion_bicinctus, Amphiprion_clarkii, Amphiprion_frenatus, Amphiprion_melanopus, Amphiprion_ocellaris, Amphiprion_percula, Amphiprion_perideraion, Amphiprion_sandaracinos, Premnas_biaculeatus </code></pre>
</div>
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(anemonefish_species_in_study_tree_format) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"No anemonefish species defined for phylogeny processing."</span>)</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Load Anemonefish Phylogenetic Tree ---</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a><span class="co"># !!! --- YOU MUST REPLACE THIS WITH THE ACTUAL PATH TO *YOUR* ANEMONEFISH TREE FILE --- !!!</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: "anemonefish_from_fishtree.nwk" or "some_pomacentridae_study.nex"</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Place this file in data/phylogeny/</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a>anemonefish_tree_file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>data_dir, <span class="st">"phylogeny"</span>, <span class="st">"anemonefish_phylogeny_OTL.nwk"</span>) </span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a>pruned_anemonefish_tree <span class="ot">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Initialize</span></span>
<span id="cb152-13"><a href="#cb152-13" aria-hidden="true" tabindex="-1"></a>fish_label_map_df <span class="ot">&lt;-</span> <span class="cn">NULL</span>       <span class="co"># Initialize</span></span>
<span id="cb152-14"><a href="#cb152-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-15"><a href="#cb152-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file.exists</span>(anemonefish_tree_file_path)) {</span>
<span id="cb152-16"><a href="#cb152-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loading anemonefish tree from:"</span>, anemonefish_tree_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-17"><a href="#cb152-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb152-18"><a href="#cb152-18" aria-hidden="true" tabindex="-1"></a>  full_anemonefish_tree <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb152-19"><a href="#cb152-19" aria-hidden="true" tabindex="-1"></a>    file_ext_lower <span class="ot">&lt;-</span> <span class="fu">tolower</span>(tools<span class="sc">::</span><span class="fu">file_ext</span>(anemonefish_tree_file_path))</span>
<span id="cb152-20"><a href="#cb152-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (file_ext_lower <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"nex"</span>, <span class="st">"nxs"</span>)) {</span>
<span id="cb152-21"><a href="#cb152-21" aria-hidden="true" tabindex="-1"></a>      ape<span class="sc">::</span><span class="fu">read.nexus</span>(anemonefish_tree_file_path)</span>
<span id="cb152-22"><a href="#cb152-22" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (file_ext_lower <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"nwk"</span>, <span class="st">"newick"</span>, <span class="st">"tre"</span>, <span class="st">"tree"</span>)) {</span>
<span id="cb152-23"><a href="#cb152-23" aria-hidden="true" tabindex="-1"></a>      ape<span class="sc">::</span><span class="fu">read.tree</span>(anemonefish_tree_file_path)</span>
<span id="cb152-24"><a href="#cb152-24" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb152-25"><a href="#cb152-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Warning: Unknown tree file extension for"</span>, <span class="fu">basename</span>(anemonefish_tree_file_path), <span class="st">". Attempting read.tree().</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-26"><a href="#cb152-26" aria-hidden="true" tabindex="-1"></a>      ape<span class="sc">::</span><span class="fu">read.tree</span>(anemonefish_tree_file_path) <span class="co"># Default attempt</span></span>
<span id="cb152-27"><a href="#cb152-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb152-28"><a href="#cb152-28" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb152-29"><a href="#cb152-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error loading anemonefish tree:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb152-30"><a href="#cb152-30" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb152-31"><a href="#cb152-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb152-32"><a href="#cb152-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(full_anemonefish_tree) <span class="sc">&amp;&amp;</span> <span class="fu">inherits</span>(full_anemonefish_tree, <span class="st">"phylo"</span>)) {</span>
<span id="cb152-33"><a href="#cb152-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Full anemonefish tree loaded. Original tips:"</span>, <span class="fu">length</span>(full_anemonefish_tree<span class="sc">$</span>tip.label), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-34"><a href="#cb152-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># plot(full_anemonefish_tree, cex = 0.5, main = "Full Loaded Anemonefish Tree (Initial)", type="fan", no.margin=TRUE)</span></span>
<span id="cb152-35"><a href="#cb152-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-36"><a href="#cb152-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 2a. Standardize Tip Labels of the Loaded Tree (CRUCIAL) ---</span></span>
<span id="cb152-37"><a href="#cb152-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This step is highly dependent on the format of YOUR tree file.</span></span>
<span id="cb152-38"><a href="#cb152-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Common operations:</span></span>
<span id="cb152-39"><a href="#cb152-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   - Replace spaces with underscores: full_anemonefish_tree$tip.label &lt;- gsub(" ", "_", full_anemonefish_tree$tip.label)</span></span>
<span id="cb152-40"><a href="#cb152-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   - Remove strain/accession numbers if present, e.g., using str_extract or sub.</span></span>
<span id="cb152-41"><a href="#cb152-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For example, if tips are "Genus species strainXYZ", you might do:</span></span>
<span id="cb152-42"><a href="#cb152-42" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   temp_labels &lt;- gsub(" ", "_", full_anemonefish_tree$tip.label) # First, underscores</span></span>
<span id="cb152-43"><a href="#cb152-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   full_anemonefish_tree$tip.label &lt;- str_extract(temp_labels, "^[A-Za-z]+_[a-z]+") # Keep only Genus_species part</span></span>
<span id="cb152-44"><a href="#cb152-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure the result is Genus_species</span></span>
<span id="cb152-45"><a href="#cb152-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-46"><a href="#cb152-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Example: (assuming your tree already uses Genus_species or you've cleaned it above)</span></span>
<span id="cb152-47"><a href="#cb152-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># full_anemonefish_tree$tip.label &lt;- gsub(" ", "_", full_anemonefish_tree$tip.label) # Basic cleaning</span></span>
<span id="cb152-48"><a href="#cb152-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-49"><a href="#cb152-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"First 10 tip labels from loaded tree (after potential cleaning):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-50"><a href="#cb152-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">head</span>(full_anemonefish_tree<span class="sc">$</span>tip.label, <span class="dv">10</span>))</span>
<span id="cb152-51"><a href="#cb152-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Anemonefish species from your study list (for matching):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-52"><a href="#cb152-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">head</span>(anemonefish_species_in_study_tree_format, <span class="dv">10</span>))</span>
<span id="cb152-53"><a href="#cb152-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-54"><a href="#cb152-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 3. Prune Tree to Studied Species ---</span></span>
<span id="cb152-55"><a href="#cb152-55" aria-hidden="true" tabindex="-1"></a>    species_to_keep_in_tree <span class="ot">&lt;-</span> <span class="fu">intersect</span>(full_anemonefish_tree<span class="sc">$</span>tip.label, anemonefish_species_in_study_tree_format)</span>
<span id="cb152-56"><a href="#cb152-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb152-57"><a href="#cb152-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(species_to_keep_in_tree) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb152-58"><a href="#cb152-58" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"CRITICAL WARNING: No matching species found between your study list and the tree's tip labels after cleaning.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-59"><a href="#cb152-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Please check:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-60"><a href="#cb152-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"1. The `anemonefish_species_in_study_tree_format` list (should be Genus_species).</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-61"><a href="#cb152-61" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"2. The tip labels in your tree file (`"</span>, anemonefish_tree_file_path, <span class="st">"`) and the cleaning step above.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-62"><a href="#cb152-62" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">length</span>(species_to_keep_in_tree) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb152-63"><a href="#cb152-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Warning: Fewer than 2 matching anemonefish species found. Cannot create a meaningful pruned tree.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-64"><a href="#cb152-64" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Matching species found in tree:"</span>, <span class="fu">paste</span>(species_to_keep_in_tree, <span class="at">collapse=</span><span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-65"><a href="#cb152-65" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb152-66"><a href="#cb152-66" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Found"</span>, <span class="fu">length</span>(species_to_keep_in_tree), <span class="st">"matching anemonefish species to keep in the tree.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-67"><a href="#cb152-67" aria-hidden="true" tabindex="-1"></a>      species_to_drop_from_tree <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(full_anemonefish_tree<span class="sc">$</span>tip.label, species_to_keep_in_tree)</span>
<span id="cb152-68"><a href="#cb152-68" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-69"><a href="#cb152-69" aria-hidden="true" tabindex="-1"></a>      pruned_anemonefish_tree <span class="ot">&lt;-</span> ape<span class="sc">::</span><span class="fu">drop.tip</span>(full_anemonefish_tree, species_to_drop_from_tree)</span>
<span id="cb152-70"><a href="#cb152-70" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Pruned anemonefish tree to"</span>, <span class="fu">length</span>(pruned_anemonefish_tree<span class="sc">$</span>tip.label), <span class="st">"species in study.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-71"><a href="#cb152-71" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb152-72"><a href="#cb152-72" aria-hidden="true" tabindex="-1"></a>      <span class="co"># --- 4. Standardize Tip Labels to Short Codes ---</span></span>
<span id="cb152-73"><a href="#cb152-73" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(pruned_anemonefish_tree) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(pruned_anemonefish_tree<span class="sc">$</span>tip.label) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb152-74"><a href="#cb152-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb152-75"><a href="#cb152-75" aria-hidden="true" tabindex="-1"></a>        fish_label_map_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb152-76"><a href="#cb152-76" aria-hidden="true" tabindex="-1"></a>          <span class="at">Original_Genus_Species =</span> pruned_anemonefish_tree<span class="sc">$</span>tip.label, <span class="co"># These are now Genus_species</span></span>
<span id="cb152-77"><a href="#cb152-77" aria-hidden="true" tabindex="-1"></a>          <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb152-78"><a href="#cb152-78" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">%&gt;%</span></span>
<span id="cb152-79"><a href="#cb152-79" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb152-80"><a href="#cb152-80" aria-hidden="true" tabindex="-1"></a>          <span class="at">genus_part =</span> <span class="fu">word</span>(Original_Genus_Species, <span class="dv">1</span>, <span class="at">sep =</span> <span class="st">"_"</span>),</span>
<span id="cb152-81"><a href="#cb152-81" aria-hidden="true" tabindex="-1"></a>          <span class="at">species_part =</span> <span class="fu">word</span>(Original_Genus_Species, <span class="dv">2</span>, <span class="at">sep =</span> <span class="st">"_"</span>),</span>
<span id="cb152-82"><a href="#cb152-82" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Create a more robust short code: First 4 of Genus + First 3 of species</span></span>
<span id="cb152-83"><a href="#cb152-83" aria-hidden="true" tabindex="-1"></a>          <span class="at">short_code_temp =</span> <span class="fu">paste0</span>(</span>
<span id="cb152-84"><a href="#cb152-84" aria-hidden="true" tabindex="-1"></a>            <span class="fu">toupper</span>(<span class="fu">str_sub</span>(genus_part, <span class="dv">1</span>, <span class="fu">min</span>(<span class="dv">4</span>, <span class="fu">nchar</span>(genus_part), <span class="at">na.rm =</span> <span class="cn">TRUE</span>))), </span>
<span id="cb152-85"><a href="#cb152-85" aria-hidden="true" tabindex="-1"></a>            <span class="fu">toupper</span>(<span class="fu">str_sub</span>(species_part, <span class="dv">1</span>, <span class="fu">min</span>(<span class="dv">3</span>, <span class="fu">nchar</span>(species_part), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)))</span>
<span id="cb152-86"><a href="#cb152-86" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb152-87"><a href="#cb152-87" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb152-88"><a href="#cb152-88" aria-hidden="true" tabindex="-1"></a>        fish_label_map_df<span class="sc">$</span>short_code <span class="ot">&lt;-</span> <span class="fu">make.unique</span>(fish_label_map_df<span class="sc">$</span>short_code_temp, <span class="at">sep=</span><span class="st">""</span>)</span>
<span id="cb152-89"><a href="#cb152-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-90"><a href="#cb152-90" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Anemonefish Label Mapping (Genus_species -&gt; Short Code):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-91"><a href="#cb152-91" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(fish_label_map_df[, <span class="fu">c</span>(<span class="st">"Original_Genus_Species"</span>, <span class="st">"short_code"</span>)])</span>
<span id="cb152-92"><a href="#cb152-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb152-93"><a href="#cb152-93" aria-hidden="true" tabindex="-1"></a>        pruned_anemonefish_tree<span class="sc">$</span>tip.label <span class="ot">&lt;-</span> fish_label_map_df<span class="sc">$</span>short_code</span>
<span id="cb152-94"><a href="#cb152-94" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Standardized tip labels for pruned anemonefish tree using short codes.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-95"><a href="#cb152-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb152-96"><a href="#cb152-96" aria-hidden="true" tabindex="-1"></a>        <span class="fu">plot</span>(pruned_anemonefish_tree, <span class="at">cex =</span> <span class="fl">0.8</span>, <span class="at">main =</span> <span class="st">"Pruned Anemonefish Tree (Short Labels)"</span>)</span>
<span id="cb152-97"><a href="#cb152-97" aria-hidden="true" tabindex="-1"></a>        <span class="fu">axisPhylo</span>() <span class="co"># Add a scale bar</span></span>
<span id="cb152-98"><a href="#cb152-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb152-99"><a href="#cb152-99" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Optional: Check if tree is ultrametric</span></span>
<span id="cb152-100"><a href="#cb152-100" aria-hidden="true" tabindex="-1"></a>        <span class="co"># if (length(pruned_anemonefish_tree$edge.length) &gt; 0 &amp;&amp; !anyNA(pruned_anemonefish_tree$edge.length)) {</span></span>
<span id="cb152-101"><a href="#cb152-101" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   is_ultrametric_fish &lt;- is.ultrametric(pruned_anemonefish_tree)</span></span>
<span id="cb152-102"><a href="#cb152-102" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   cat("Is pruned anemonefish tree ultrametric?", is_ultrametric_fish, "\n")</span></span>
<span id="cb152-103"><a href="#cb152-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># } else {</span></span>
<span id="cb152-104"><a href="#cb152-104" aria-hidden="true" tabindex="-1"></a>        <span class="co">#   cat("Cannot check ultrametric status: tree may lack branch lengths or have NAs.\n")</span></span>
<span id="cb152-105"><a href="#cb152-105" aria-hidden="true" tabindex="-1"></a>        <span class="co"># }</span></span>
<span id="cb152-106"><a href="#cb152-106" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb152-107"><a href="#cb152-107" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"Pruned anemonefish tree is NULL or has no tip labels after pruning attempt.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-108"><a href="#cb152-108" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb152-109"><a href="#cb152-109" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb152-110"><a href="#cb152-110" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb152-111"><a href="#cb152-111" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Anemonefish tree could not be loaded or is not a 'phylo' object.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-112"><a href="#cb152-112" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb152-113"><a href="#cb152-113" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb152-114"><a href="#cb152-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Anemonefish phylogeny file not found at:"</span>, anemonefish_tree_file_path, <span class="st">"</span><span class="sc">\n</span><span class="st">Please provide a valid tree file and update the path.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb152-115"><a href="#cb152-115" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loading anemonefish tree from: /Users/chrisrauch/anemonefish_post_analysis/data/phylogeny/anemonefish_phylogeny_OTL.nwk 
Full anemonefish tree loaded. Original tips: 11 
First 10 tip labels from loaded tree (after potential cleaning):
 [1] "Amphiprion_melanopus"    "Amphiprion_akindynos"   
 [3] "Amphiprion_allardi"      "Amphiprion_bicinctus"   
 [5] "Amphiprion_chrysopterus" "Amphiprion_perideraion" 
 [7] "Amphiprion_sandaracinos" "Amphiprion_clarkii"     
 [9] "Premnas_biaculeatus"     "Amphiprion_ocellaris"   
Anemonefish species from your study list (for matching):
 [1] "Amphiprion_akindynos"    "Amphiprion_allardi"     
 [3] "Amphiprion_bicinctus"    "Amphiprion_clarkii"     
 [5] "Amphiprion_frenatus"     "Amphiprion_melanopus"   
 [7] "Amphiprion_ocellaris"    "Amphiprion_percula"     
 [9] "Amphiprion_perideraion"  "Amphiprion_sandaracinos"
Found 10 matching anemonefish species to keep in the tree.
Pruned anemonefish tree to 10 species in study.

Anemonefish Label Mapping (Genus_species -&gt; Short Code):
    Original_Genus_Species short_code
1     Amphiprion_melanopus    AMPHMEL
2     Amphiprion_akindynos    AMPHAKI
3       Amphiprion_allardi    AMPHALL
4     Amphiprion_bicinctus    AMPHBIC
5   Amphiprion_perideraion    AMPHPER
6  Amphiprion_sandaracinos    AMPHSAN
7       Amphiprion_clarkii    AMPHCLA
8      Premnas_biaculeatus    PREMBIA
9     Amphiprion_ocellaris    AMPHOCE
10      Amphiprion_percula   AMPHPER1

Standardized tip labels for pruned anemonefish tree using short codes.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/process-anemonefish-phylogeny-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The object 'pruned_anemonefish_tree' (if created) and 'fish_label_map_df' </span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="co"># are now available for subsequent phylogenetic analyses.</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="co"># If 'pruned_anemonefish_tree' is NULL, subsequent phylogenetic analyses should be skipped.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="schoeners-d-niche-overlap-calculations" class="level2">
<h2 class="anchored" data-anchor-id="schoeners-d-niche-overlap-calculations">Schoener’s D Niche Overlap Calculations</h2>
<p>This section calculates Schoener’s D niche overlap index between each host sea anemone and its potential anemonefish mutualists (using anemonefish environmental-only models). This is done for the current period and projected future scenarios to assess potential changes in spatial co-occurrence.</p>
</section>
<section id="schoeners-d-niche-overlap-calculations-1" class="level2">
<h2 class="anchored" data-anchor-id="schoeners-d-niche-overlap-calculations-1">Schoener’s D Niche Overlap Calculations</h2>
<p>This section calculates Schoener’s D niche overlap index between each host sea anemone and its potential anemonefish mutualists (using anemonefish environmental-only models). This is done for the current period and projected future scenarios to assess potential changes in spatial co-occurrence.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ENMeval) <span class="co"># For calc.niche.overlap</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)   <span class="co"># For pivot_longer, pivot_wider</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrplot)</span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># For str_replace_all</span></span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Verify Prerequisites ---</span></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_pred_stack_cropped"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(host_pred_stack_cropped)) {</span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`host_pred_stack_cropped` not found. Run previous chunks."</span>)</span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_pred_stack_cropped"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(fish_pred_stack_cropped)) {</span>
<span id="cb155-13"><a href="#cb155-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`fish_pred_stack_cropped` (env-only models) not found. Run previous chunks."</span>)</span>
<span id="cb155-14"><a href="#cb155-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-15"><a href="#cb155-15" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_pred_stacks_future_individual"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.list</span>(host_pred_stacks_future_individual)) {</span>
<span id="cb155-16"><a href="#cb155-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`host_pred_stacks_future_individual` not found or not a list. Run previous chunks."</span>)</span>
<span id="cb155-17"><a href="#cb155-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-18"><a href="#cb155-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_pred_stacks_future_individual"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.list</span>(fish_pred_stacks_future_individual)) {</span>
<span id="cb155-19"><a href="#cb155-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`fish_pred_stacks_future_individual` (env-only models) not found or not a list. Run previous chunks."</span>)</span>
<span id="cb155-20"><a href="#cb155-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-21"><a href="#cb155-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"future_scenarios_to_load"</span>)) {</span>
<span id="cb155-22"><a href="#cb155-22" aria-hidden="true" tabindex="-1"></a>  future_scenarios_to_load <span class="ot">&lt;-</span> config<span class="sc">$</span>env_scenarios[config<span class="sc">$</span>env_scenarios <span class="sc">!=</span> <span class="st">"current"</span>]</span>
<span id="cb155-23"><a href="#cb155-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(future_scenarios_to_load) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No future scenarios defined."</span>)</span>
<span id="cb155-24"><a href="#cb155-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-25"><a href="#cb155-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"anemone_species_df"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"anemonefish_species_df"</span>)) {</span>
<span id="cb155-26"><a href="#cb155-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Species data frames (anemone_species_df, anemonefish_species_df) not found."</span>)</span>
<span id="cb155-27"><a href="#cb155-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb155-28"><a href="#cb155-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-29"><a href="#cb155-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-30"><a href="#cb155-30" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Calculate Current Overlap ---</span></span>
<span id="cb155-31"><a href="#cb155-31" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Calculating Current Niche Overlap (Schoener's D) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calculating Current Niche Overlap (Schoener's D) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure layer names are consistent and usable (Genus_species format)</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>names_hosts_current <span class="ot">&lt;-</span> <span class="fu">names</span>(host_pred_stack_cropped)</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>names_fish_current <span class="ot">&lt;-</span> <span class="fu">names</span>(fish_pred_stack_cropped) <span class="co"># These are from env-only models</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>all_preds_current_for_overlap <span class="ot">&lt;-</span> <span class="fu">c</span>(host_pred_stack_cropped, fish_pred_stack_cropped)</span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure all layer names are unique before stacking for calc.niche.overlap</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a><span class="co"># This shouldn't be an issue if host and fish names are distinct.</span></span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">duplicated</span>(<span class="fu">names</span>(all_preds_current_for_overlap)))){</span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"Duplicate layer names found before calculating current overlap. This may cause issues."</span>)</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>overlap_current_matrix_d <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(all_preds_current_for_overlap) <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>  overlap_current_matrix_d <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>    ENMeval<span class="sc">::</span><span class="fu">calc.niche.overlap</span>(all_preds_current_for_overlap, <span class="st">"D"</span>)</span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Error calculating current niche overlap:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough layers in the combined current stack to calculate overlap.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Error calculating current niche overlap: unable to find an inherited method for function 'nlayers' for signature 'x = "SpatRaster"' </code></pre>
</div>
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="co"># if (is.null(overlap_current_matrix_d)) {</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   stop("Failed to calculate current niche overlap matrix. Cannot proceed.")</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="co"># cat("Current niche overlap matrix (Schoener's D) calculated.\n")</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="co"># # --- 2. Calculate Future Overlaps (Loop through scenarios) ---</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="co"># overlap_future_matrices_d &lt;- list()</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="co"># for (scenario_name_fut in future_scenarios_to_load) {</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("\n--- Calculating Future Niche Overlap for Scenario:", scenario_name_fut, "---\n")</span></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   current_future_host_stack_indiv &lt;- host_pred_stacks_future_individual[[scenario_name_fut]]</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   current_future_fish_stack_indiv &lt;- fish_pred_stacks_future_individual[[scenario_name_fut]] # Env-only models</span></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (is.null(current_future_host_stack_indiv) || terra::nlyr(current_future_host_stack_indiv) == 0 ||</span></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a><span class="co">#       is.null(current_future_fish_stack_indiv) || terra::nlyr(current_future_fish_stack_indiv) == 0) {</span></span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("  Skipping scenario", scenario_name_fut, "- missing future host or fish prediction stacks.\n")</span></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a><span class="co">#     overlap_future_matrices_d[[scenario_name_fut]] &lt;- NULL</span></span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a><span class="co">#     next</span></span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Important: Ensure layer names in future stacks match the order and content of current stacks</span></span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   # This assumes the lists of species (and thus layers) are consistent.</span></span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   # The loading chunk should have named them correctly as Genus_species.</span></span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   all_preds_future_for_overlap &lt;- c(current_future_host_stack_indiv, current_future_fish_stack_indiv)</span></span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (any(duplicated(names(all_preds_future_for_overlap)))){</span></span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a><span class="co">#     warning("Duplicate layer names found before calculating future overlap for ", scenario_name_fut, ". This may cause issues.")</span></span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (terra::nlyr(all_preds_future_for_overlap) &gt;= 2) {</span></span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     overlap_future_matrices_d[[scenario_name_fut]] &lt;- tryCatch({</span></span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a><span class="co">#       # Align future stack geometry with current stack geometry for calcNicheOverlap robustness</span></span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a><span class="co">#       if(!terra::compareGeom(all_preds_current_for_overlap, all_preds_future_for_overlap, stopOnError=FALSE, res=TRUE, crs=TRUE, ext=TRUE)){</span></span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a><span class="co">#           cat("   Resampling future combined stack for scenario", scenario_name_fut, "to match current geometry.\n")</span></span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a><span class="co">#           all_preds_future_for_overlap &lt;- terra::resample(all_preds_future_for_overlap, all_preds_current_for_overlap, method="bilinear")</span></span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a><span class="co">#       }</span></span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a><span class="co">#       ENMeval::calc.niche.overlap(all_preds_future_for_overlap, "D")</span></span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     }, error = function(e) {</span></span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a><span class="co">#       cat("  Error calculating future niche overlap for", scenario_name_fut, ":", e$message, "\n"); NULL</span></span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a><span class="co">#     })</span></span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (!is.null(overlap_future_matrices_d[[scenario_name_fut]])) {</span></span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a><span class="co">#       cat("  Future niche overlap matrix (Schoener's D) calculated for", scenario_name_fut, "\n")</span></span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb159-46"><a href="#cb159-46" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb159-47"><a href="#cb159-47" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("  Not enough layers in combined future stack for", scenario_name_fut, "to calculate overlap.\n")</span></span>
<span id="cb159-48"><a href="#cb159-48" aria-hidden="true" tabindex="-1"></a><span class="co">#     overlap_future_matrices_d[[scenario_name_fut]] &lt;- NULL</span></span>
<span id="cb159-49"><a href="#cb159-49" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb159-50"><a href="#cb159-50" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb159-51"><a href="#cb159-51" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-52"><a href="#cb159-52" aria-hidden="true" tabindex="-1"></a><span class="co"># # --- 3. Process and Compare Overlap Matrices ---</span></span>
<span id="cb159-53"><a href="#cb159-53" aria-hidden="true" tabindex="-1"></a><span class="co"># # Ensure names_hosts_current and names_fish_current are Genus_species format</span></span>
<span id="cb159-54"><a href="#cb159-54" aria-hidden="true" tabindex="-1"></a><span class="co"># valid_host_rows &lt;- intersect(names_hosts_current, rownames(overlap_current_matrix_d))</span></span>
<span id="cb159-55"><a href="#cb159-55" aria-hidden="true" tabindex="-1"></a><span class="co"># valid_fish_cols &lt;- intersect(names_fish_current, colnames(overlap_current_matrix_d))</span></span>
<span id="cb159-56"><a href="#cb159-56" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-57"><a href="#cb159-57" aria-hidden="true" tabindex="-1"></a><span class="co"># if (length(valid_host_rows) == 0 || length(valid_fish_cols) == 0) {</span></span>
<span id="cb159-58"><a href="#cb159-58" aria-hidden="true" tabindex="-1"></a><span class="co">#   stop("No valid host or fish names found to subset the current overlap matrix. Check layer naming of input stacks.")</span></span>
<span id="cb159-59"><a href="#cb159-59" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb159-60"><a href="#cb159-60" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-61"><a href="#cb159-61" aria-hidden="true" tabindex="-1"></a><span class="co"># # Extract the host-fish interaction part of the matrix</span></span>
<span id="cb159-62"><a href="#cb159-62" aria-hidden="true" tabindex="-1"></a><span class="co"># current_host_fish_overlap_raw &lt;- overlap_current_matrix_d[valid_host_rows, valid_fish_cols, drop = FALSE]</span></span>
<span id="cb159-63"><a href="#cb159-63" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-64"><a href="#cb159-64" aria-hidden="true" tabindex="-1"></a><span class="co"># # Convert to long format</span></span>
<span id="cb159-65"><a href="#cb159-65" aria-hidden="true" tabindex="-1"></a><span class="co"># current_host_fish_overlap_long &lt;- current_host_fish_overlap_raw %&gt;%</span></span>
<span id="cb159-66"><a href="#cb159-66" aria-hidden="true" tabindex="-1"></a><span class="co">#   as.data.frame() %&gt;%</span></span>
<span id="cb159-67"><a href="#cb159-67" aria-hidden="true" tabindex="-1"></a><span class="co">#   tibble::rownames_to_column("host_species") %&gt;%</span></span>
<span id="cb159-68"><a href="#cb159-68" aria-hidden="true" tabindex="-1"></a><span class="co">#   pivot_longer(cols = -host_species, names_to = "fish_species", values_to = "overlap_current")</span></span>
<span id="cb159-69"><a href="#cb159-69" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-70"><a href="#cb159-70" aria-hidden="true" tabindex="-1"></a><span class="co"># cat("\nMean current overlap (Schoener's D) between all host-fish pairs:", round(mean(current_host_fish_overlap_long$overlap_current, na.rm = TRUE), 3), "\n")</span></span>
<span id="cb159-71"><a href="#cb159-71" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-72"><a href="#cb159-72" aria-hidden="true" tabindex="-1"></a><span class="co"># # --- Choose scenarios for detailed comparison (e.g., SSP1-1.9 2050 and SSP5-8.5 2100) ---</span></span>
<span id="cb159-73"><a href="#cb159-73" aria-hidden="true" tabindex="-1"></a><span class="co"># # These names must match the keys in overlap_future_matrices_d and config$env_scenarios</span></span>
<span id="cb159-74"><a href="#cb159-74" aria-hidden="true" tabindex="-1"></a><span class="co"># scenarios_for_detailed_comparison &lt;- intersect(c("ssp119_2050", "ssp585_2100"), names(overlap_future_matrices_d))</span></span>
<span id="cb159-75"><a href="#cb159-75" aria-hidden="true" tabindex="-1"></a><span class="co"># if(length(scenarios_for_detailed_comparison) == 0) {</span></span>
<span id="cb159-76"><a href="#cb159-76" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("Warning: None of the specified detailed comparison scenarios (ssp119_2050, ssp585_2100) have overlap data. Plotting will be skipped for them.\n")</span></span>
<span id="cb159-77"><a href="#cb159-77" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span>
<span id="cb159-78"><a href="#cb159-78" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-79"><a href="#cb159-79" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-80"><a href="#cb159-80" aria-hidden="true" tabindex="-1"></a><span class="co"># # --- Loop through chosen future scenarios for t-tests and plots ---</span></span>
<span id="cb159-81"><a href="#cb159-81" aria-hidden="true" tabindex="-1"></a><span class="co"># for (chosen_future_scenario in scenarios_for_detailed_comparison) {</span></span>
<span id="cb159-82"><a href="#cb159-82" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("\n--- Detailed Comparison for Future Scenario:", chosen_future_scenario, "---\n")</span></span>
<span id="cb159-83"><a href="#cb159-83" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-84"><a href="#cb159-84" aria-hidden="true" tabindex="-1"></a><span class="co">#   overlap_future_chosen_matrix &lt;- overlap_future_matrices_d[[chosen_future_scenario]]</span></span>
<span id="cb159-85"><a href="#cb159-85" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (is.null(overlap_future_chosen_matrix)) {</span></span>
<span id="cb159-86"><a href="#cb159-86" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("  No future overlap matrix available for", chosen_future_scenario, ". Skipping detailed comparison.\n")</span></span>
<span id="cb159-87"><a href="#cb159-87" aria-hidden="true" tabindex="-1"></a><span class="co">#     next</span></span>
<span id="cb159-88"><a href="#cb159-88" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb159-89"><a href="#cb159-89" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-90"><a href="#cb159-90" aria-hidden="true" tabindex="-1"></a><span class="co">#   future_host_fish_overlap_raw_chosen &lt;- overlap_future_chosen_matrix[valid_host_rows, valid_fish_cols, drop = FALSE]</span></span>
<span id="cb159-91"><a href="#cb159-91" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-92"><a href="#cb159-92" aria-hidden="true" tabindex="-1"></a><span class="co">#   future_host_fish_overlap_long_chosen &lt;- future_host_fish_overlap_raw_chosen %&gt;%</span></span>
<span id="cb159-93"><a href="#cb159-93" aria-hidden="true" tabindex="-1"></a><span class="co">#     as.data.frame() %&gt;%</span></span>
<span id="cb159-94"><a href="#cb159-94" aria-hidden="true" tabindex="-1"></a><span class="co">#     tibble::rownames_to_column("host_species") %&gt;%</span></span>
<span id="cb159-95"><a href="#cb159-95" aria-hidden="true" tabindex="-1"></a><span class="co">#     pivot_longer(cols = -host_species, names_to = "fish_species", values_to = "overlap_future")</span></span>
<span id="cb159-96"><a href="#cb159-96" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-97"><a href="#cb159-97" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("Mean future overlap (Schoener's D) for", chosen_future_scenario, ":", round(mean(future_host_fish_overlap_long_chosen$overlap_future, na.rm = TRUE), 3), "\n")</span></span>
<span id="cb159-98"><a href="#cb159-98" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-99"><a href="#cb159-99" aria-hidden="true" tabindex="-1"></a><span class="co">#   comparison_df &lt;- current_host_fish_overlap_long %&gt;%</span></span>
<span id="cb159-100"><a href="#cb159-100" aria-hidden="true" tabindex="-1"></a><span class="co">#     left_join(future_host_fish_overlap_long_chosen, by = c("host_species", "fish_species")) %&gt;%</span></span>
<span id="cb159-101"><a href="#cb159-101" aria-hidden="true" tabindex="-1"></a><span class="co">#     filter(!is.na(overlap_current), !is.na(overlap_future))</span></span>
<span id="cb159-102"><a href="#cb159-102" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-103"><a href="#cb159-103" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (nrow(comparison_df) &gt; 1) {</span></span>
<span id="cb159-104"><a href="#cb159-104" aria-hidden="true" tabindex="-1"></a><span class="co">#     ttest_result &lt;- t.test(comparison_df$overlap_current, comparison_df$overlap_future, paired = TRUE)</span></span>
<span id="cb159-105"><a href="#cb159-105" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("\nPaired t-test: Current vs Future (", chosen_future_scenario, ") Overlap:\n")</span></span>
<span id="cb159-106"><a href="#cb159-106" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(ttest_result)</span></span>
<span id="cb159-107"><a href="#cb159-107" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-108"><a href="#cb159-108" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Scatter Plot</span></span>
<span id="cb159-109"><a href="#cb159-109" aria-hidden="true" tabindex="-1"></a><span class="co">#     plot_scatter &lt;- ggplot(comparison_df, aes(x = overlap_current, y = overlap_future)) +</span></span>
<span id="cb159-110"><a href="#cb159-110" aria-hidden="true" tabindex="-1"></a><span class="co">#       geom_point(alpha = 0.6, color = "darkblue") +</span></span>
<span id="cb159-111"><a href="#cb159-111" aria-hidden="true" tabindex="-1"></a><span class="co">#       geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "red") +</span></span>
<span id="cb159-112"><a href="#cb159-112" aria-hidden="true" tabindex="-1"></a><span class="co">#       xlim(0, 1) + ylim(0, 1) +</span></span>
<span id="cb159-113"><a href="#cb159-113" aria-hidden="true" tabindex="-1"></a><span class="co">#       labs(</span></span>
<span id="cb159-114"><a href="#cb159-114" aria-hidden="true" tabindex="-1"></a><span class="co">#         title = paste("Niche Overlap Change:", chosen_future_scenario, "vs Current"),</span></span>
<span id="cb159-115"><a href="#cb159-115" aria-hidden="true" tabindex="-1"></a><span class="co">#         x = "Schoener's D (Current Conditions)",</span></span>
<span id="cb159-116"><a href="#cb159-116" aria-hidden="true" tabindex="-1"></a><span class="co">#         y = paste("Schoener's D (Future -", chosen_future_scenario, ")")</span></span>
<span id="cb159-117"><a href="#cb159-117" aria-hidden="true" tabindex="-1"></a><span class="co">#       ) +</span></span>
<span id="cb159-118"><a href="#cb159-118" aria-hidden="true" tabindex="-1"></a><span class="co">#       theme_bw(base_size = 12) +</span></span>
<span id="cb159-119"><a href="#cb159-119" aria-hidden="true" tabindex="-1"></a><span class="co">#       coord_fixed()</span></span>
<span id="cb159-120"><a href="#cb159-120" aria-hidden="true" tabindex="-1"></a><span class="co">#     print(plot_scatter)</span></span>
<span id="cb159-121"><a href="#cb159-121" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-122"><a href="#cb159-122" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Proportional Change Matrix Plot</span></span>
<span id="cb159-123"><a href="#cb159-123" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Prepare display names (full scientific names with spaces)</span></span>
<span id="cb159-124"><a href="#cb159-124" aria-hidden="true" tabindex="-1"></a><span class="co">#     host_display_names_map &lt;- anemone_species_df %&gt;%</span></span>
<span id="cb159-125"><a href="#cb159-125" aria-hidden="true" tabindex="-1"></a><span class="co">#       select(scientificName) %&gt;%</span></span>
<span id="cb159-126"><a href="#cb159-126" aria-hidden="true" tabindex="-1"></a><span class="co">#       mutate(sanitized_name = gsub(" ", "_", scientificName)) %&gt;%</span></span>
<span id="cb159-127"><a href="#cb159-127" aria-hidden="true" tabindex="-1"></a><span class="co">#       distinct(sanitized_name, .keep_all = TRUE) %&gt;%</span></span>
<span id="cb159-128"><a href="#cb159-128" aria-hidden="true" tabindex="-1"></a><span class="co">#       tibble::deframe()</span></span>
<span id="cb159-129"><a href="#cb159-129" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-130"><a href="#cb159-130" aria-hidden="true" tabindex="-1"></a><span class="co">#     fish_display_names_map &lt;- anemonefish_species_df %&gt;%</span></span>
<span id="cb159-131"><a href="#cb159-131" aria-hidden="true" tabindex="-1"></a><span class="co">#       select(scientificName) %&gt;%</span></span>
<span id="cb159-132"><a href="#cb159-132" aria-hidden="true" tabindex="-1"></a><span class="co">#       mutate(sanitized_name = gsub(" ", "_", scientificName)) %&gt;%</span></span>
<span id="cb159-133"><a href="#cb159-133" aria-hidden="true" tabindex="-1"></a><span class="co">#       distinct(sanitized_name, .keep_all = TRUE) %&gt;%</span></span>
<span id="cb159-134"><a href="#cb159-134" aria-hidden="true" tabindex="-1"></a><span class="co">#       tibble::deframe()</span></span>
<span id="cb159-135"><a href="#cb159-135" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-136"><a href="#cb159-136" aria-hidden="true" tabindex="-1"></a><span class="co">#     prop_change_df &lt;- comparison_df %&gt;%</span></span>
<span id="cb159-137"><a href="#cb159-137" aria-hidden="true" tabindex="-1"></a><span class="co">#       mutate(</span></span>
<span id="cb159-138"><a href="#cb159-138" aria-hidden="true" tabindex="-1"></a><span class="co">#         proportional_change = case_when(</span></span>
<span id="cb159-139"><a href="#cb159-139" aria-hidden="true" tabindex="-1"></a><span class="co">#           overlap_current == 0 &amp; overlap_future == 0 ~ 0, # Both zero, no change</span></span>
<span id="cb159-140"><a href="#cb159-140" aria-hidden="true" tabindex="-1"></a><span class="co">#           overlap_current == 0 &amp; overlap_future &gt; 0  ~ 1, # New overlap, max positive change</span></span>
<span id="cb159-141"><a href="#cb159-141" aria-hidden="true" tabindex="-1"></a><span class="co">#           overlap_current &gt; 0  &amp; overlap_future == 0 ~ -1, # Lost overlap, max negative change</span></span>
<span id="cb159-142"><a href="#cb159-142" aria-hidden="true" tabindex="-1"></a><span class="co">#           overlap_current &gt; 0                         ~ (overlap_future - overlap_current) / overlap_current,</span></span>
<span id="cb159-143"><a href="#cb159-143" aria-hidden="true" tabindex="-1"></a><span class="co">#           TRUE                                        ~ NA_real_ # Should not happen if filtered NAs</span></span>
<span id="cb159-144"><a href="#cb159-144" aria-hidden="true" tabindex="-1"></a><span class="co">#         )</span></span>
<span id="cb159-145"><a href="#cb159-145" aria-hidden="true" tabindex="-1"></a><span class="co">#       ) %&gt;%</span></span>
<span id="cb159-146"><a href="#cb159-146" aria-hidden="true" tabindex="-1"></a><span class="co">#       mutate(proportional_change_capped = pmax(-1, pmin(1, proportional_change))) %&gt;%</span></span>
<span id="cb159-147"><a href="#cb159-147" aria-hidden="true" tabindex="-1"></a><span class="co">#       select(host_species, fish_species, proportional_change_capped)</span></span>
<span id="cb159-148"><a href="#cb159-148" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-149"><a href="#cb159-149" aria-hidden="true" tabindex="-1"></a><span class="co">#     if(nrow(prop_change_df) &gt; 0) {</span></span>
<span id="cb159-150"><a href="#cb159-150" aria-hidden="true" tabindex="-1"></a><span class="co">#         prop_change_matrix &lt;- prop_change_df %&gt;%</span></span>
<span id="cb159-151"><a href="#cb159-151" aria-hidden="true" tabindex="-1"></a><span class="co">#           pivot_wider(names_from = fish_species, values_from = proportional_change_capped) %&gt;%</span></span>
<span id="cb159-152"><a href="#cb159-152" aria-hidden="true" tabindex="-1"></a><span class="co">#           tibble::column_to_rownames("host_species") %&gt;%</span></span>
<span id="cb159-153"><a href="#cb159-153" aria-hidden="true" tabindex="-1"></a><span class="co">#           as.matrix()</span></span>
<span id="cb159-154"><a href="#cb159-154" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-155"><a href="#cb159-155" aria-hidden="true" tabindex="-1"></a><span class="co">#         # Use display names if mapping is successful</span></span>
<span id="cb159-156"><a href="#cb159-156" aria-hidden="true" tabindex="-1"></a><span class="co">#         rownames_display &lt;- host_display_names_map[rownames(prop_change_matrix)]</span></span>
<span id="cb159-157"><a href="#cb159-157" aria-hidden="true" tabindex="-1"></a><span class="co">#         colnames_display &lt;- fish_display_names_map[colnames(prop_change_matrix)]</span></span>
<span id="cb159-158"><a href="#cb159-158" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-159"><a href="#cb159-159" aria-hidden="true" tabindex="-1"></a><span class="co">#         # Fallback if any name not found in map</span></span>
<span id="cb159-160"><a href="#cb159-160" aria-hidden="true" tabindex="-1"></a><span class="co">#         rownames(prop_change_matrix) &lt;- ifelse(is.na(rownames_display), rownames(prop_change_matrix), rownames_display)</span></span>
<span id="cb159-161"><a href="#cb159-161" aria-hidden="true" tabindex="-1"></a><span class="co">#         colnames(prop_change_matrix) &lt;- ifelse(is.na(colnames_display), colnames(prop_change_matrix), colnames_display)</span></span>
<span id="cb159-162"><a href="#cb159-162" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-163"><a href="#cb159-163" aria-hidden="true" tabindex="-1"></a><span class="co">#         if(nrow(prop_change_matrix) &gt; 0 &amp;&amp; ncol(prop_change_matrix) &gt; 0) {</span></span>
<span id="cb159-164"><a href="#cb159-164" aria-hidden="true" tabindex="-1"></a><span class="co">#           corrplot::corrplot(prop_change_matrix,</span></span>
<span id="cb159-165"><a href="#cb159-165" aria-hidden="true" tabindex="-1"></a><span class="co">#                            method = "circle", is.corr = FALSE, tl.srt = 60, tl.col = 'black',</span></span>
<span id="cb159-166"><a href="#cb159-166" aria-hidden="true" tabindex="-1"></a><span class="co">#                            tl.cex = 0.6, cl.cex = 0.7,</span></span>
<span id="cb159-167"><a href="#cb159-167" aria-hidden="true" tabindex="-1"></a><span class="co">#                            col.lim = c(-1, 1),</span></span>
<span id="cb159-168"><a href="#cb159-168" aria-hidden="true" tabindex="-1"></a><span class="co">#                            col = colorRampPalette(c("firebrick3", "white", "dodgerblue3"))(200),</span></span>
<span id="cb159-169"><a href="#cb159-169" aria-hidden="true" tabindex="-1"></a><span class="co">#                            title = paste("Proportional Change in Host-Fish Overlap\n(", chosen_future_scenario, " vs Current)"),</span></span>
<span id="cb159-170"><a href="#cb159-170" aria-hidden="true" tabindex="-1"></a><span class="co">#                            mar = c(0,0,2,0)) # Adjusted margins for title</span></span>
<span id="cb159-171"><a href="#cb159-171" aria-hidden="true" tabindex="-1"></a><span class="co">#         } else {cat("  Not enough data to create proportional change matrix plot for", chosen_future_scenario, "\n")}</span></span>
<span id="cb159-172"><a href="#cb159-172" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {cat("  No data for proportional change calculation for", chosen_future_scenario, "\n")}</span></span>
<span id="cb159-173"><a href="#cb159-173" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else { cat("  Not enough paired overlap data for t-test or plotting for", chosen_future_scenario, "\n") }</span></span>
<span id="cb159-174"><a href="#cb159-174" aria-hidden="true" tabindex="-1"></a><span class="co"># } # End loop chosen_future_scenario</span></span>
<span id="cb159-175"><a href="#cb159-175" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb159-176"><a href="#cb159-176" aria-hidden="true" tabindex="-1"></a><span class="co"># cat("\n--- Schoener's D calculations and comparisons finished. ---\n")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="phylogenetic-signal-of-anemonefish-niche-overlap" class="level2">
<h2 class="anchored" data-anchor-id="phylogenetic-signal-of-anemonefish-niche-overlap">Phylogenetic Signal of Anemonefish Niche Overlap</h2>
<p>This section tests for phylogenetic signal in the niche overlap values among anemonefish species (using environmental-only models). This is done for the current period and a selected future scenario to see if the relationship between phylogeny and overlap changes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(picante) </span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ape)     </span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(pruned_anemonefish_tree)) {</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: `pruned_anemonefish_tree` not available. Skipping phylogenetic signal of fish-fish overlap.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">is.null</span>(overlap_current_matrix_d) <span class="sc">||</span> </span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>           <span class="fu">length</span>(<span class="fu">intersect</span>(pruned_anemonefish_tree<span class="sc">$</span>tip.label, fish_label_map_df<span class="sc">$</span>short_code[fish_label_map_df<span class="sc">$</span>Original_Genus_Species <span class="sc">%in%</span> names_fish_current])) <span class="sc">&lt;</span> <span class="dv">2</span>) { </span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: Current overlap matrix or mapping to tree tips insufficient for anemonefish. Skipping phylogenetic signal of fish-fish overlap.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"--- Calculating Phylogenetic Signal of Anemonefish-Anemonefish Niche Overlap ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb160-12"><a href="#cb160-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 1. Create phylogenetic distance matrix for anemonefish ---</span></span>
<span id="cb160-13"><a href="#cb160-13" aria-hidden="true" tabindex="-1"></a>  fish_phy_dist_matrix <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb160-14"><a href="#cb160-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(pruned_anemonefish_tree<span class="sc">$</span>edge.length) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">anyNA</span>(pruned_anemonefish_tree<span class="sc">$</span>edge.length)) {</span>
<span id="cb160-15"><a href="#cb160-15" aria-hidden="true" tabindex="-1"></a>      fish_phy_dist_matrix <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(ape<span class="sc">::</span><span class="fu">cophenetic.phylo</span>(pruned_anemonefish_tree), <span class="at">error =</span> <span class="cf">function</span>(e){</span>
<span id="cb160-16"><a href="#cb160-16" aria-hidden="true" tabindex="-1"></a>          <span class="fu">cat</span>(<span class="st">"Error creating phylogenetic distance matrix:"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb160-17"><a href="#cb160-17" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb160-18"><a href="#cb160-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb160-19"><a href="#cb160-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Warning: Pruned anemonefish tree lacks branch lengths or has NAs; cannot calculate cophenetic distances for Mantel test.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-20"><a href="#cb160-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-21"><a href="#cb160-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-22"><a href="#cb160-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure fish_label_map_df is available (should be from phylogeny chunk)</span></span>
<span id="cb160-23"><a href="#cb160-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_label_map_df"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(fish_label_map_df)) {</span>
<span id="cb160-24"><a href="#cb160-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">stop</span>(<span class="st">"`fish_label_map_df` (mapping short codes to Genus_species) is missing."</span>)</span>
<span id="cb160-25"><a href="#cb160-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-26"><a href="#cb160-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-27"><a href="#cb160-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Function to perform Mantel test for a given overlap matrix ---</span></span>
<span id="cb160-28"><a href="#cb160-28" aria-hidden="true" tabindex="-1"></a>  perform_overlap_mantel_test <span class="ot">&lt;-</span> <span class="cf">function</span>(overlap_matrix, matrix_label, phy_dist_matrix, tree_tips_short_codes, label_map_df) {</span>
<span id="cb160-29"><a href="#cb160-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Processing Mantel Test for:"</span>, matrix_label, <span class="st">"---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-30"><a href="#cb160-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-31"><a href="#cb160-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(overlap_matrix) <span class="sc">||</span> <span class="fu">is.null</span>(phy_dist_matrix)) {</span>
<span id="cb160-32"><a href="#cb160-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Skipping Mantel test for"</span>, matrix_label, <span class="st">"- missing overlap or phylogenetic distance matrix.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-33"><a href="#cb160-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb160-34"><a href="#cb160-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-35"><a href="#cb160-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-36"><a href="#cb160-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map short codes on tree back to Genus_species to subset the full overlap matrix</span></span>
<span id="cb160-37"><a href="#cb160-37" aria-hidden="true" tabindex="-1"></a>    genus_species_for_tree_tips_local <span class="ot">&lt;-</span> label_map_df<span class="sc">$</span>Original_Genus_Species[<span class="fu">match</span>(tree_tips_short_codes, label_map_df<span class="sc">$</span>short_code)]</span>
<span id="cb160-38"><a href="#cb160-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-39"><a href="#cb160-39" aria-hidden="true" tabindex="-1"></a>    valid_fish_for_overlap_subset <span class="ot">&lt;-</span> <span class="fu">intersect</span>(genus_species_for_tree_tips_local, <span class="fu">colnames</span>(overlap_matrix))</span>
<span id="cb160-40"><a href="#cb160-40" aria-hidden="true" tabindex="-1"></a>    valid_fish_for_overlap_subset <span class="ot">&lt;-</span> <span class="fu">intersect</span>(valid_fish_for_overlap_subset, <span class="fu">rownames</span>(overlap_matrix))</span>
<span id="cb160-41"><a href="#cb160-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-42"><a href="#cb160-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(valid_fish_for_overlap_subset) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb160-43"><a href="#cb160-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Less than 2 anemonefish species with both tree data and overlap data for"</span>, matrix_label, <span class="st">". Skipping Mantel test.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-44"><a href="#cb160-44" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb160-45"><a href="#cb160-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-46"><a href="#cb160-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-47"><a href="#cb160-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset the full overlap matrix to only include these fish species</span></span>
<span id="cb160-48"><a href="#cb160-48" aria-hidden="true" tabindex="-1"></a>    fish_fish_overlap_submatrix_local <span class="ot">&lt;-</span> overlap_matrix[valid_fish_for_overlap_subset, valid_fish_for_overlap_subset, drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb160-49"><a href="#cb160-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-50"><a href="#cb160-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert overlap (similarity) to dissimilarity (1 - D)</span></span>
<span id="cb160-51"><a href="#cb160-51" aria-hidden="true" tabindex="-1"></a>    fish_fish_dissimilarity_matrix_local <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> fish_fish_overlap_submatrix_local</span>
<span id="cb160-52"><a href="#cb160-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-53"><a href="#cb160-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename rows/cols of dissimilarity matrix to short codes for matching with phy_dist_matrix</span></span>
<span id="cb160-54"><a href="#cb160-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rownames</span>(fish_fish_dissimilarity_matrix_local) <span class="ot">&lt;-</span> label_map_df<span class="sc">$</span>short_code[<span class="fu">match</span>(<span class="fu">rownames</span>(fish_fish_dissimilarity_matrix_local), label_map_df<span class="sc">$</span>Original_Genus_Species)]</span>
<span id="cb160-55"><a href="#cb160-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colnames</span>(fish_fish_dissimilarity_matrix_local) <span class="ot">&lt;-</span> label_map_df<span class="sc">$</span>short_code[<span class="fu">match</span>(<span class="fu">colnames</span>(fish_fish_dissimilarity_matrix_local), label_map_df<span class="sc">$</span>Original_Genus_Species)]</span>
<span id="cb160-56"><a href="#cb160-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-57"><a href="#cb160-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure phy_dist_matrix also uses short codes (it should from previous chunk)</span></span>
<span id="cb160-58"><a href="#cb160-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Match order of phy_dist_matrix and dissimilarity_matrix</span></span>
<span id="cb160-59"><a href="#cb160-59" aria-hidden="true" tabindex="-1"></a>    common_short_codes_for_mantel <span class="ot">&lt;-</span> <span class="fu">intersect</span>(<span class="fu">rownames</span>(phy_dist_matrix), <span class="fu">rownames</span>(fish_fish_dissimilarity_matrix_local))</span>
<span id="cb160-60"><a href="#cb160-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-61"><a href="#cb160-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(common_short_codes_for_mantel) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb160-62"><a href="#cb160-62" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Not enough common species with short codes between phy_dist and overlap_dist for"</span>, matrix_label, <span class="st">". Skipping Mantel.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-63"><a href="#cb160-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb160-64"><a href="#cb160-64" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-65"><a href="#cb160-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-66"><a href="#cb160-66" aria-hidden="true" tabindex="-1"></a>    phy_dist_final <span class="ot">&lt;-</span> phy_dist_matrix[common_short_codes_for_mantel, common_short_codes_for_mantel]</span>
<span id="cb160-67"><a href="#cb160-67" aria-hidden="true" tabindex="-1"></a>    dissim_final <span class="ot">&lt;-</span> fish_fish_dissimilarity_matrix_local[common_short_codes_for_mantel, common_short_codes_for_mantel]</span>
<span id="cb160-68"><a href="#cb160-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-69"><a href="#cb160-69" aria-hidden="true" tabindex="-1"></a>    mantel_result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb160-70"><a href="#cb160-70" aria-hidden="true" tabindex="-1"></a>      vegan<span class="sc">::</span><span class="fu">mantel</span>(<span class="fu">as.dist</span>(phy_dist_final), <span class="fu">as.dist</span>(dissim_final), <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">permutations =</span> <span class="dv">999</span>)</span>
<span id="cb160-71"><a href="#cb160-71" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e){<span class="fu">cat</span>(<span class="st">"  Error during Mantel test for"</span>, matrix_label, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span>})</span>
<span id="cb160-72"><a href="#cb160-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-73"><a href="#cb160-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(mantel_result)) {</span>
<span id="cb160-74"><a href="#cb160-74" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Mantel Test Results for"</span>, matrix_label, <span class="st">":</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-75"><a href="#cb160-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(mantel_result)</span>
<span id="cb160-76"><a href="#cb160-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb160-77"><a href="#cb160-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(mantel_result)</span>
<span id="cb160-78"><a href="#cb160-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-79"><a href="#cb160-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-80"><a href="#cb160-80" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 2. Current Anemonefish-Anemonefish Overlap Mantel Test ---</span></span>
<span id="cb160-81"><a href="#cb160-81" aria-hidden="true" tabindex="-1"></a>  mantel_current_fish_overlap <span class="ot">&lt;-</span> <span class="fu">perform_overlap_mantel_test</span>(</span>
<span id="cb160-82"><a href="#cb160-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">overlap_matrix =</span> overlap_current_matrix_d, </span>
<span id="cb160-83"><a href="#cb160-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">matrix_label =</span> <span class="st">"Current Anemonefish-Anemonefish Overlap"</span>,</span>
<span id="cb160-84"><a href="#cb160-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">phy_dist_matrix =</span> fish_phy_dist_matrix,</span>
<span id="cb160-85"><a href="#cb160-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">tree_tips_short_codes =</span> pruned_anemonefish_tree<span class="sc">$</span>tip.label,</span>
<span id="cb160-86"><a href="#cb160-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">label_map_df =</span> fish_label_map_df</span>
<span id="cb160-87"><a href="#cb160-87" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb160-88"><a href="#cb160-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-89"><a href="#cb160-89" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- 3. Future Anemonefish-Anemonefish Overlap Mantel Test (for a selected scenario) ---</span></span>
<span id="cb160-90"><a href="#cb160-90" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Choose ONE future scenario to test here, e.g., the "worst-case" or most interesting one.</span></span>
<span id="cb160-91"><a href="#cb160-91" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure this chosen_future_scenario_for_mantel was processed in the Schoener's D section.</span></span>
<span id="cb160-92"><a href="#cb160-92" aria-hidden="true" tabindex="-1"></a>  chosen_future_scenario_for_mantel <span class="ot">&lt;-</span> <span class="st">"ssp585_2100"</span> <span class="co"># Or "ssp119_2050", etc.</span></span>
<span id="cb160-93"><a href="#cb160-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-94"><a href="#cb160-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (chosen_future_scenario_for_mantel <span class="sc">%in%</span> <span class="fu">names</span>(overlap_future_matrices_d) <span class="sc">&amp;&amp;</span> </span>
<span id="cb160-95"><a href="#cb160-95" aria-hidden="true" tabindex="-1"></a>      <span class="sc">!</span><span class="fu">is.null</span>(overlap_future_matrices_d[[chosen_future_scenario_for_mantel]])) {</span>
<span id="cb160-96"><a href="#cb160-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-97"><a href="#cb160-97" aria-hidden="true" tabindex="-1"></a>    overlap_future_chosen_for_mantel <span class="ot">&lt;-</span> overlap_future_matrices_d[[chosen_future_scenario_for_mantel]]</span>
<span id="cb160-98"><a href="#cb160-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb160-99"><a href="#cb160-99" aria-hidden="true" tabindex="-1"></a>    mantel_future_fish_overlap <span class="ot">&lt;-</span> <span class="fu">perform_overlap_mantel_test</span>(</span>
<span id="cb160-100"><a href="#cb160-100" aria-hidden="true" tabindex="-1"></a>      <span class="at">overlap_matrix =</span> overlap_future_chosen_for_mantel,</span>
<span id="cb160-101"><a href="#cb160-101" aria-hidden="true" tabindex="-1"></a>      <span class="at">matrix_label =</span> <span class="fu">paste</span>(<span class="st">"Future ("</span>, chosen_future_scenario_for_mantel, <span class="st">") Anemonefish-Anemonefish Overlap"</span>),</span>
<span id="cb160-102"><a href="#cb160-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">phy_dist_matrix =</span> fish_phy_dist_matrix,</span>
<span id="cb160-103"><a href="#cb160-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">tree_tips_short_codes =</span> pruned_anemonefish_tree<span class="sc">$</span>tip.label,</span>
<span id="cb160-104"><a href="#cb160-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">label_map_df =</span> fish_label_map_df</span>
<span id="cb160-105"><a href="#cb160-105" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb160-106"><a href="#cb160-106" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb160-107"><a href="#cb160-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Overlap data for future scenario '"</span>, chosen_future_scenario_for_mantel, <span class="st">"' not available for Mantel test.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb160-108"><a href="#cb160-108" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb160-109"><a href="#cb160-109" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Warning: Current overlap matrix or mapping to tree tips insufficient for anemonefish. Skipping phylogenetic signal of fish-fish overlap.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Phylogenetic signal of overlap analysis finished. ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Phylogenetic signal of overlap analysis finished. ---</code></pre>
</div>
</div>
<section id="levins-b-niche-breadth-current-predictions" class="level3">
<h3 class="anchored" data-anchor-id="levins-b-niche-breadth-current-predictions">Levin’s B Niche Breadth (Current Predictions)</h3>
<p>This section calculates Levin’s B (<span class="math inline">\(B_2\)</span>) niche breadth metric for each host sea anemone species and each anemonefish species (using their environmental-only model predictions for the current period). This metric quantifies the uniformity of a species’ predicted suitability across its range. We then compare the mean niche breadth between the two guilds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ENMTools) <span class="co"># For raster.breadth</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure the current individual prediction stacks are available and cropped</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(host_pred_stack_cropped) <span class="sc">||</span> <span class="sc">!</span><span class="fu">inherits</span>(host_pred_stack_cropped, <span class="st">"SpatRaster"</span>)) {</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`host_pred_stack_cropped` is not available or not a SpatRaster. Run previous chunks."</span>)</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(fish_pred_stack_cropped) <span class="sc">||</span> <span class="sc">!</span><span class="fu">inherits</span>(fish_pred_stack_cropped, <span class="st">"SpatRaster"</span>)) {</span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`fish_pred_stack_cropped` (for env-only fish models) is not available or not a SpatRaster. Run previous chunks."</span>)</span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Calculate Niche Breadth for Host Sea Anemones ---</span></span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Calculating Levin's B Niche Breadth for Host Sea Anemones (Current) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Calculating Levin's B Niche Breadth for Host Sea Anemones (Current) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb166"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>host_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">species_name_sanitized =</span> <span class="fu">character</span>(<span class="dv">0</span>), </span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B1 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), </span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B2 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb166-6"><a href="#cb166-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb166-7"><a href="#cb166-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-8"><a href="#cb166-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stack_cropped) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb166-9"><a href="#cb166-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(host_pred_stack_cropped)) {</span>
<span id="cb166-10"><a href="#cb166-10" aria-hidden="true" tabindex="-1"></a>    species_raster_host <span class="ot">&lt;-</span> host_pred_stack_cropped[[i]]</span>
<span id="cb166-11"><a href="#cb166-11" aria-hidden="true" tabindex="-1"></a>    sp_name_host <span class="ot">&lt;-</span> <span class="fu">names</span>(species_raster_host)</span>
<span id="cb166-12"><a href="#cb166-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Calculating breadth for host:"</span>, sp_name_host, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb166-13"><a href="#cb166-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(species_raster_host, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Suitability - Host:"</span>, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>, <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">" "</span>,sp_name_host)))) <span class="co"># Optional plot</span></span>
<span id="cb166-14"><a href="#cb166-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-15"><a href="#cb166-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># raster.breadth expects a SpatRaster, which species_raster_host should be</span></span>
<span id="cb166-16"><a href="#cb166-16" aria-hidden="true" tabindex="-1"></a>    breadth_metrics_host <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb166-17"><a href="#cb166-17" aria-hidden="true" tabindex="-1"></a>      ENMTools<span class="sc">::</span><span class="fu">raster.breadth</span>(species_raster_host)</span>
<span id="cb166-18"><a href="#cb166-18" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb166-19"><a href="#cb166-19" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Could not calculate breadth for host"</span>, sp_name_host, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb166-20"><a href="#cb166-20" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb166-21"><a href="#cb166-21" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb166-22"><a href="#cb166-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb166-23"><a href="#cb166-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(breadth_metrics_host)) {</span>
<span id="cb166-24"><a href="#cb166-24" aria-hidden="true" tabindex="-1"></a>      host_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(host_niche_breadth_df, </span>
<span id="cb166-25"><a href="#cb166-25" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">data.frame</span>(<span class="at">species_name_sanitized =</span> sp_name_host, </span>
<span id="cb166-26"><a href="#cb166-26" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B1 =</span> breadth_metrics_host<span class="sc">$</span>B1, </span>
<span id="cb166-27"><a href="#cb166-27" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B2 =</span> breadth_metrics_host<span class="sc">$</span>B2))</span>
<span id="cb166-28"><a href="#cb166-28" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb166-29"><a href="#cb166-29" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb166-30"><a href="#cb166-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Finished calculating niche breadth for hosts.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb166-31"><a href="#cb166-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(host_niche_breadth_df)</span>
<span id="cb166-32"><a href="#cb166-32" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb166-33"><a href="#cb166-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No host anemone prediction layers to calculate breadth for.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb166-34"><a href="#cb166-34" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Entacmaea_quadricolor </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Radianthus_crispa </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Radianthus_magnifica </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-3.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Stichodactyla_gigantea </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-4.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Cryptodendrum_adhaesivum </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-5.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Macrodactyla_doreensis </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-6.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Stichodactyla_mertensii </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-7.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Stichodactyla_haddoni </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-8.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for host: Heteractis_aurora </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-9.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Finished calculating niche breadth for hosts.
    species_name_sanitized levins_B1  levins_B2
1    Entacmaea_quadricolor 0.9487079 0.31708852
2        Radianthus_crispa 0.9510363 0.33339440
3     Radianthus_magnifica 0.9545604 0.36129102
4   Stichodactyla_gigantea 0.8765756 0.08076168
5 Cryptodendrum_adhaesivum 0.9380122 0.24577914
6   Macrodactyla_doreensis 0.9546025 0.35393160
7  Stichodactyla_mertensii 0.9729445 0.48461691
8    Stichodactyla_haddoni 0.8946006 0.12371092
9        Heteractis_aurora 0.9728344 0.48266046</code></pre>
</div>
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Calculate Niche Breadth for Anemonefish (Environmental-Only Models) ---</span></span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Calculating Levin's B Niche Breadth for Anemonefish (Env-Only, Current) ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Calculating Levin's B Niche Breadth for Anemonefish (Env-Only, Current) ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a>fish_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">species_name_sanitized =</span> <span class="fu">character</span>(<span class="dv">0</span>), </span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B1 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>), </span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">levins_B2 =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stack_cropped) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>terra<span class="sc">::</span><span class="fu">nlyr</span>(fish_pred_stack_cropped)) {</span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a>    species_raster_fish <span class="ot">&lt;-</span> fish_pred_stack_cropped[[i]]</span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a>    sp_name_fish <span class="ot">&lt;-</span> <span class="fu">names</span>(species_raster_fish)</span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Calculating breadth for anemonefish:"</span>, sp_name_fish, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(species_raster_fish, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Suitability - Anemonefish:"</span>, <span class="fu">gsub</span>(<span class="st">" "</span>, <span class="st">"_"</span>, sp_name_fish))) <span class="co"># Optional plot</span></span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a>    breadth_metrics_fish <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>      ENMTools<span class="sc">::</span><span class="fu">raster.breadth</span>(species_raster_fish)</span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb179-18"><a href="#cb179-18" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Could not calculate breadth for fish"</span>, sp_name_fish, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb179-19"><a href="#cb179-19" aria-hidden="true" tabindex="-1"></a>      <span class="cn">NULL</span></span>
<span id="cb179-20"><a href="#cb179-20" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb179-21"><a href="#cb179-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb179-22"><a href="#cb179-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(breadth_metrics_fish)) {</span>
<span id="cb179-23"><a href="#cb179-23" aria-hidden="true" tabindex="-1"></a>      fish_niche_breadth_df <span class="ot">&lt;-</span> <span class="fu">rbind</span>(fish_niche_breadth_df, </span>
<span id="cb179-24"><a href="#cb179-24" aria-hidden="true" tabindex="-1"></a>                                     <span class="fu">data.frame</span>(<span class="at">species_name_sanitized =</span> sp_name_fish, </span>
<span id="cb179-25"><a href="#cb179-25" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B1 =</span> breadth_metrics_fish<span class="sc">$</span>B1, </span>
<span id="cb179-26"><a href="#cb179-26" aria-hidden="true" tabindex="-1"></a>                                                <span class="at">levins_B2 =</span> breadth_metrics_fish<span class="sc">$</span>B2))</span>
<span id="cb179-27"><a href="#cb179-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb179-28"><a href="#cb179-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb179-29"><a href="#cb179-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Finished calculating niche breadth for anemonefish (env-only).</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb179-30"><a href="#cb179-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(fish_niche_breadth_df)</span>
<span id="cb179-31"><a href="#cb179-31" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb179-32"><a href="#cb179-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No anemonefish (env-only) prediction layers to calculate breadth for.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb179-33"><a href="#cb179-33" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_clarkii </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-10.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_frenatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-11.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_ocellaris </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-12.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_perideraion </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-13.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_sandaracinos </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-14.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_bicinctus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-15.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_melanopus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-16.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Amphiprion_percula </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-17.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  Calculating breadth for anemonefish: Premnas_biaculeatus </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/levin-b-niche-breadth-18.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Finished calculating niche breadth for anemonefish (env-only).
   species_name_sanitized levins_B1  levins_B2
1      Amphiprion_clarkii 0.9534190 0.32107380
2     Amphiprion_frenatus 0.9672948 0.43437449
3    Amphiprion_ocellaris 0.9677888 0.44780564
4  Amphiprion_perideraion 0.9485461 0.32505843
5 Amphiprion_sandaracinos 0.9879873 0.73027757
6    Amphiprion_bicinctus 0.7925756 0.01809207
7    Amphiprion_melanopus 0.9211864 0.21311662
8      Amphiprion_percula 0.9774183 0.58313482
9     Premnas_biaculeatus 0.9349325 0.26584255</code></pre>
</div>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Compare Mean Niche Breadth (Levin's B2) ---</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(host_niche_breadth_df) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_niche_breadth_df) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Comparing Mean Niche Breadth (Levin's B2) between Guilds ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform t-test if both groups have data for B2</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"levins_B2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(host_niche_breadth_df) <span class="sc">&amp;&amp;</span> <span class="st">"levins_B2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(fish_niche_breadth_df)) {</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove rows with NA in levins_B2 for a fair comparison</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>    valid_hosts_b2 <span class="ot">&lt;-</span> host_niche_breadth_df<span class="sc">$</span>levins_B2[<span class="sc">!</span><span class="fu">is.na</span>(host_niche_breadth_df<span class="sc">$</span>levins_B2)]</span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a>    valid_fish_b2 <span class="ot">&lt;-</span> fish_niche_breadth_df<span class="sc">$</span>levins_B2[<span class="sc">!</span><span class="fu">is.na</span>(fish_niche_breadth_df<span class="sc">$</span>levins_B2)]</span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(valid_hosts_b2) <span class="sc">&gt;</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(valid_fish_b2) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>      ttest_breadth_b2 <span class="ot">&lt;-</span> <span class="fu">t.test</span>(valid_hosts_b2, valid_fish_b2)</span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Welch Two Sample t-test for Levin's B2 (Hosts vs. Fish Env-Only):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(ttest_breadth_b2)</span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"Not enough valid B2 values for t-test after removing NAs.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Standard Deviation of Levin's B2:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Hosts:"</span>, <span class="fu">sd</span>(valid_hosts_b2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb190-22"><a href="#cb190-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Anemonefish:"</span>, <span class="fu">sd</span>(valid_fish_b2, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb190-23"><a href="#cb190-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb190-24"><a href="#cb190-24" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb190-25"><a href="#cb190-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Levin's B2 column not found in one or both breadth data frames.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb190-26"><a href="#cb190-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb190-27"><a href="#cb190-27" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb190-28"><a href="#cb190-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough data to compare niche breadths between hosts and anemonefish.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb190-29"><a href="#cb190-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Comparing Mean Niche Breadth (Levin's B2) between Guilds ---
Welch Two Sample t-test for Levin's B2 (Hosts vs. Fish Env-Only):

    Welch Two Sample t-test

data:  valid_hosts_b2 and valid_fish_b2
t = -0.73634, df = 13.981, p-value = 0.4737
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -0.2415452  0.1180916
sample estimates:
mean of x mean of y 
0.3092483 0.3709751 


Standard Deviation of Levin's B2:
  Hosts: 0.1400152 
  Anemonefish: 0.2089047 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The data frames 'host_niche_breadth_df' and 'fish_niche_breadth_df' are now available.</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a><span class="co"># They contain species names and their Levin's B1 and B2 values.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="niche-breadth-vs.-suitability-shifts-a-comparative-analysis" class="level2">
<h2 class="anchored" data-anchor-id="niche-breadth-vs.-suitability-shifts-a-comparative-analysis">Niche Breadth vs.&nbsp;Suitability Shifts: A Comparative Analysis</h2>
<p>This section explores the relationship between current environmental niche breadth (Levin’s B2) and projected mean suitability shifts under future climate scenarios. The analysis is performed separately for host sea anemones and for anemonefish. For anemonefish, a further distinction is made based on their host specialization (Generalist: &gt;3 host species; Specialist: ≤3 host species) to investigate if the degree of host dependency influences their response patterns. Correlation tests are performed for each group and scenario, and the relationships are visualized to identify potential links between a species’ current niche characteristics and its vulnerability or resilience to environmental change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb193"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb193-1"><a href="#cb193-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Ensure prerequisite data is available ---</span></span>
<span id="cb193-2"><a href="#cb193-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"host_niche_breadth_df"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">exists</span>(<span class="st">"fish_niche_breadth_df"</span>)) {</span>
<span id="cb193-3"><a href="#cb193-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Niche breadth data frames ('host_niche_breadth_df', 'fish_niche_breadth_df') not found. Run previous chunk."</span>)</span>
<span id="cb193-4"><a href="#cb193-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb193-5"><a href="#cb193-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"suitability_shifts_list"</span>) <span class="sc">||</span> <span class="sc">!</span><span class="fu">is.list</span>(suitability_shifts_list) <span class="sc">||</span> <span class="fu">length</span>(suitability_shifts_list) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb193-6"><a href="#cb193-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`suitability_shifts_list` not found or empty. Run 'Individual Species Suitability Shifts' chunk."</span>)</span>
<span id="cb193-7"><a href="#cb193-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb193-8"><a href="#cb193-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"future_scenarios_to_load"</span>) <span class="sc">||</span> <span class="fu">length</span>(future_scenarios_to_load) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb193-9"><a href="#cb193-9" aria-hidden="true" tabindex="-1"></a>  future_scenarios_to_load <span class="ot">&lt;-</span> config<span class="sc">$</span>env_scenarios[config<span class="sc">$</span>env_scenarios <span class="sc">!=</span> <span class="st">"current"</span>]</span>
<span id="cb193-10"><a href="#cb193-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(future_scenarios_to_load) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No future scenarios defined."</span>)</span>
<span id="cb193-11"><a href="#cb193-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb193-12"><a href="#cb193-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"anemonefish_specialization_df"</span>) <span class="sc">||</span> <span class="fu">is.null</span>(anemonefish_specialization_df)) {</span>
<span id="cb193-13"><a href="#cb193-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"`anemonefish_specialization_df` not found. Ensure the 'AUC Improvement by Host Specialization' chunk has run."</span>)</span>
<span id="cb193-14"><a href="#cb193-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb193-15"><a href="#cb193-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-16"><a href="#cb193-16" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Prepare Host Anemone Data (Breadth and Shifts) ---</span></span>
<span id="cb193-17"><a href="#cb193-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Processing Host Anemone Breadth vs. Suitability Shift ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Processing Host Anemone Breadth vs. Suitability Shift ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a>host_breadth_shifts_df_final <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb195-2"><a href="#cb195-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(host_niche_breadth_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb195-3"><a href="#cb195-3" aria-hidden="true" tabindex="-1"></a>  host_breadth_shifts_df_temp <span class="ot">&lt;-</span> host_niche_breadth_df <span class="sc">%&gt;%</span></span>
<span id="cb195-4"><a href="#cb195-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species_name_sanitized, <span class="at">breadth_B2 =</span> levins_B2)</span>
<span id="cb195-5"><a href="#cb195-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-6"><a href="#cb195-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb195-7"><a href="#cb195-7" aria-hidden="true" tabindex="-1"></a>    shift_data_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"hosts_"</span>, scenario_name)</span>
<span id="cb195-8"><a href="#cb195-8" aria-hidden="true" tabindex="-1"></a>    shift_col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"shift_"</span>, <span class="fu">gsub</span>(<span class="st">"ssp"</span>, <span class="st">""</span>, scenario_name))</span>
<span id="cb195-9"><a href="#cb195-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb195-10"><a href="#cb195-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (shift_data_name <span class="sc">%in%</span> <span class="fu">names</span>(suitability_shifts_list) <span class="sc">&amp;&amp;</span> </span>
<span id="cb195-11"><a href="#cb195-11" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">is.null</span>(suitability_shifts_list[[shift_data_name]]) <span class="sc">&amp;&amp;</span></span>
<span id="cb195-12"><a href="#cb195-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nrow</span>(suitability_shifts_list[[shift_data_name]]) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb195-13"><a href="#cb195-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb195-14"><a href="#cb195-14" aria-hidden="true" tabindex="-1"></a>      temp_shift_df <span class="ot">&lt;-</span> suitability_shifts_list[[shift_data_name]] <span class="sc">%&gt;%</span></span>
<span id="cb195-15"><a href="#cb195-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb195-16"><a href="#cb195-16" aria-hidden="true" tabindex="-1"></a>        tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="st">"species_name_sanitized"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb195-17"><a href="#cb195-17" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(species_name_sanitized, <span class="at">mean_suitability_shift =</span> mean)</span>
<span id="cb195-18"><a href="#cb195-18" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb195-19"><a href="#cb195-19" aria-hidden="true" tabindex="-1"></a>      host_breadth_shifts_df_temp <span class="ot">&lt;-</span> host_breadth_shifts_df_temp <span class="sc">%&gt;%</span></span>
<span id="cb195-20"><a href="#cb195-20" aria-hidden="true" tabindex="-1"></a>        <span class="fu">left_join</span>(temp_shift_df <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="sc">!!</span><span class="at">shift_col_name :=</span> mean_suitability_shift), </span>
<span id="cb195-21"><a href="#cb195-21" aria-hidden="true" tabindex="-1"></a>                  <span class="at">by =</span> <span class="st">"species_name_sanitized"</span>)</span>
<span id="cb195-22"><a href="#cb195-22" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb195-23"><a href="#cb195-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Shift data for hosts in scenario '"</span>, scenario_name, <span class="st">"' ("</span>, shift_data_name, <span class="st">") not found or empty. Column '"</span>, shift_col_name, <span class="st">"' will be NA.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-24"><a href="#cb195-24" aria-hidden="true" tabindex="-1"></a>      host_breadth_shifts_df_temp[[shift_col_name]] <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb195-25"><a href="#cb195-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb195-26"><a href="#cb195-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-27"><a href="#cb195-27" aria-hidden="true" tabindex="-1"></a>  host_breadth_shifts_df_final <span class="ot">&lt;-</span> host_breadth_shifts_df_temp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(breadth_B2))</span>
<span id="cb195-28"><a href="#cb195-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Host anemone data prepared for breadth vs. shift analysis:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-29"><a href="#cb195-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(host_breadth_shifts_df_final)) <span class="fu">print</span>(<span class="fu">head</span>(host_breadth_shifts_df_final))</span>
<span id="cb195-30"><a href="#cb195-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-31"><a href="#cb195-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb195-32"><a href="#cb195-32" aria-hidden="true" tabindex="-1"></a>    shift_col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"shift_"</span>, <span class="fu">gsub</span>(<span class="st">"ssp"</span>, <span class="st">""</span>, scenario_name))</span>
<span id="cb195-33"><a href="#cb195-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (shift_col_name <span class="sc">%in%</span> <span class="fu">names</span>(host_breadth_shifts_df_final)) {</span>
<span id="cb195-34"><a href="#cb195-34" aria-hidden="true" tabindex="-1"></a>      temp_df_cor_host <span class="ot">&lt;-</span> host_breadth_shifts_df_final <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(breadth_B2, <span class="sc">!!</span><span class="fu">sym</span>(shift_col_name)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb195-35"><a href="#cb195-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(temp_df_cor_host) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb195-36"><a href="#cb195-36" aria-hidden="true" tabindex="-1"></a>        cor_test_host <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(temp_df_cor_host<span class="sc">$</span>breadth_B2, temp_df_cor_host[[shift_col_name]], <span class="at">method =</span> <span class="st">"pearson"</span>)</span>
<span id="cb195-37"><a href="#cb195-37" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Correlation (Host Anemones) - Breadth vs. Shift ("</span>, scenario_name, <span class="st">" / "</span>, shift_col_name, <span class="st">"):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-38"><a href="#cb195-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(cor_test_host)</span>
<span id="cb195-39"><a href="#cb195-39" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb195-40"><a href="#cb195-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Not enough data points to calculate correlation for hosts in scenario:"</span>, scenario_name, <span class="st">"(column:"</span>, shift_col_name, <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-41"><a href="#cb195-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb195-42"><a href="#cb195-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb195-43"><a href="#cb195-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb195-44"><a href="#cb195-44" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb195-45"><a href="#cb195-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No host niche breadth data available.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb195-46"><a href="#cb195-46" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Host anemone data prepared for breadth vs. shift analysis:
    species_name_sanitized breadth_B2 shift_119_2050 shift_119_2100
1    Entacmaea_quadricolor 0.31708852  -4.536062e-03  -5.777601e-03
2        Radianthus_crispa 0.33339440  -4.662851e-03  -5.393897e-03
3     Radianthus_magnifica 0.36129102   1.172640e-03   2.408147e-03
4   Stichodactyla_gigantea 0.08076168  -9.529433e-05  -3.060088e-05
5 Cryptodendrum_adhaesivum 0.24577914  -8.915561e-04  -8.644091e-04
6   Macrodactyla_doreensis 0.35393160  -1.270136e-04   3.262492e-04
  shift_585_2050 shift_585_2100
1  -0.0041680105   -0.004510062
2  -0.0043324000   -0.002180768
3   0.0016854196    0.007370588
4  -0.0004299020   -0.002440418
5  -0.0002721739    0.005271087
6   0.0002342935    0.003954837

Correlation (Host Anemones) - Breadth vs. Shift ( ssp119_2050  /  shift_119_2050 ):

    Pearson's product-moment correlation

data:  temp_df_cor_host$breadth_B2 and temp_df_cor_host[[shift_col_name]]
t = -0.33645, df = 7, p-value = 0.7464
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.7291824  0.5871626
sample estimates:
       cor 
-0.1261516 


Correlation (Host Anemones) - Breadth vs. Shift ( ssp119_2100  /  shift_119_2100 ):

    Pearson's product-moment correlation

data:  temp_df_cor_host$breadth_B2 and temp_df_cor_host[[shift_col_name]]
t = -0.50016, df = 7, p-value = 0.6323
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.7565459  0.5456850
sample estimates:
       cor 
-0.1857543 


Correlation (Host Anemones) - Breadth vs. Shift ( ssp585_2050  /  shift_585_2050 ):

    Pearson's product-moment correlation

data:  temp_df_cor_host$breadth_B2 and temp_df_cor_host[[shift_col_name]]
t = -0.0085861, df = 7, p-value = 0.9934
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.6659317  0.6623039
sample estimates:
         cor 
-0.003245242 


Correlation (Host Anemones) - Breadth vs. Shift ( ssp585_2100  /  shift_585_2100 ):

    Pearson's product-moment correlation

data:  temp_df_cor_host$breadth_B2 and temp_df_cor_host[[shift_col_name]]
t = 0.45055, df = 7, p-value = 0.6659
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.5585163  0.7485415
sample estimates:
      cor 
0.1678736 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Prepare Anemonefish (Env-Only) Data (Breadth, Shifts, and Specialization) ---</span></span>
<span id="cb197-2"><a href="#cb197-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Processing Anemonefish (Env-Only) Breadth vs. Suitability Shift with Specialization ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Processing Anemonefish (Env-Only) Breadth vs. Suitability Shift with Specialization ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>fish_breadth_shifts_df_final <span class="ot">&lt;-</span> <span class="cn">NULL</span> </span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(fish_niche_breadth_df) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>  fish_breadth_shifts_df_temp <span class="ot">&lt;-</span> fish_niche_breadth_df <span class="sc">%&gt;%</span></span>
<span id="cb199-4"><a href="#cb199-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(species_name_sanitized, <span class="at">breadth_B2 =</span> levins_B2) <span class="sc">%&gt;%</span></span>
<span id="cb199-5"><a href="#cb199-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(anemonefish_specialization_df <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(species, specialization_type, n_hosts), </span>
<span id="cb199-6"><a href="#cb199-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"species_name_sanitized"</span> <span class="ot">=</span> <span class="st">"species"</span>))</span>
<span id="cb199-7"><a href="#cb199-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-8"><a href="#cb199-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb199-9"><a href="#cb199-9" aria-hidden="true" tabindex="-1"></a>    shift_data_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"fish_env_only_"</span>, scenario_name)</span>
<span id="cb199-10"><a href="#cb199-10" aria-hidden="true" tabindex="-1"></a>    shift_col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"shift_"</span>, <span class="fu">gsub</span>(<span class="st">"ssp"</span>, <span class="st">""</span>, scenario_name))</span>
<span id="cb199-11"><a href="#cb199-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb199-12"><a href="#cb199-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (shift_data_name <span class="sc">%in%</span> <span class="fu">names</span>(suitability_shifts_list) <span class="sc">&amp;&amp;</span> </span>
<span id="cb199-13"><a href="#cb199-13" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span><span class="fu">is.null</span>(suitability_shifts_list[[shift_data_name]]) <span class="sc">&amp;&amp;</span></span>
<span id="cb199-14"><a href="#cb199-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nrow</span>(suitability_shifts_list[[shift_data_name]]) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb199-15"><a href="#cb199-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb199-16"><a href="#cb199-16" aria-hidden="true" tabindex="-1"></a>      temp_shift_df_fish <span class="ot">&lt;-</span> suitability_shifts_list[[shift_data_name]] <span class="sc">%&gt;%</span></span>
<span id="cb199-17"><a href="#cb199-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb199-18"><a href="#cb199-18" aria-hidden="true" tabindex="-1"></a>        tibble<span class="sc">::</span><span class="fu">rownames_to_column</span>(<span class="st">"species_name_sanitized"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb199-19"><a href="#cb199-19" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(species_name_sanitized, <span class="at">mean_suitability_shift =</span> mean)</span>
<span id="cb199-20"><a href="#cb199-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb199-21"><a href="#cb199-21" aria-hidden="true" tabindex="-1"></a>      fish_breadth_shifts_df_temp <span class="ot">&lt;-</span> fish_breadth_shifts_df_temp <span class="sc">%&gt;%</span></span>
<span id="cb199-22"><a href="#cb199-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">left_join</span>(temp_shift_df_fish <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="sc">!!</span><span class="at">shift_col_name :=</span> mean_suitability_shift), </span>
<span id="cb199-23"><a href="#cb199-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">by =</span> <span class="st">"species_name_sanitized"</span>)</span>
<span id="cb199-24"><a href="#cb199-24" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb199-25"><a href="#cb199-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"  Warning: Shift data for anemonefish (env-only) in scenario '"</span>, scenario_name, <span class="st">"' ("</span>, shift_data_name, <span class="st">") not found or empty. Column '"</span>, shift_col_name, <span class="st">"' will be NA.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb199-26"><a href="#cb199-26" aria-hidden="true" tabindex="-1"></a>      fish_breadth_shifts_df_temp[[shift_col_name]] <span class="ot">&lt;-</span> <span class="cn">NA_real_</span></span>
<span id="cb199-27"><a href="#cb199-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb199-28"><a href="#cb199-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb199-29"><a href="#cb199-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb199-30"><a href="#cb199-30" aria-hidden="true" tabindex="-1"></a>  fish_breadth_shifts_df_final <span class="ot">&lt;-</span> fish_breadth_shifts_df_temp <span class="sc">%&gt;%</span> </span>
<span id="cb199-31"><a href="#cb199-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(breadth_B2), <span class="sc">!</span><span class="fu">is.na</span>(specialization_type)) </span>
<span id="cb199-32"><a href="#cb199-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb199-33"><a href="#cb199-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Anemonefish (env-only) data prepared for breadth vs. shift analysis (with specialization):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb199-34"><a href="#cb199-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fish_breadth_shifts_df_final)) <span class="fu">print</span>(<span class="fu">head</span>(fish_breadth_shifts_df_final))</span>
<span id="cb199-35"><a href="#cb199-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-36"><a href="#cb199-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (scenario_name <span class="cf">in</span> future_scenarios_to_load) {</span>
<span id="cb199-37"><a href="#cb199-37" aria-hidden="true" tabindex="-1"></a>    shift_col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"shift_"</span>, <span class="fu">gsub</span>(<span class="st">"ssp"</span>, <span class="st">""</span>, scenario_name))</span>
<span id="cb199-38"><a href="#cb199-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (shift_col_name <span class="sc">%in%</span> <span class="fu">names</span>(fish_breadth_shifts_df_final)) {</span>
<span id="cb199-39"><a href="#cb199-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Correlations (Anemonefish Env-Only) - Breadth vs. Shift ("</span>, scenario_name, <span class="st">" / "</span>, shift_col_name, <span class="st">"):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb199-40"><a href="#cb199-40" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb199-41"><a href="#cb199-41" aria-hidden="true" tabindex="-1"></a>      temp_df_cor_fish_gen <span class="ot">&lt;-</span> fish_breadth_shifts_df_final <span class="sc">%&gt;%</span> </span>
<span id="cb199-42"><a href="#cb199-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(specialization_type <span class="sc">==</span> <span class="st">"Generalist"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb199-43"><a href="#cb199-43" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(breadth_B2, <span class="sc">!!</span><span class="fu">sym</span>(shift_col_name)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb199-44"><a href="#cb199-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(temp_df_cor_fish_gen) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb199-45"><a href="#cb199-45" aria-hidden="true" tabindex="-1"></a>        cor_test_fish_gen <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(temp_df_cor_fish_gen<span class="sc">$</span>breadth_B2, temp_df_cor_fish_gen[[shift_col_name]], <span class="at">method =</span> <span class="st">"pearson"</span>)</span>
<span id="cb199-46"><a href="#cb199-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Generalists:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb199-47"><a href="#cb199-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(cor_test_fish_gen)</span>
<span id="cb199-48"><a href="#cb199-48" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb199-49"><a href="#cb199-49" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Not enough data points for Generalists in scenario:"</span>, scenario_name, <span class="st">"(column:"</span>, shift_col_name, <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb199-50"><a href="#cb199-50" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb199-51"><a href="#cb199-51" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb199-52"><a href="#cb199-52" aria-hidden="true" tabindex="-1"></a>      temp_df_cor_fish_spec <span class="ot">&lt;-</span> fish_breadth_shifts_df_final <span class="sc">%&gt;%</span> </span>
<span id="cb199-53"><a href="#cb199-53" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(specialization_type <span class="sc">==</span> <span class="st">"Specialist"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb199-54"><a href="#cb199-54" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(breadth_B2, <span class="sc">!!</span><span class="fu">sym</span>(shift_col_name)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb199-55"><a href="#cb199-55" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="fu">nrow</span>(temp_df_cor_fish_spec) <span class="sc">&gt;</span> <span class="dv">2</span>){</span>
<span id="cb199-56"><a href="#cb199-56" aria-hidden="true" tabindex="-1"></a>        cor_test_fish_spec <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(temp_df_cor_fish_spec<span class="sc">$</span>breadth_B2, temp_df_cor_fish_spec[[shift_col_name]], <span class="at">method =</span> <span class="st">"pearson"</span>)</span>
<span id="cb199-57"><a href="#cb199-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Specialists:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb199-58"><a href="#cb199-58" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(cor_test_fish_spec)</span>
<span id="cb199-59"><a href="#cb199-59" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb199-60"><a href="#cb199-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Not enough data points for Specialists in scenario:"</span>, scenario_name, <span class="st">"(column:"</span>, shift_col_name, <span class="st">")</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb199-61"><a href="#cb199-61" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb199-62"><a href="#cb199-62" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb199-63"><a href="#cb199-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb199-64"><a href="#cb199-64" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb199-65"><a href="#cb199-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No anemonefish (env-only) niche breadth data available.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb199-66"><a href="#cb199-66" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anemonefish (env-only) data prepared for breadth vs. shift analysis (with specialization):
   species_name_sanitized breadth_B2 specialization_type n_hosts shift_119_2050
1      Amphiprion_clarkii 0.32107380          Generalist       9  -0.0016777802
2     Amphiprion_frenatus 0.43437449          Specialist       1  -0.0015232340
3    Amphiprion_ocellaris 0.44780564          Specialist       3   0.0028460673
4  Amphiprion_perideraion 0.32505843          Generalist       4  -0.0021970801
5 Amphiprion_sandaracinos 0.73027757          Specialist       2   0.0002772930
6    Amphiprion_bicinctus 0.01809207          Generalist       5   0.0002352739
  shift_119_2100 shift_585_2050 shift_585_2100
1  -0.0010189554   -0.001508720  -0.0009159086
2  -0.0016409124   -0.001463652  -0.0016335876
3   0.0034756333    0.003555805   0.0080385175
4  -0.0010267538   -0.001297647   0.0070513576
5   0.0012590236    0.003035596   0.0287485786
6   0.0002839565    0.000439413   0.0031309800

Correlations (Anemonefish Env-Only) - Breadth vs. Shift ( ssp119_2050  /  shift_119_2050 ):
  Generalists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_gen$breadth_B2 and temp_df_cor_fish_gen[[shift_col_name]]
t = -5.1225, df = 1, p-value = 0.1227
alternative hypothesis: true correlation is not equal to 0
sample estimates:
      cor 
-0.981473 

  Specialists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_spec$breadth_B2 and temp_df_cor_fish_spec[[shift_col_name]]
t = -0.023042, df = 4, p-value = 0.9827
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.8154575  0.8075915
sample estimates:
        cor 
-0.01152025 


Correlations (Anemonefish Env-Only) - Breadth vs. Shift ( ssp119_2100  /  shift_119_2100 ):
  Generalists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_gen$breadth_B2 and temp_df_cor_fish_gen[[shift_col_name]]
t = -162.69, df = 1, p-value = 0.003913
alternative hypothesis: true correlation is not equal to 0
sample estimates:
       cor 
-0.9999811 

  Specialists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_spec$breadth_B2 and temp_df_cor_fish_spec[[shift_col_name]]
t = -0.27622, df = 4, p-value = 0.7961
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.8535970  0.7590251
sample estimates:
       cor 
-0.1368112 


Correlations (Anemonefish Env-Only) - Breadth vs. Shift ( ssp585_2050  /  shift_585_2050 ):
  Generalists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_gen$breadth_B2 and temp_df_cor_fish_gen[[shift_col_name]]
t = -9.038, df = 1, p-value = 0.07015
alternative hypothesis: true correlation is not equal to 0
sample estimates:
       cor 
-0.9939346 

  Specialists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_spec$breadth_B2 and temp_df_cor_fish_spec[[shift_col_name]]
t = 0.36739, df = 4, p-value = 0.7319
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.7392886  0.8653501
sample estimates:
      cor 
0.1806719 


Correlations (Anemonefish Env-Only) - Breadth vs. Shift ( ssp585_2100  /  shift_585_2100 ):
  Generalists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_gen$breadth_B2 and temp_df_cor_fish_gen[[shift_col_name]]
t = 0.0021472, df = 1, p-value = 0.9986
alternative hypothesis: true correlation is not equal to 0
sample estimates:
        cor 
0.002147152 

  Specialists:

    Pearson's product-moment correlation

data:  temp_df_cor_fish_spec$breadth_B2 and temp_df_cor_fish_spec[[shift_col_name]]
t = 0.75285, df = 4, p-value = 0.4934
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.6431490  0.9050842
sample estimates:
      cor 
0.3522936 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Prepare data for combined plotting ---</span></span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>all_breadth_shifts_long_df_final <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb201-3"><a href="#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_breadth_shifts_df_final) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(host_breadth_shifts_df_final) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb201-4"><a href="#cb201-4" aria-hidden="true" tabindex="-1"></a>  host_plot_df_final <span class="ot">&lt;-</span> host_breadth_shifts_df_final <span class="sc">%&gt;%</span> </span>
<span id="cb201-5"><a href="#cb201-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"shift_"</span>), </span>
<span id="cb201-6"><a href="#cb201-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"scenario_shift_code"</span>, </span>
<span id="cb201-7"><a href="#cb201-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"suitability_shift"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb201-8"><a href="#cb201-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">guild =</span> <span class="st">"Host Anemone"</span>,</span>
<span id="cb201-9"><a href="#cb201-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">specialization_type =</span> <span class="st">"Host"</span>) </span>
<span id="cb201-10"><a href="#cb201-10" aria-hidden="true" tabindex="-1"></a>  all_breadth_shifts_long_df_final <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_breadth_shifts_long_df_final, host_plot_df_final)</span>
<span id="cb201-11"><a href="#cb201-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb201-12"><a href="#cb201-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_breadth_shifts_df_final) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_breadth_shifts_df_final) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb201-13"><a href="#cb201-13" aria-hidden="true" tabindex="-1"></a>  fish_plot_df_final <span class="ot">&lt;-</span> fish_breadth_shifts_df_final <span class="sc">%&gt;%</span></span>
<span id="cb201-14"><a href="#cb201-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">"shift_"</span>), </span>
<span id="cb201-15"><a href="#cb201-15" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"scenario_shift_code"</span>, </span>
<span id="cb201-16"><a href="#cb201-16" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"suitability_shift"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb201-17"><a href="#cb201-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">guild =</span> <span class="st">"Anemonefish"</span>) </span>
<span id="cb201-18"><a href="#cb201-18" aria-hidden="true" tabindex="-1"></a>  all_breadth_shifts_long_df_final <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_breadth_shifts_long_df_final, fish_plot_df_final)</span>
<span id="cb201-19"><a href="#cb201-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb201-20"><a href="#cb201-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-21"><a href="#cb201-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(all_breadth_shifts_long_df_final) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(all_breadth_shifts_long_df_final) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb201-22"><a href="#cb201-22" aria-hidden="true" tabindex="-1"></a>  all_breadth_shifts_long_df_final <span class="ot">&lt;-</span> all_breadth_shifts_long_df_final <span class="sc">%&gt;%</span></span>
<span id="cb201-23"><a href="#cb201-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(breadth_B2), <span class="sc">!</span><span class="fu">is.na</span>(suitability_shift)) <span class="sc">%&gt;%</span></span>
<span id="cb201-24"><a href="#cb201-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">scenario_display =</span> stringr<span class="sc">::</span><span class="fu">str_replace_all</span>(scenario_shift_code, <span class="co"># Use stringr:: explicitly if dplyr is masking</span></span>
<span id="cb201-25"><a href="#cb201-25" aria-hidden="true" tabindex="-1"></a>                                             <span class="fu">c</span>(<span class="st">"shift_"</span> <span class="ot">=</span> <span class="st">"SSP"</span>, <span class="st">"_"</span> <span class="ot">=</span> <span class="st">"-"</span>, <span class="st">"dec50"</span> <span class="ot">=</span> <span class="st">" (2041-2060)"</span>, <span class="st">"dec100"</span> <span class="ot">=</span> <span class="st">" (2081-2100)"</span>))) <span class="sc">%&gt;%</span> <span class="co"># Make year ranges more explicit</span></span>
<span id="cb201-26"><a href="#cb201-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">facet_group =</span> <span class="fu">paste</span>(guild, specialization_type, <span class="at">sep=</span><span class="st">" - "</span>)) </span>
<span id="cb201-27"><a href="#cb201-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb201-28"><a href="#cb201-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Combined long format data for plotting breadth vs. suitability shift (with specialization):</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb201-29"><a href="#cb201-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(all_breadth_shifts_long_df_final)) <span class="fu">print</span>(<span class="fu">head</span>(all_breadth_shifts_long_df_final))</span>
<span id="cb201-30"><a href="#cb201-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb201-31"><a href="#cb201-31" aria-hidden="true" tabindex="-1"></a>  plot_breadth_vs_shift_specialization <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(all_breadth_shifts_long_df_final, </span>
<span id="cb201-32"><a href="#cb201-32" aria-hidden="true" tabindex="-1"></a>                                               <span class="fu">aes</span>(<span class="at">x =</span> suitability_shift, <span class="at">y =</span> breadth_B2)) <span class="sc">+</span></span>
<span id="cb201-33"><a href="#cb201-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="fu">aes</span>(<span class="at">color =</span> specialization_type)) <span class="sc">+</span> </span>
<span id="cb201-34"><a href="#cb201-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="fu">aes</span>(<span class="at">linetype =</span> specialization_type, <span class="at">color=</span>specialization_type)) <span class="sc">+</span> </span>
<span id="cb201-35"><a href="#cb201-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> scenario_display <span class="sc">+</span> guild, <span class="at">scales =</span> <span class="st">"free_x"</span>, <span class="at">ncol=</span><span class="fu">length</span>(<span class="fu">unique</span>(all_breadth_shifts_long_df_final<span class="sc">$</span>scenario_display))) <span class="sc">+</span></span>
<span id="cb201-36"><a href="#cb201-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb201-37"><a href="#cb201-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Niche Breadth (Levin's B2) vs. Mean Suitability Shift"</span>,</span>
<span id="cb201-38"><a href="#cb201-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Mean Change in Suitability (Future - Current)"</span>,</span>
<span id="cb201-39"><a href="#cb201-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Levin's B2 (Niche Breadth)"</span></span>
<span id="cb201-40"><a href="#cb201-40" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb201-41"><a href="#cb201-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"cornflowerblue"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"darkorange"</span>, <span class="st">"Host"</span><span class="ot">=</span><span class="st">"seagreen"</span>), <span class="at">name =</span> <span class="st">"Group"</span>) <span class="sc">+</span></span>
<span id="cb201-42"><a href="#cb201-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Generalist"</span> <span class="ot">=</span> <span class="st">"dashed"</span>, <span class="st">"Specialist"</span> <span class="ot">=</span> <span class="st">"dotted"</span>, <span class="st">"Host"</span><span class="ot">=</span><span class="st">"solid"</span>), <span class="at">name =</span> <span class="st">"Group"</span>) <span class="sc">+</span></span>
<span id="cb201-43"><a href="#cb201-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb201-44"><a href="#cb201-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">7</span>),</span>
<span id="cb201-45"><a href="#cb201-45" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb201-46"><a href="#cb201-46" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="fl">0.5</span>, <span class="at">face=</span><span class="st">"bold"</span>),</span>
<span id="cb201-47"><a href="#cb201-47" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust=</span><span class="fl">0.5</span>))</span>
<span id="cb201-48"><a href="#cb201-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb201-49"><a href="#cb201-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print plot to RMarkdown output</span></span>
<span id="cb201-50"><a href="#cb201-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_breadth_vs_shift_specialization)</span>
<span id="cb201-51"><a href="#cb201-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb201-52"><a href="#cb201-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ADD THIS SECTION TO SAVE plot_breadth_vs_shift_specialization ---</span></span>
<span id="cb201-53"><a href="#cb201-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure figure_output_dir is defined (should be from setup chunk)</span></span>
<span id="cb201-54"><a href="#cb201-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb201-55"><a href="#cb201-55" aria-hidden="true" tabindex="-1"></a>    faceted_breadth_shift_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"breadth_vs_shift_faceted.png"</span>)</span>
<span id="cb201-56"><a href="#cb201-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> faceted_breadth_shift_plot_filename, </span>
<span id="cb201-57"><a href="#cb201-57" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_breadth_vs_shift_specialization, </span>
<span id="cb201-58"><a href="#cb201-58" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">12</span>, <span class="at">height =</span> <span class="dv">8</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Adjust dimensions/dpi as needed</span></span>
<span id="cb201-59"><a href="#cb201-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved faceted breadth vs. shift plot to:"</span>, faceted_breadth_shift_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb201-60"><a href="#cb201-60" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb201-61"><a href="#cb201-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Faceted breadth vs. shift plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb201-62"><a href="#cb201-62" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb201-63"><a href="#cb201-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- </span><span class="re">END</span><span class="co"> OF ADDED SECTION ---</span></span>
<span id="cb201-64"><a href="#cb201-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb201-65"><a href="#cb201-65" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb201-66"><a href="#cb201-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough combined data to plot breadth vs. suitability shifts with specialization.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb201-67"><a href="#cb201-67" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Combined long format data for plotting breadth vs. suitability shift (with specialization):
# A tibble: 6 × 9
  species_name_sanitized breadth_B2 scenario_shift_code suitability_shift guild 
  &lt;chr&gt;                       &lt;dbl&gt; &lt;chr&gt;                           &lt;dbl&gt; &lt;chr&gt; 
1 Entacmaea_quadricolor       0.317 shift_119_2050               -0.00454 Host …
2 Entacmaea_quadricolor       0.317 shift_119_2100               -0.00578 Host …
3 Entacmaea_quadricolor       0.317 shift_585_2050               -0.00417 Host …
4 Entacmaea_quadricolor       0.317 shift_585_2100               -0.00451 Host …
5 Radianthus_crispa           0.333 shift_119_2050               -0.00466 Host …
6 Radianthus_crispa           0.333 shift_119_2100               -0.00539 Host …
# ℹ 4 more variables: specialization_type &lt;chr&gt;, n_hosts &lt;int&gt;,
#   scenario_display &lt;chr&gt;, facet_group &lt;chr&gt;</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/breadth-suitability-correlation-specialization-1.png" class="img-fluid figure-img" width="1152"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved faceted breadth vs. shift plot to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/breadth_vs_shift_faceted.png </code></pre>
</div>
</div>
<section id="figure-niche-breadth-vs.-suitability-shift" class="level3">
<h3 class="anchored" data-anchor-id="figure-niche-breadth-vs.-suitability-shift">Figure: Niche Breadth vs.&nbsp;Suitability Shift</h3>
<p>This figure visualizes the relationship between current niche breadth (Levin’s <span class="math inline">\(B_2\)</span>) and the projected mean change in suitability under a specific future scenario for both host sea anemones and anemonefish (environmental-only models). This is analogous to Figure 5 in the reference desert ant paper.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb204-2"><a href="#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cowplot) <span class="co"># For plot_grid</span></span>
<span id="cb204-3"><a href="#cb204-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure dplyr is loaded if not already from setup</span></span>
<span id="cb204-4"><a href="#cb204-4" aria-hidden="true" tabindex="-1"></a><span class="co"># pacman::p_load(dplyr) </span></span>
<span id="cb204-5"><a href="#cb204-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-6"><a href="#cb204-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Choose ONE future scenario for this figure ---</span></span>
<span id="cb204-7"><a href="#cb204-7" aria-hidden="true" tabindex="-1"></a><span class="co"># This should match one of the columns created in the _final dataframes</span></span>
<span id="cb204-8"><a href="#cb204-8" aria-hidden="true" tabindex="-1"></a>chosen_scenario_for_figure <span class="ot">&lt;-</span> <span class="st">"shift_585_2100"</span> <span class="co"># Example: Corresponds to ssp585_2100</span></span>
<span id="cb204-9"><a href="#cb204-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-10"><a href="#cb204-10" aria-hidden="true" tabindex="-1"></a>plot_a_host <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb204-11"><a href="#cb204-11" aria-hidden="true" tabindex="-1"></a>plot_b_fish <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb204-12"><a href="#cb204-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb204-13"><a href="#cb204-13" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Host Anemones Plot ---</span></span>
<span id="cb204-14"><a href="#cb204-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_breadth_shifts_df_final) <span class="sc">&amp;&amp;</span> chosen_scenario_for_figure <span class="sc">%in%</span> <span class="fu">names</span>(host_breadth_shifts_df_final) <span class="sc">&amp;&amp;</span> <span class="st">"breadth_B2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(host_breadth_shifts_df_final)) {</span>
<span id="cb204-15"><a href="#cb204-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb204-16"><a href="#cb204-16" aria-hidden="true" tabindex="-1"></a>  cor_data_host <span class="ot">&lt;-</span> host_breadth_shifts_df_final <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(breadth_B2, <span class="sc">!!</span><span class="fu">sym</span>(chosen_scenario_for_figure)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb204-17"><a href="#cb204-17" aria-hidden="true" tabindex="-1"></a>  host_cor_test <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb204-18"><a href="#cb204-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(cor_data_host) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb204-19"><a href="#cb204-19" aria-hidden="true" tabindex="-1"></a>    host_cor_test <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(cor_data_host<span class="sc">$</span>breadth_B2, cor_data_host[[chosen_scenario_for_figure]])</span>
<span id="cb204-20"><a href="#cb204-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb204-21"><a href="#cb204-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb204-22"><a href="#cb204-22" aria-hidden="true" tabindex="-1"></a>  plot_a_host <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(host_breadth_shifts_df_final, <span class="fu">aes</span>(<span class="at">x =</span> .data[[chosen_scenario_for_figure]], <span class="at">y =</span> breadth_B2)) <span class="sc">+</span> </span>
<span id="cb204-23"><a href="#cb204-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">color =</span> <span class="st">"dodgerblue3"</span>) <span class="sc">+</span></span>
<span id="cb204-24"><a href="#cb204-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, </span>
<span id="cb204-25"><a href="#cb204-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">linetype =</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_cor_test) <span class="sc">&amp;&amp;</span> host_cor_test<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) <span class="st">"solid"</span> <span class="cf">else</span> <span class="st">"dashed"</span>, </span>
<span id="cb204-26"><a href="#cb204-26" aria-hidden="true" tabindex="-1"></a>                <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span> </span>
<span id="cb204-27"><a href="#cb204-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb204-28"><a href="#cb204-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">paste</span>(<span class="st">"Mean Suitability Shift ("</span>, <span class="fu">gsub</span>(<span class="st">"shift_"</span>, <span class="st">"SSP"</span>, chosen_scenario_for_figure), <span class="st">")"</span>),</span>
<span id="cb204-29"><a href="#cb204-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Environmental Breadth (Levin's B2)"</span></span>
<span id="cb204-30"><a href="#cb204-30" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb204-31"><a href="#cb204-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb204-32"><a href="#cb204-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span>
<span id="cb204-33"><a href="#cb204-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb204-34"><a href="#cb204-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Host plot generated for"</span>, chosen_scenario_for_figure, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb204-35"><a href="#cb204-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(host_cor_test)) <span class="fu">print</span>(host_cor_test) </span>
<span id="cb204-36"><a href="#cb204-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb204-37"><a href="#cb204-37" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb204-38"><a href="#cb204-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Skipping host breadth vs. shift plot: `host_breadth_shifts_df_final` is NULL, or data for"</span>, chosen_scenario_for_figure, <span class="st">"or breadth_B2 missing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb204-39"><a href="#cb204-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Host plot generated for shift_585_2100 

    Pearson's product-moment correlation

data:  cor_data_host$breadth_B2 and cor_data_host[[chosen_scenario_for_figure]]
t = 0.45055, df = 7, p-value = 0.6659
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.5585163  0.7485415
sample estimates:
      cor 
0.1678736 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Anemonefish (Env-Only, All Species Combined) Plot ---</span></span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_breadth_shifts_df_final) <span class="sc">&amp;&amp;</span> chosen_scenario_for_figure <span class="sc">%in%</span> <span class="fu">names</span>(fish_breadth_shifts_df_final) <span class="sc">&amp;&amp;</span> <span class="st">"breadth_B2"</span> <span class="sc">%in%</span> <span class="fu">names</span>(fish_breadth_shifts_df_final)) {</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb206-4"><a href="#cb206-4" aria-hidden="true" tabindex="-1"></a>  cor_data_fish_all <span class="ot">&lt;-</span> fish_breadth_shifts_df_final <span class="sc">%&gt;%</span> </span>
<span id="cb206-5"><a href="#cb206-5" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(breadth_B2, <span class="sc">!!</span><span class="fu">sym</span>(chosen_scenario_for_figure)) <span class="sc">%&gt;%</span> <span class="fu">na.omit</span>()</span>
<span id="cb206-6"><a href="#cb206-6" aria-hidden="true" tabindex="-1"></a>  fish_cor_test_all <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb206-7"><a href="#cb206-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">nrow</span>(cor_data_fish_all) <span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb206-8"><a href="#cb206-8" aria-hidden="true" tabindex="-1"></a>    fish_cor_test_all <span class="ot">&lt;-</span> <span class="fu">cor.test</span>(cor_data_fish_all<span class="sc">$</span>breadth_B2, cor_data_fish_all[[chosen_scenario_for_figure]])</span>
<span id="cb206-9"><a href="#cb206-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb206-10"><a href="#cb206-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-11"><a href="#cb206-11" aria-hidden="true" tabindex="-1"></a>  plot_b_fish <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(fish_breadth_shifts_df_final, <span class="fu">aes</span>(<span class="at">x =</span> .data[[chosen_scenario_for_figure]], <span class="at">y =</span> breadth_B2)) <span class="sc">+</span> </span>
<span id="cb206-12"><a href="#cb206-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">color =</span> <span class="st">"firebrick3"</span>) <span class="sc">+</span></span>
<span id="cb206-13"><a href="#cb206-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, </span>
<span id="cb206-14"><a href="#cb206-14" aria-hidden="true" tabindex="-1"></a>                <span class="at">linetype =</span> <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(fish_cor_test_all) <span class="sc">&amp;&amp;</span> fish_cor_test_all<span class="sc">$</span>p.value <span class="sc">&lt;</span> <span class="fl">0.05</span>) <span class="st">"solid"</span> <span class="cf">else</span> <span class="st">"dashed"</span>, </span>
<span id="cb206-15"><a href="#cb206-15" aria-hidden="true" tabindex="-1"></a>                <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb206-16"><a href="#cb206-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb206-17"><a href="#cb206-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">paste</span>(<span class="st">"Mean Suitability Shift ("</span>, <span class="fu">gsub</span>(<span class="st">"shift_"</span>, <span class="st">"SSP"</span>, chosen_scenario_for_figure), <span class="st">")"</span>),</span>
<span id="cb206-18"><a href="#cb206-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Environmental Breadth (Levin's B2)"</span></span>
<span id="cb206-19"><a href="#cb206-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb206-20"><a href="#cb206-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">11</span>) <span class="sc">+</span></span>
<span id="cb206-21"><a href="#cb206-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(), <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span>
<span id="cb206-22"><a href="#cb206-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb206-23"><a href="#cb206-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Anemonefish (all) plot generated for"</span>, chosen_scenario_for_figure, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb206-24"><a href="#cb206-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(fish_cor_test_all)) <span class="fu">print</span>(fish_cor_test_all) </span>
<span id="cb206-25"><a href="#cb206-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb206-26"><a href="#cb206-26" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb206-27"><a href="#cb206-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Skipping anemonefish breadth vs. shift plot: `fish_breadth_shifts_df_final` is NULL, or data for"</span>, chosen_scenario_for_figure, <span class="st">"or breadth_B2 missing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb206-28"><a href="#cb206-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Anemonefish (all) plot generated for shift_585_2100 

    Pearson's product-moment correlation

data:  cor_data_fish_all$breadth_B2 and cor_data_fish_all[[chosen_scenario_for_figure]]
t = 1.3804, df = 7, p-value = 0.2099
alternative hypothesis: true correlation is not equal to 0
95 percent confidence interval:
 -0.2909350  0.8619075
sample estimates:
     cor 
0.462561 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Combine Plots ---</span></span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(plot_a_host) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(plot_b_fish)) {</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert chosen_scenario_for_figure (e.g., "shift_585_2100") to a display label (e.g., "SSP5-8.5 2100")</span></span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a>  scenario_display_label <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"shift_"</span>, <span class="st">"SSP"</span>, chosen_scenario_for_figure)</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>  scenario_display_label <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"_"</span>, <span class="st">"-"</span>, scenario_display_label) <span class="co"># Replace underscore with hyphen</span></span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This is a basic conversion, if you have the scenario_label_converter from setup, use that for full names.</span></span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Example assuming scenario_label_converter is available:</span></span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># display_scenario_name_for_title &lt;- scenario_label_converter[gsub("shift_", "ssp", chosen_scenario_for_figure)] %||% chosen_scenario_for_figure</span></span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>  display_scenario_name_for_title <span class="ot">&lt;-</span> scenario_display_label <span class="co"># Using the simpler conversion for now</span></span>
<span id="cb208-10"><a href="#cb208-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-11"><a href="#cb208-11" aria-hidden="true" tabindex="-1"></a>  combined_title_text <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Niche Breadth vs. Suitability Shift:"</span>, display_scenario_name_for_title)</span>
<span id="cb208-12"><a href="#cb208-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb208-13"><a href="#cb208-13" aria-hidden="true" tabindex="-1"></a>  combined_breadth_plot <span class="ot">&lt;-</span> cowplot<span class="sc">::</span><span class="fu">plot_grid</span>(</span>
<span id="cb208-14"><a href="#cb208-14" aria-hidden="true" tabindex="-1"></a>                            plot_a_host <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"A) Host Anemones"</span>), </span>
<span id="cb208-15"><a href="#cb208-15" aria-hidden="true" tabindex="-1"></a>                            plot_b_fish <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"B) Anemonefish"</span>), </span>
<span id="cb208-16"><a href="#cb208-16" aria-hidden="true" tabindex="-1"></a>                            <span class="at">ncol =</span> <span class="dv">2</span> <span class="co"># labels = "AUTO" - auto labels A, B</span></span>
<span id="cb208-17"><a href="#cb208-17" aria-hidden="true" tabindex="-1"></a>                            <span class="co"># No need for labels = "AUTO" if we add titles to individual plots</span></span>
<span id="cb208-18"><a href="#cb208-18" aria-hidden="true" tabindex="-1"></a>                          )</span>
<span id="cb208-19"><a href="#cb208-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb208-20"><a href="#cb208-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a super title to the combined plot</span></span>
<span id="cb208-21"><a href="#cb208-21" aria-hidden="true" tabindex="-1"></a>  final_plot_with_title <span class="ot">&lt;-</span> cowplot<span class="sc">::</span><span class="fu">ggdraw</span>() <span class="sc">+</span></span>
<span id="cb208-22"><a href="#cb208-22" aria-hidden="true" tabindex="-1"></a>    cowplot<span class="sc">::</span><span class="fu">draw_plot</span>(combined_breadth_plot) <span class="sc">+</span></span>
<span id="cb208-23"><a href="#cb208-23" aria-hidden="true" tabindex="-1"></a>    cowplot<span class="sc">::</span><span class="fu">draw_label</span>(combined_title_text, <span class="at">fontface =</span> <span class="st">'bold'</span>, <span class="at">x =</span> <span class="fl">0.5</span>, <span class="at">y =</span> <span class="fl">0.97</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">14</span>) <span class="co"># Adjust size as needed</span></span>
<span id="cb208-24"><a href="#cb208-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb208-25"><a href="#cb208-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print plot to RMarkdown output</span></span>
<span id="cb208-26"><a href="#cb208-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(final_plot_with_title)</span>
<span id="cb208-27"><a href="#cb208-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Combined breadth vs. suitability shift plot generated.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb208-28"><a href="#cb208-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-29"><a href="#cb208-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ADD THIS SECTION TO SAVE final_plot_with_title ---</span></span>
<span id="cb208-30"><a href="#cb208-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure figure_output_dir is defined (should be from setup chunk)</span></span>
<span id="cb208-31"><a href="#cb208-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb208-32"><a href="#cb208-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create a filename that reflects the chosen scenario</span></span>
<span id="cb208-33"><a href="#cb208-33" aria-hidden="true" tabindex="-1"></a>    safe_scenario_name_for_file <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">"[^a-zA-Z0-9_]"</span>, <span class="st">"_"</span>, chosen_scenario_for_figure) <span class="co"># Make it filename-safe</span></span>
<span id="cb208-34"><a href="#cb208-34" aria-hidden="true" tabindex="-1"></a>    combined_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="fu">paste0</span>(<span class="st">"breadth_vs_shift_"</span>, safe_scenario_name_for_file, <span class="st">"_combined.png"</span>))</span>
<span id="cb208-35"><a href="#cb208-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb208-36"><a href="#cb208-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> combined_plot_filename, </span>
<span id="cb208-37"><a href="#cb208-37" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> final_plot_with_title, <span class="co"># Save the plot that has the super title</span></span>
<span id="cb208-38"><a href="#cb208-38" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">5</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Adjust dimensions/dpi as needed</span></span>
<span id="cb208-39"><a href="#cb208-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved combined breadth vs. shift plot to:"</span>, combined_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb208-40"><a href="#cb208-40" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb208-41"><a href="#cb208-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Combined breadth vs. shift plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb208-42"><a href="#cb208-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb208-43"><a href="#cb208-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- </span><span class="re">END</span><span class="co"> OF ADDED SECTION ---</span></span>
<span id="cb208-44"><a href="#cb208-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-45"><a href="#cb208-45" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb208-46"><a href="#cb208-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Could not generate combined breadth plot as one or both individual plots are missing.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb208-47"><a href="#cb208-47" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Combined breadth vs. suitability shift plot generated.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/breadth-suitability-figure-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved combined breadth vs. shift plot to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/breadth_vs_shift_shift_585_2100_combined.png </code></pre>
</div>
</div>
</section>
</section>
<section id="phylogenetic-signal-of-niche-breadth-and-suitability-shifts-anemonefish" class="level2">
<h2 class="anchored" data-anchor-id="phylogenetic-signal-of-niche-breadth-and-suitability-shifts-anemonefish">Phylogenetic Signal of Niche Breadth and Suitability Shifts (Anemonefish)</h2>
<p>This section tests for phylogenetic signal (Blomberg’s K) in niche breadth (Levin’s B2) and in the mean suitability shifts for anemonefish species under future scenarios.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a><span class="co"># library(phytools) # For phylosig, multiPhylosignal</span></span>
<span id="cb211-2"><a href="#cb211-2" aria-hidden="true" tabindex="-1"></a><span class="co"># library(picante)  # For phylosignal (Blomberg's K)</span></span>
<span id="cb211-3"><a href="#cb211-3" aria-hidden="true" tabindex="-1"></a><span class="co"># library(dplyr)</span></span>
<span id="cb211-4"><a href="#cb211-4" aria-hidden="true" tabindex="-1"></a><span class="co"># library(geiger)</span></span>
<span id="cb211-5"><a href="#cb211-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb211-6"><a href="#cb211-6" aria-hidden="true" tabindex="-1"></a><span class="co"># if (is.null(pruned_anemonefish_tree)) {</span></span>
<span id="cb211-7"><a href="#cb211-7" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("Warning: `pruned_anemonefish_tree` not available. Skipping phylogenetic signal of traits for anemonefish.\n")</span></span>
<span id="cb211-8"><a href="#cb211-8" aria-hidden="true" tabindex="-1"></a><span class="co"># } else if (is.null(fish_breadth_shifts_df) || nrow(fish_breadth_shifts_df) == 0) {</span></span>
<span id="cb211-9"><a href="#cb211-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("Warning: `fish_breadth_shifts_df` not available or empty. Skipping phylogenetic signal of traits.\n")</span></span>
<span id="cb211-10"><a href="#cb211-10" aria-hidden="true" tabindex="-1"></a><span class="co"># } else if (!exists("fish_label_map_df") || is.null(fish_label_map_df)) {</span></span>
<span id="cb211-11"><a href="#cb211-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("Warning: `fish_label_map_df` (mapping Original_Genus_Species to short_code) is missing. Skipping phylogenetic signal.\n")</span></span>
<span id="cb211-12"><a href="#cb211-12" aria-hidden="true" tabindex="-1"></a><span class="co"># } else {</span></span>
<span id="cb211-13"><a href="#cb211-13" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("--- Testing Phylogenetic Signal for Anemonefish Traits ---\n")</span></span>
<span id="cb211-14"><a href="#cb211-14" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb211-15"><a href="#cb211-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   # Ensure tree is strictly bifurcating if needed by some phytools functions</span></span>
<span id="cb211-16"><a href="#cb211-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   # (multi2di might resolve polytomies randomly, consider implications)</span></span>
<span id="cb211-17"><a href="#cb211-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   if(!is.binary(pruned_anemonefish_tree) &amp;&amp; length(pruned_anemonefish_tree$tip.label) &gt; 2) {</span></span>
<span id="cb211-18"><a href="#cb211-18" aria-hidden="true" tabindex="-1"></a><span class="co">#       pruned_anemonefish_tree_binary &lt;- multi2di(pruned_anemonefish_tree, random = TRUE) # Random resolution</span></span>
<span id="cb211-19"><a href="#cb211-19" aria-hidden="true" tabindex="-1"></a><span class="co">#       cat("  Resolved polytomies in anemonefish tree for phylosignal analysis.\n")</span></span>
<span id="cb211-20"><a href="#cb211-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb211-21"><a href="#cb211-21" aria-hidden="true" tabindex="-1"></a><span class="co">#       pruned_anemonefish_tree_binary &lt;- pruned_anemonefish_tree</span></span>
<span id="cb211-22"><a href="#cb211-22" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb211-23"><a href="#cb211-23" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb211-24"><a href="#cb211-24" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb211-25"><a href="#cb211-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   # --- 1. Phylogenetic Signal in Niche Breadth (Levin's B2) ---</span></span>
<span id="cb211-26"><a href="#cb211-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   cat("\n  Testing phylogenetic signal for Niche Breadth (Levin's B2)...\n")</span></span>
<span id="cb211-27"><a href="#cb211-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   </span></span>
<span id="cb211-28"><a href="#cb211-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   trait_data_breadth &lt;- fish_breadth_shifts_df %&gt;%</span></span>
<span id="cb211-29"><a href="#cb211-29" aria-hidden="true" tabindex="-1"></a><span class="co">#     inner_join(fish_label_map_df, by = c("species_name_sanitized" = "Original_Genus_Species")) %&gt;%</span></span>
<span id="cb211-30"><a href="#cb211-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     filter(short_code %in% pruned_anemonefish_tree_binary$tip.label) %&gt;% # Keep only species in the tree</span></span>
<span id="cb211-31"><a href="#cb211-31" aria-hidden="true" tabindex="-1"></a><span class="co">#     dplyr::select(short_code, breadth_B2) %&gt;%</span></span>
<span id="cb211-32"><a href="#cb211-32" aria-hidden="true" tabindex="-1"></a><span class="co">#     filter(!is.na(breadth_B2)) %&gt;%</span></span>
<span id="cb211-33"><a href="#cb211-33" aria-hidden="true" tabindex="-1"></a><span class="co">#     distinct(short_code, .keep_all = TRUE) # Ensure unique species</span></span>
<span id="cb211-34"><a href="#cb211-34" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb211-35"><a href="#cb211-35" aria-hidden="true" tabindex="-1"></a><span class="co">#   if (nrow(trait_data_breadth) &gt; 2) {</span></span>
<span id="cb211-36"><a href="#cb211-36" aria-hidden="true" tabindex="-1"></a><span class="co">#     breadth_values &lt;- trait_data_breadth$breadth_B2</span></span>
<span id="cb211-37"><a href="#cb211-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     names(breadth_values) &lt;- trait_data_breadth$short_code</span></span>
<span id="cb211-38"><a href="#cb211-38" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb211-39"><a href="#cb211-39" aria-hidden="true" tabindex="-1"></a><span class="co">#     # Match tree and data</span></span>
<span id="cb211-40"><a href="#cb211-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     matched_data_breadth &lt;- treedata(pruned_anemonefish_tree_binary, breadth_values, sort=TRUE, warnings=FALSE)</span></span>
<span id="cb211-41"><a href="#cb211-41" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb211-42"><a href="#cb211-42" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (length(matched_data_breadth$data) &gt; 2) {</span></span>
<span id="cb211-43"><a href="#cb211-43" aria-hidden="true" tabindex="-1"></a><span class="co">#       phylosig_breadth_B2 &lt;- phylosig(matched_data_breadth$phy, matched_data_breadth$data[,1], method="K", test=TRUE, nsim=999)</span></span>
<span id="cb211-44"><a href="#cb211-44" aria-hidden="true" tabindex="-1"></a><span class="co">#       cat("  Blomberg's K for Niche Breadth (B2):\n")</span></span>
<span id="cb211-45"><a href="#cb211-45" aria-hidden="true" tabindex="-1"></a><span class="co">#       print(phylosig_breadth_B2)</span></span>
<span id="cb211-46"><a href="#cb211-46" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {</span></span>
<span id="cb211-47"><a href="#cb211-47" aria-hidden="true" tabindex="-1"></a><span class="co">#       cat("  Not enough matching species between tree and breadth data after NA removal.\n")</span></span>
<span id="cb211-48"><a href="#cb211-48" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb211-49"><a href="#cb211-49" aria-hidden="true" tabindex="-1"></a><span class="co">#   } else {</span></span>
<span id="cb211-50"><a href="#cb211-50" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("  Not enough species with valid niche breadth data and in the tree to test for phylogenetic signal.\n")</span></span>
<span id="cb211-51"><a href="#cb211-51" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb211-52"><a href="#cb211-52" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb211-53"><a href="#cb211-53" aria-hidden="true" tabindex="-1"></a><span class="co">#   # --- 2. Phylogenetic Signal in Suitability Shifts for each Future Scenario ---</span></span>
<span id="cb211-54"><a href="#cb211-54" aria-hidden="true" tabindex="-1"></a><span class="co">#   for (scenario_name in future_scenarios_to_load) {</span></span>
<span id="cb211-55"><a href="#cb211-55" aria-hidden="true" tabindex="-1"></a><span class="co">#     shift_col_name &lt;- paste0("shift_", gsub("ssp", "", scenario_name))</span></span>
<span id="cb211-56"><a href="#cb211-56" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat("\n  Testing phylogenetic signal for Suitability Shift under scenario:", scenario_name, "(column:", shift_col_name, ")...\n")</span></span>
<span id="cb211-57"><a href="#cb211-57" aria-hidden="true" tabindex="-1"></a><span class="co">#     </span></span>
<span id="cb211-58"><a href="#cb211-58" aria-hidden="true" tabindex="-1"></a><span class="co">#     if (shift_col_name %in% names(fish_breadth_shifts_df)) {</span></span>
<span id="cb211-59"><a href="#cb211-59" aria-hidden="true" tabindex="-1"></a><span class="co">#       trait_data_shift &lt;- fish_breadth_shifts_df %&gt;%</span></span>
<span id="cb211-60"><a href="#cb211-60" aria-hidden="true" tabindex="-1"></a><span class="co">#         inner_join(fish_label_map_df, by = c("species_name_sanitized" = "Original_Genus_Species")) %&gt;%</span></span>
<span id="cb211-61"><a href="#cb211-61" aria-hidden="true" tabindex="-1"></a><span class="co">#         filter(short_code %in% pruned_anemonefish_tree_binary$tip.label) %&gt;%</span></span>
<span id="cb211-62"><a href="#cb211-62" aria-hidden="true" tabindex="-1"></a><span class="co">#         dplyr::select(short_code, suitability_shift = !!sym(shift_col_name)) %&gt;%</span></span>
<span id="cb211-63"><a href="#cb211-63" aria-hidden="true" tabindex="-1"></a><span class="co">#         filter(!is.na(suitability_shift)) %&gt;%</span></span>
<span id="cb211-64"><a href="#cb211-64" aria-hidden="true" tabindex="-1"></a><span class="co">#         distinct(short_code, .keep_all = TRUE)</span></span>
<span id="cb211-65"><a href="#cb211-65" aria-hidden="true" tabindex="-1"></a><span class="co">#         </span></span>
<span id="cb211-66"><a href="#cb211-66" aria-hidden="true" tabindex="-1"></a><span class="co">#       if (nrow(trait_data_shift) &gt; 2) {</span></span>
<span id="cb211-67"><a href="#cb211-67" aria-hidden="true" tabindex="-1"></a><span class="co">#         shift_values &lt;- trait_data_shift$suitability_shift</span></span>
<span id="cb211-68"><a href="#cb211-68" aria-hidden="true" tabindex="-1"></a><span class="co">#         names(shift_values) &lt;- trait_data_shift$short_code</span></span>
<span id="cb211-69"><a href="#cb211-69" aria-hidden="true" tabindex="-1"></a><span class="co">#         </span></span>
<span id="cb211-70"><a href="#cb211-70" aria-hidden="true" tabindex="-1"></a><span class="co">#         matched_data_shift &lt;- treedata(pruned_anemonefish_tree_binary, shift_values, sort=TRUE, warnings=FALSE)</span></span>
<span id="cb211-71"><a href="#cb211-71" aria-hidden="true" tabindex="-1"></a><span class="co">#         </span></span>
<span id="cb211-72"><a href="#cb211-72" aria-hidden="true" tabindex="-1"></a><span class="co">#         if(length(matched_data_shift$data) &gt; 2) {</span></span>
<span id="cb211-73"><a href="#cb211-73" aria-hidden="true" tabindex="-1"></a><span class="co">#           phylosig_shift &lt;- phylosig(matched_data_shift$phy, matched_data_shift$data[,1], method="K", test=TRUE, nsim=999)</span></span>
<span id="cb211-74"><a href="#cb211-74" aria-hidden="true" tabindex="-1"></a><span class="co">#           cat("  Blomberg's K for Suitability Shift (", scenario_name, "):\n")</span></span>
<span id="cb211-75"><a href="#cb211-75" aria-hidden="true" tabindex="-1"></a><span class="co">#           print(phylosig_shift)</span></span>
<span id="cb211-76"><a href="#cb211-76" aria-hidden="true" tabindex="-1"></a><span class="co">#         } else {</span></span>
<span id="cb211-77"><a href="#cb211-77" aria-hidden="true" tabindex="-1"></a><span class="co">#           cat("  Not enough matching species between tree and shift data for", scenario_name, "after NA removal.\n")</span></span>
<span id="cb211-78"><a href="#cb211-78" aria-hidden="true" tabindex="-1"></a><span class="co">#         }</span></span>
<span id="cb211-79"><a href="#cb211-79" aria-hidden="true" tabindex="-1"></a><span class="co">#       } else {</span></span>
<span id="cb211-80"><a href="#cb211-80" aria-hidden="true" tabindex="-1"></a><span class="co">#         cat("  Not enough species with valid suitability shift data for scenario", scenario_name, "and in the tree.\n")</span></span>
<span id="cb211-81"><a href="#cb211-81" aria-hidden="true" tabindex="-1"></a><span class="co">#       }</span></span>
<span id="cb211-82"><a href="#cb211-82" aria-hidden="true" tabindex="-1"></a><span class="co">#     } else {</span></span>
<span id="cb211-83"><a href="#cb211-83" aria-hidden="true" tabindex="-1"></a><span class="co">#       cat("  Shift data column '", shift_col_name, "' not found for scenario", scenario_name, ".\n")</span></span>
<span id="cb211-84"><a href="#cb211-84" aria-hidden="true" tabindex="-1"></a><span class="co">#     }</span></span>
<span id="cb211-85"><a href="#cb211-85" aria-hidden="true" tabindex="-1"></a><span class="co">#   }</span></span>
<span id="cb211-86"><a href="#cb211-86" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="variable-importance-comparison" class="level2">
<h2 class="anchored" data-anchor-id="variable-importance-comparison">Variable Importance Comparison</h2>
<p>This section loads the variable importance (VI) scores from the environmental-only SDMs for host sea anemones and anemonefish. It then compares the importance of each environmental predictor (PCA components if used) between the two guilds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr) <span class="co"># Not strictly needed for this chunk as is, but good to have if you modify</span></span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr) <span class="co"># For str_remove if needed in species_sanitized, though seems done by filename</span></span>
<span id="cb212-5"><a href="#cb212-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(readr)   <span class="co"># For read_csv</span></span>
<span id="cb212-6"><a href="#cb212-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)   <span class="co"># For map_df</span></span>
<span id="cb212-7"><a href="#cb212-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-8"><a href="#cb212-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine predictor suffix used for the environmental-only models</span></span>
<span id="cb212-9"><a href="#cb212-9" aria-hidden="true" tabindex="-1"></a>env_model_predictor_suffix <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"_pca"</span>, <span class="st">"_vif"</span>)</span>
<span id="cb212-10"><a href="#cb212-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-11"><a href="#cb212-11" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load Host Anemone Variable Importance ---</span></span>
<span id="cb212-12"><a href="#cb212-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"--- Loading Host Anemone Variable Importance ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- Loading Host Anemone Variable Importance ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Original logic for finding host_vi_dir and host_vi_files</span></span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>host_vi_subdir_name <span class="ot">&lt;-</span> config<span class="sc">$</span>model_output_subdir_map[[env_model_predictor_suffix]] <span class="sc">%||%</span> </span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"anemone_pca"</span>, <span class="st">"anemone_vif"</span>)</span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>host_vi_dir_base <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, host_vi_subdir_name)</span>
<span id="cb214-5"><a href="#cb214-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-6"><a href="#cb214-6" aria-hidden="true" tabindex="-1"></a>host_vi_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> host_vi_dir_base, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb214-7"><a href="#cb214-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fallback if subdirectory structure is slightly different (e.g., .../anemone_pca/anemone_pca)</span></span>
<span id="cb214-8"><a href="#cb214-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_vi_files) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> env_model_predictor_suffix <span class="sc">==</span> <span class="st">"_pca"</span>) { </span>
<span id="cb214-9"><a href="#cb214-9" aria-hidden="true" tabindex="-1"></a>    host_vi_dir_alt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, <span class="st">"anemone_pca"</span>) <span class="co"># Check one level up from expected subdir</span></span>
<span id="cb214-10"><a href="#cb214-10" aria-hidden="true" tabindex="-1"></a>    host_vi_files_alt_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> host_vi_dir_alt, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb214-11"><a href="#cb214-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(host_vi_files_alt_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb214-12"><a href="#cb214-12" aria-hidden="true" tabindex="-1"></a>        host_vi_files <span class="ot">&lt;-</span> host_vi_files_alt_check</span>
<span id="cb214-13"><a href="#cb214-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Found host VI files in alternative directory:"</span>, host_vi_dir_alt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-14"><a href="#cb214-14" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> { <span class="co"># Check if it's nested further</span></span>
<span id="cb214-15"><a href="#cb214-15" aria-hidden="true" tabindex="-1"></a>        host_vi_dir_nested <span class="ot">&lt;-</span> <span class="fu">file.path</span>(host_vi_dir_base, <span class="st">"anemone_pca"</span>) <span class="co"># Original had host_vi_dir/anemone_pca</span></span>
<span id="cb214-16"><a href="#cb214-16" aria-hidden="true" tabindex="-1"></a>        host_vi_files_nested_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> host_vi_dir_nested, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb214-17"><a href="#cb214-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(<span class="fu">length</span>(host_vi_files_nested_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb214-18"><a href="#cb214-18" aria-hidden="true" tabindex="-1"></a>            host_vi_files <span class="ot">&lt;-</span> host_vi_files_nested_check</span>
<span id="cb214-19"><a href="#cb214-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"  Found host VI files in nested directory:"</span>, host_vi_dir_nested, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-20"><a href="#cb214-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb214-21"><a href="#cb214-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb214-22"><a href="#cb214-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb214-23"><a href="#cb214-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-24"><a href="#cb214-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-25"><a href="#cb214-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(host_vi_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb214-26"><a href="#cb214-26" aria-hidden="true" tabindex="-1"></a>  host_vi_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(host_vi_files, </span>
<span id="cb214-27"><a href="#cb214-27" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb214-28"><a href="#cb214-28" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename =</span> <span class="fu">basename</span>(.x))) <span class="sc">%&gt;%</span></span>
<span id="cb214-29"><a href="#cb214-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb214-30"><a href="#cb214-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_sanitized =</span> <span class="fu">str_remove</span>(<span class="fu">str_remove</span>(filename, <span class="st">"^VI_"</span>), <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>),</span>
<span id="cb214-31"><a href="#cb214-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">guild =</span> <span class="st">"Host Anemones"</span> <span class="co"># Consistent naming with scale_fill_manual later</span></span>
<span id="cb214-32"><a href="#cb214-32" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb214-33"><a href="#cb214-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Permutation_Importance =</span> Importance) </span>
<span id="cb214-34"><a href="#cb214-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb214-35"><a href="#cb214-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded VI data for"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(host_vi_data<span class="sc">$</span>species_sanitized)), <span class="st">"host species.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-36"><a href="#cb214-36" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb214-37"><a href="#cb214-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No Variable Importance CSV files found for host anemones. Checked:"</span>, host_vi_dir_base, <span class="st">"and potential alternatives.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb214-38"><a href="#cb214-38" aria-hidden="true" tabindex="-1"></a>  host_vi_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb214-39"><a href="#cb214-39" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded VI data for 24 host species.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load Anemonefish (Environmental-Only Models) Variable Importance ---</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- Loading Anemonefish (Env-Only) Variable Importance ---</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
--- Loading Anemonefish (Env-Only) Variable Importance ---</code></pre>
</div>
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>fish_vi_subdir_name <span class="ot">&lt;-</span> config<span class="sc">$</span>model_output_subdir_map[[env_model_predictor_suffix]] <span class="sc">%||%</span> </span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">ifelse</span>(config<span class="sc">$</span>use_pca_predictors, <span class="st">"anemonefish_pca"</span>, <span class="st">"anemonefish_vif"</span>)</span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>fish_vi_dir_base <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, fish_vi_subdir_name)</span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>fish_vi_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> fish_vi_dir_base, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_vi_files) <span class="sc">==</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> env_model_predictor_suffix <span class="sc">==</span> <span class="st">"_pca"</span>) { </span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>    fish_vi_dir_alt <span class="ot">&lt;-</span> <span class="fu">file.path</span>(config<span class="sc">$</span>target_vi_base, <span class="st">"anemonefish_pca"</span>)</span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>    fish_vi_files_alt_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> fish_vi_dir_alt, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">length</span>(fish_vi_files_alt_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>        fish_vi_files <span class="ot">&lt;-</span> fish_vi_files_alt_check</span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"  Found fish VI files in alternative directory:"</span>, fish_vi_dir_alt, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb218-13"><a href="#cb218-13" aria-hidden="true" tabindex="-1"></a>        fish_vi_dir_nested <span class="ot">&lt;-</span> <span class="fu">file.path</span>(fish_vi_dir_base, <span class="st">"anemonefish_pca"</span>)</span>
<span id="cb218-14"><a href="#cb218-14" aria-hidden="true" tabindex="-1"></a>        fish_vi_files_nested_check <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="at">path =</span> fish_vi_dir_nested, <span class="at">pattern =</span> <span class="st">"^VI_.*</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb218-15"><a href="#cb218-15" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span>(<span class="fu">length</span>(fish_vi_files_nested_check) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb218-16"><a href="#cb218-16" aria-hidden="true" tabindex="-1"></a>            fish_vi_files <span class="ot">&lt;-</span> fish_vi_files_nested_check</span>
<span id="cb218-17"><a href="#cb218-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">cat</span>(<span class="st">"  Found fish VI files in nested directory:"</span>, fish_vi_dir_nested, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb218-18"><a href="#cb218-18" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb218-19"><a href="#cb218-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb218-20"><a href="#cb218-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb218-21"><a href="#cb218-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-22"><a href="#cb218-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(fish_vi_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb218-23"><a href="#cb218-23" aria-hidden="true" tabindex="-1"></a>  fish_vi_data <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map_df</span>(fish_vi_files, </span>
<span id="cb218-24"><a href="#cb218-24" aria-hidden="true" tabindex="-1"></a>                <span class="sc">~</span>readr<span class="sc">::</span><span class="fu">read_csv</span>(.x, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb218-25"><a href="#cb218-25" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">mutate</span>(<span class="at">filename =</span> <span class="fu">basename</span>(.x))) <span class="sc">%&gt;%</span></span>
<span id="cb218-26"><a href="#cb218-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb218-27"><a href="#cb218-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">species_sanitized =</span> <span class="fu">str_remove</span>(<span class="fu">str_remove</span>(filename, <span class="st">"^VI_"</span>), <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>),</span>
<span id="cb218-28"><a href="#cb218-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">guild =</span> <span class="st">"Anemonefish (Env-Only)"</span> <span class="co"># Consistent naming</span></span>
<span id="cb218-29"><a href="#cb218-29" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb218-30"><a href="#cb218-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">Permutation_Importance =</span> Importance) </span>
<span id="cb218-31"><a href="#cb218-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Loaded VI data for"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(fish_vi_data<span class="sc">$</span>species_sanitized)), <span class="st">"anemonefish (env-only) species.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb218-32"><a href="#cb218-32" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb218-33"><a href="#cb218-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Warning: No Variable Importance CSV files found for anemonefish (env-only). Checked:"</span>, fish_vi_dir_base, <span class="st">"and potential alternatives.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb218-34"><a href="#cb218-34" aria-hidden="true" tabindex="-1"></a>  fish_vi_data <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb218-35"><a href="#cb218-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded VI data for 24 anemonefish (env-only) species.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Combine and Compare VI ---</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(host_vi_data) <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(fish_vi_data) <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(host_vi_data) <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;&amp;</span> <span class="fu">nrow</span>(fish_vi_data) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>  combined_vi_data <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(host_vi_data, fish_vi_data) <span class="sc">%&gt;%</span></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(Permutation_Importance)) </span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="st">"Variable"</span> <span class="sc">%in%</span> <span class="fu">names</span>(combined_vi_data)) {</span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"The 'Variable' column is missing from the loaded VI data. Check the output of SDMtune::varImp or your VI calculation script."</span>)</span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Combined VI data for comparison:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">head</span>(combined_vi_data))</span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure guild is a factor for consistent plotting order and legend</span></span>
<span id="cb220-14"><a href="#cb220-14" aria-hidden="true" tabindex="-1"></a>  combined_vi_data<span class="sc">$</span>guild <span class="ot">&lt;-</span> <span class="fu">factor</span>(combined_vi_data<span class="sc">$</span>guild, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Anemonefish (Env-Only)"</span>, <span class="st">"Host Anemones"</span>))</span>
<span id="cb220-15"><a href="#cb220-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-16"><a href="#cb220-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-17"><a href="#cb220-17" aria-hidden="true" tabindex="-1"></a>  plot_vi_comparison <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(combined_vi_data, <span class="fu">aes</span>(<span class="at">x =</span> Variable, <span class="at">y =</span> Permutation_Importance, <span class="at">fill =</span> guild)) <span class="sc">+</span></span>
<span id="cb220-18"><a href="#cb220-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.8</span>, <span class="at">position =</span> <span class="fu">position_dodge</span>(<span class="at">preserve =</span> <span class="st">"single"</span>)) <span class="sc">+</span></span>
<span id="cb220-19"><a href="#cb220-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb220-20"><a href="#cb220-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">title =</span> <span class="st">"Variable Importance Comparison between Guilds"</span>,</span>
<span id="cb220-21"><a href="#cb220-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="st">"Predictor Variable (PCA Component)"</span>, <span class="co"># Clarified x-axis</span></span>
<span id="cb220-22"><a href="#cb220-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> <span class="st">"Permutation Importance (%)"</span></span>
<span id="cb220-23"><a href="#cb220-23" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb220-24"><a href="#cb220-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Host Anemones"</span> <span class="ot">=</span> <span class="st">"coral"</span>, <span class="st">"Anemonefish (Env-Only)"</span> <span class="ot">=</span> <span class="st">"steelblue"</span>), <span class="at">name =</span> <span class="st">"Guild"</span>) <span class="sc">+</span> <span class="co"># Matched factor levels</span></span>
<span id="cb220-25"><a href="#cb220-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb220-26"><a href="#cb220-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>), <span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb220-27"><a href="#cb220-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb220-28"><a href="#cb220-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print plot to RMarkdown output</span></span>
<span id="cb220-29"><a href="#cb220-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(plot_vi_comparison)</span>
<span id="cb220-30"><a href="#cb220-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-31"><a href="#cb220-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- ADD THIS SECTION TO SAVE plot_vi_comparison ---</span></span>
<span id="cb220-32"><a href="#cb220-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure figure_output_dir is defined (should be from setup chunk)</span></span>
<span id="cb220-33"><a href="#cb220-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">exists</span>(<span class="st">"figure_output_dir"</span>) <span class="sc">&amp;&amp;</span> <span class="fu">dir.exists</span>(figure_output_dir)) {</span>
<span id="cb220-34"><a href="#cb220-34" aria-hidden="true" tabindex="-1"></a>    vi_comparison_plot_filename <span class="ot">&lt;-</span> <span class="fu">file.path</span>(figure_output_dir, <span class="st">"variable_importance_comparison_guilds.png"</span>)</span>
<span id="cb220-35"><a href="#cb220-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggsave</span>(<span class="at">filename =</span> vi_comparison_plot_filename, </span>
<span id="cb220-36"><a href="#cb220-36" aria-hidden="true" tabindex="-1"></a>           <span class="at">plot =</span> plot_vi_comparison, </span>
<span id="cb220-37"><a href="#cb220-37" aria-hidden="true" tabindex="-1"></a>           <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">"in"</span>, <span class="at">dpi =</span> <span class="dv">300</span>) <span class="co"># Adjust dimensions/dpi as needed</span></span>
<span id="cb220-38"><a href="#cb220-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Saved variable importance comparison plot to:"</span>, vi_comparison_plot_filename, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb220-39"><a href="#cb220-39" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb220-40"><a href="#cb220-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Warning: 'figure_output_dir' not defined or does not exist. Variable importance plot not saved to file.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb220-41"><a href="#cb220-41" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb220-42"><a href="#cb220-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- </span><span class="re">END</span><span class="co"> OF ADDED SECTION ---</span></span>
<span id="cb220-43"><a href="#cb220-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb220-44"><a href="#cb220-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform t-tests for each predictor variable</span></span>
<span id="cb220-45"><a href="#cb220-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">--- T-tests for difference in Variable Importance between Guilds ---</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb220-46"><a href="#cb220-46" aria-hidden="true" tabindex="-1"></a>  predictor_vars_to_test <span class="ot">&lt;-</span> <span class="fu">unique</span>(combined_vi_data<span class="sc">$</span>Variable)</span>
<span id="cb220-47"><a href="#cb220-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb220-48"><a href="#cb220-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (var_name <span class="cf">in</span> predictor_vars_to_test) {</span>
<span id="cb220-49"><a href="#cb220-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"  Testing variable:"</span>, var_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb220-50"><a href="#cb220-50" aria-hidden="true" tabindex="-1"></a>    data_for_ttest <span class="ot">&lt;-</span> combined_vi_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Variable <span class="sc">==</span> var_name)</span>
<span id="cb220-51"><a href="#cb220-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb220-52"><a href="#cb220-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if both guild levels are present with more than 1 observation each for the current variable</span></span>
<span id="cb220-53"><a href="#cb220-53" aria-hidden="true" tabindex="-1"></a>    guild_counts_for_var <span class="ot">&lt;-</span> data_for_ttest <span class="sc">%&gt;%</span> </span>
<span id="cb220-54"><a href="#cb220-54" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">group_by</span>(guild) <span class="sc">%&gt;%</span> </span>
<span id="cb220-55"><a href="#cb220-55" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">summarise</span>(<span class="at">n_obs =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">'drop'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb220-56"><a href="#cb220-56" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">filter</span>(n_obs <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb220-57"><a href="#cb220-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb220-58"><a href="#cb220-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(guild_counts_for_var) <span class="sc">==</span> <span class="dv">2</span>) { <span class="co"># Needs exactly two groups with &gt;1 obs each</span></span>
<span id="cb220-59"><a href="#cb220-59" aria-hidden="true" tabindex="-1"></a>      ttest_vi_result <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb220-60"><a href="#cb220-60" aria-hidden="true" tabindex="-1"></a>        <span class="fu">t.test</span>(Permutation_Importance <span class="sc">~</span> guild, <span class="at">data =</span> data_for_ttest)</span>
<span id="cb220-61"><a href="#cb220-61" aria-hidden="true" tabindex="-1"></a>      }, <span class="at">error =</span> <span class="cf">function</span>(e){</span>
<span id="cb220-62"><a href="#cb220-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span>(<span class="st">"    Error in t-test for"</span>, var_name, <span class="st">":"</span>, e<span class="sc">$</span>message, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>); <span class="cn">NULL</span></span>
<span id="cb220-63"><a href="#cb220-63" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb220-64"><a href="#cb220-64" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(ttest_vi_result)) <span class="fu">print</span>(ttest_vi_result)</span>
<span id="cb220-65"><a href="#cb220-65" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb220-66"><a href="#cb220-66" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb220-67"><a href="#cb220-67" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cat</span>(<span class="st">"    Skipping t-test for"</span>, var_name, <span class="st">"- insufficient data or only one guild present for this variable after filtering.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb220-68"><a href="#cb220-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">print</span>(data_for_ttest <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(guild) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">Count=</span><span class="fu">n</span>())) <span class="co"># Show counts for debugging</span></span>
<span id="cb220-69"><a href="#cb220-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb220-70"><a href="#cb220-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb220-71"><a href="#cb220-71" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb220-72"><a href="#cb220-72" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb220-73"><a href="#cb220-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Not enough variable importance data to compare between guilds.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb220-74"><a href="#cb220-74" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Combined VI data for comparison:
# A tibble: 6 × 5
  Variable Permutation_Importance filename               species_sanitized guild
  &lt;chr&gt;                     &lt;dbl&gt; &lt;chr&gt;                  &lt;chr&gt;             &lt;chr&gt;
1 PC4                        87.9 VI_Amphiprion_allardi… Amphiprion_allar… Host…
2 PC3                         6.1 VI_Amphiprion_allardi… Amphiprion_allar… Host…
3 PC1                         4.9 VI_Amphiprion_allardi… Amphiprion_allar… Host…
4 PC2                         1.1 VI_Amphiprion_allardi… Amphiprion_allar… Host…
5 PC4                        51.4 VI_Amphiprion_bicinct… Amphiprion_bicin… Host…
6 PC2                        45.4 VI_Amphiprion_bicinct… Amphiprion_bicin… Host…</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/variable-importance-comparison-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved variable importance comparison plot to: /Users/chrisrauch/anemonefish_post_analysis/figure_files/variable_importance_comparison_guilds.png 

--- T-tests for difference in Variable Importance between Guilds ---
  Testing variable: PC4 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = 0, df = 46, p-value = 1
alternative hypothesis: true difference in means between group Anemonefish (Env-Only) and group Host Anemones is not equal to 0
95 percent confidence interval:
 -10.55044  10.55044
sample estimates:
mean in group Anemonefish (Env-Only)          mean in group Host Anemones 
                            38.35417                             38.35417 

  Testing variable: PC3 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = 0, df = 46, p-value = 1
alternative hypothesis: true difference in means between group Anemonefish (Env-Only) and group Host Anemones is not equal to 0
95 percent confidence interval:
 -7.316944  7.316944
sample estimates:
mean in group Anemonefish (Env-Only)          mean in group Host Anemones 
                            19.99167                             19.99167 

  Testing variable: PC1 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = 0, df = 46, p-value = 1
alternative hypothesis: true difference in means between group Anemonefish (Env-Only) and group Host Anemones is not equal to 0
95 percent confidence interval:
 -6.223832  6.223832
sample estimates:
mean in group Anemonefish (Env-Only)          mean in group Host Anemones 
                            9.733333                             9.733333 

  Testing variable: PC2 

    Welch Two Sample t-test

data:  Permutation_Importance by guild
t = 0, df = 46, p-value = 1
alternative hypothesis: true difference in means between group Anemonefish (Env-Only) and group Host Anemones is not equal to 0
95 percent confidence interval:
 -10.3235  10.3235
sample estimates:
mean in group Anemonefish (Env-Only)          mean in group Host Anemones 
                            31.92917                             31.92917 </code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>